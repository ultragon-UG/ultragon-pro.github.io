<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Halaman Login</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet"> 
    <style>
        /* Hilangkan highlight biru di HP */
        * {
            -webkit-tap-highlight-color: transparent;
        }

        /* ðŸ”¥ KODE CSS TAMBAHAN UNTUK MENGHILANGKAN SELEKSI DAN MENU KONTEKS ðŸ”¥ */
        body, html, .login-container * {
            -webkit-user-select: none; 
            -moz-user-select: none; 
            -ms-user-select: none; 
            user-select: none; 
            -webkit-touch-callout: none; 
        }
        
        .input-group input, 
        .input-group textarea {
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
        }
        
        .logo-atas, .logo-sub {
            pointer-events: none;
        }
        /* ðŸ”¥ AKHIR KODE PERBAIKAN SELEKSI ðŸ”¥ */

        /* Latar belakang Hitam */
        body, html {
            height: 100%;
            margin: 0;
            font-family: 'Poppins', sans-serif;
            color: white;
            background: #000000; /* Hitam Solid */
        }

        /* Kotak login di tengah */
        .login-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px 30px; 
            border-radius: 10px;
            width: 300px;
            max-width: 90%; 
            text-align: center;
        }

        /* Logo/Gambar Utama */
        .logo-atas {
            display: block;
            margin-left: auto;
            margin-right: auto;
            width: auto; 
            height: auto;
            max-width: 200px; 
            max-height: 200px; 
            margin-bottom: 20px; 
        }

        /* Hapus Logo Sub */
        .logo-sub {
            display: none; 
        }

        /* Text 'Please Log-in To Your Account' */
        .login-title {
            font-family: monospace, sans-serif; 
            font-weight: 400;
            font-size: 14px; 
            color: #ffffff; 
            margin-bottom: 30px; 
            text-align: center;
            letter-spacing: 1px;
            font-style: italic; 
        }
        
        /* Hapus Label Versi */
        .version-label {
            display: none;
        }

        /* Grup input */
        .input-group {
            margin-bottom: 25px;
            text-align: center; 
        }

        .input-group label {
            display: none; 
        }

        .input-group input {
            width: 100%;
            background-color: transparent; 
            padding: 15px;
            border: 1px solid #777; 
            border-radius: 30px; 
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
            font-size: 16px;
            color: white; 
            text-align: center;
            transition: border-color 0.3s ease; /* Transisi untuk warna border */
        }
        
        /* Ganti warna placeholder */
        .input-group input::placeholder {
            color: #aaa;
            opacity: 1; 
        }

        /* Warna border input saat fokus menjadi Merah */
        .input-group input:focus {
            outline: none; 
            border-color: #ff0000; /* Merah */
        }

        /* Tombol Submit */
        .submit-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(90deg, #e0c8ff, #ffffff, #e0c8ff);
            border: none;
            border-radius: 30px; 
            color: #5d00a3; 
            cursor: pointer;
            transition: all 0.3s ease; /* Ganti transition ke 'all' */
            font-family: 'Poppins', sans-serif;
            font-size: 18px;
            font-weight: 700; 
            letter-spacing: 2px;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.5); 
            margin-top: 15px;
        }

        .submit-button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }

        .submit-button:hover:not(:disabled) {
            opacity: 0.8;
        }

        /* Warna Hijau untuk Sukses */
        .submit-button.success {
            background: #2ecc71 !important; /* Hijau */
            color: white; 
            text-shadow: none;
        }

        /* Warna Merah untuk Error */
        .submit-button.error {
            background: #e74c3c !important; /* Merah */
            color: white; 
            text-shadow: none;
        }

        /* CSS Lainnya */
        @keyframes shake {
            0%, 100% {
                transform: translate(-50%, -50%) translateX(0);
            }
            25% {
                transform: translate(-50%, -50%) translateX(-8px);
            }
            75% {
                transform: translate(-50%, -50%) translateX(8px);
            }
        }

        .shake-error {
            animation: shake 0.4s ease-in-out;
        }

        .error-text {
            color: #ff5555; 
            font-size: 14px;
            margin-top: 15px;
            display: none;
            font-weight: 400;
        }
        
        .buy-link, .creator-name, .tabs, .form-content h2 {
            display: none;
        }
        
        /* STYLE KHUSUS MODAL POP-UP (App Status) */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px); 
            z-index: 1000; display: none; justify-content: center; align-items: center; 
            opacity: 0; transition: opacity 0.3s; 
        }
        .modal-overlay.active { display: flex; opacity: 1; }
        .modal-box { 
            background: #191929; padding: 25px; border-radius: 15px; text-align: center; 
            width: 90%; max-width: 320px; border: 2px solid #555; 
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.3); transform: scale(0.9); 
            transition: transform 0.3s; 
        }
        .modal-overlay.active .modal-box { transform: scale(1); }
        .modal-status-title {
            display: flex; align-items: center; justify-content: flex-start; 
            color: #ff5555; /* Default: GAGAL LOGIN (Merah) */
            font-size: 1.6em; font-weight: 900; margin-bottom: 20px;
        }
        .modal-status-title.update-mode { color: #88d3ce; } /* Warna untuk Update */
        .modal-status-title .icon-container { font-size: 1.2em; margin-right: 10px; line-height: 1;}
        .modal-message {
            text-align: left; color: #ccc; margin-bottom: 30px; line-height: 1.4;
            font-family: 'Poppins', sans-serif; font-size: 0.95em;
        }
        .modal-buttons { justify-content: flex-end; display: flex; }
        .modal-buttons button {
            flex: unset; width: 80px; background-color: #ff5555; color: #fff; 
            font-weight: 900; padding: 10px; border: none; border-radius: 8px; cursor: pointer;
            font-family: 'Poppins', sans-serif; transition: transform 0.1s;
        }
        .modal-buttons button.update-ok { background-color: #88d3ce; color: #10101a; }
        .modal-buttons button:active { transform: scale(0.95); }
    </style>
</head>
<body>

    <div class="login-container" id="loginContainer">

        <img src="logoug1.png" alt="Logo" class="logo-atas">
        
        <p class="login-title">Please Log-in To Your Account</p>

        <form id="loginForm" class="form-content">
            <div class="input-group">
                <input type="text" id="loginUser" placeholder="Username" required>
            </div>
            <div class="input-group">
                <input type="password" id="loginPass" placeholder="Password" required>
            </div>

            <button type="submit" class="submit-button">LOGIN</button>
            <p id="loginError" class="error-text"></p>
        </form>

    </div>
    
    <div class="modal-overlay" id="app-status-modal">
        <div class="modal-box">
            <div class="modal-status-title" id="modal-status-title">
                <span class="icon-container" id="modal-icon">ðŸš«</span> 
                <span id="modal-title-text">GAGAL LOGIN</span>
            </div>
            <p class="modal-message" id="modal-message-text">Gagal login karena aplikasi sedang off. Coba lagi nanti!</p>
            <div class="modal-buttons">
                <button id="modal-ok-btn">OK</button>
            </div>
        </div>
    </div>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <script>
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDmg3JbCywbOh__iDMgwbCGG480SzZSaiY",
            authDomain: "ultragon-app.firebaseapp.com",
            databaseURL: "https://ultragon-app-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ultragon-app",
            storageBucket: "ultragon-app.firebasestorage.app",
            messagingSenderId: "119387094211",
            appId: "1:119387094211:web:e43f951de20e793ac9b676"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- COOKIE FUNCTIONS ---
        function setCookie(name, value, days) {
            let expires = "";
            if (days) {
                const date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "")  + expires + "; path=/; SameSite=Strict"; 
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for(let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        function eraseCookie(name) {   
            document.cookie = name+'=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
        }

        // --- FUNGSI POP-UP STATUS BARU ---
        function showAppStatusModal(icon, title, message, color) {
            const modal = document.getElementById('app-status-modal');
            const titleContainer = document.getElementById('modal-status-title');
            const iconEl = document.getElementById('modal-icon');
            const titleTextEl = document.getElementById('modal-title-text');
            const messageEl = document.getElementById('modal-message-text');
            const okBtn = document.getElementById('modal-ok-btn');
            
            if (!modal) return;
            
            iconEl.textContent = icon;
            titleTextEl.textContent = title;
            messageEl.textContent = message;
            
            titleContainer.style.color = color;
            okBtn.style.backgroundColor = color;
            
            if (icon === 'ðŸŒ') {
                 titleContainer.classList.add('update-mode');
                 okBtn.classList.add('update-ok');
            } else {
                 titleContainer.classList.remove('update-mode');
                 okBtn.classList.remove('update-ok');
            }

            modal.classList.add('active');

            const closeModal = () => {
                modal.classList.remove('active');
                okBtn.removeEventListener('click', closeModal);
            };

            okBtn.addEventListener('click', closeModal);
        }

        // --- LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {

            const userUid = getCookie('userUid');
            const sessionId = getCookie('sessionId');
            
            if (userUid && sessionId) {
                if (window.history && window.history.replaceState) {
                    window.history.replaceState(null, null, window.location.href);
                }
                window.location.href = 'index1.html';
                return; 
            }
            
            const loginForm = document.getElementById('loginForm');
            const loginButton = loginForm.querySelector('.submit-button');
            const loginContainer = document.getElementById('loginContainer');
            const loginErrorEl = document.getElementById('loginError');

            loginContainer.addEventListener('animationend', (e) => {
                if (e.animationName === 'shake') {
                    loginContainer.classList.remove('shake-error');
                }
            });

            loginForm.addEventListener('submit', (event) => {
                event.preventDefault();
                
                // Reset status tombol
                loginButton.classList.remove('success', 'error');
                
                loginErrorEl.style.display = 'none';
                const username = document.getElementById('loginUser').value;
                const password = document.getElementById('loginPass').value;

                if (!username || !password) {
                    loginErrorEl.textContent = 'Username dan Password harus diisi!';
                    loginErrorEl.style.display = 'block';
                    loginContainer.classList.add('shake-error');
                    
                    // Gagal: Tombol Merah
                    loginButton.classList.add('error');
                    loginButton.textContent = 'Gagal!';
                    
                    loginButton.disabled = false;
                    setTimeout(() => {
                        loginButton.classList.remove('error');
                        loginButton.textContent = 'LOGIN';
                    }, 1500);
                    return;
                }

                loginButton.disabled = true;
                loginButton.textContent = 'Memeriksa...';

                let userUid;
                let userData;

                db.ref('usernames/' + username).get()
                .then((snapshot) => {
                    if (!snapshot.exists()) throw new Error('Username atau Password salah!');
                    userUid = snapshot.val();
                    return db.ref('users/' + userUid).get();
                })
                .then((userSnapshot) => {
                    if (!userSnapshot.exists()) throw new Error('Data user tidak ditemukan.');
                    userData = userSnapshot.val();
                    if (userData.password !== password) throw new Error('Username atau Password salah!');
                    return db.ref('config/appStatus').get();
                })
                .then((statusSnapshot) => {
                    const appStatus = statusSnapshot.val() || 'ON';
                    
                    // Cek Status Aplikasi/Update (Kecuali untuk role Developer)
                    if (userData.role !== 'Developer') {
                        if (appStatus === 'OFF') {
                            showAppStatusModal('ðŸš«', 'LOGIN FAILED', 'Login failed because the application is currently offline', '#ff5555');
                            throw new Error('Aplikasi sedang non-aktif.');
                        }
                        if (appStatus === 'UPDATE_REQUIRED') {
                            showAppStatusModal('ðŸŒ', 'UPDATE', 'The application is being updated!!', '#88d3ce');
                            throw new Error('Aplikasi sedang update!!');
                        }
                    }

                    if (userData.role !== 'Developer' && userData.role !== 'Owner') {
                        const expiryDate = new Date(userData.expiryDate);
                        if (new Date() >= expiryDate) throw new Error('Akun kamu sudah expired. Silakan hubungi admin.');
                    }

                    const newSessionId = Date.now().toString() + Math.random().toString(36).substring(2);
                    return db.ref('users/' + userUid).update({ currentSessionId: newSessionId }).then(() => newSessionId); 
                })
                .then((newSessionId) => {
                    // BERHASIL: Tombol Hijau
                    loginButton.textContent = 'Login Berhasil!';
                    loginButton.classList.add('success'); 
                    
                    setCookie('userUid', userUid, 365); 
                    setCookie('sessionId', newSessionId, 365); 
                    setTimeout(() => {
                        window.location.href = 'index1.html';
                    }, 1500);
                })
                .catch((error) => {
                    loginButton.disabled = false;
                    loginButton.classList.add('error');
                    loginButton.textContent = 'Gagal!';
                    
                    if (error.message.includes('Aplikasi sedang') || error.message.includes('Aplikasi sedang update')) {
                        // Pop-up sudah ditampilkan oleh showAppStatusModal, hanya perlu cleanup tombol
                        setTimeout(() => {
                            loginButton.classList.remove('error');
                            loginButton.textContent = 'LOGIN';
                        }, 1500);
                    } else {
                        // GAGAL UMUM: Tampilkan error di bawah form
                        loginErrorEl.textContent = error.message;
                        loginErrorEl.style.display = 'block';
                        loginContainer.classList.add('shake-error');
                        
                        setTimeout(() => {
                            loginButton.classList.remove('error');
                            loginButton.textContent = 'LOGIN';
                        }, 1500);
                    }
                });
            });

        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

    <title>ULTRAGON - Dashboard</title>
    <style>
        /* CSS Anda (Gabungan dan Modifikasi) */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Orbitron', monospace; } 

        /* üî• KODE UNTUK MENGHILANGKAN SOROTAN ABU-ABU MAKSIMAL üî• */
        
        * {
            -webkit-user-select: none; /* iOS/Safari */
            -moz-user-select: none; /* Firefox */
            -ms-user-select: none; /* IE/Edge */
            user-select: none; /* Standar */
            -webkit-touch-callout: none; /* iOS (Mencegah menu default saat tekan lama) */
            
            /* üî• MODIFIKASI: Mencegah 'ghost image' saat drag/geser tombol/link üî• */
            -webkit-user-drag: none;
            -moz-user-drag: none;
            -ms-user-drag: none;
            user-drag: none; 
            /* üî• AKHIR MODIFIKASI üî• */
            
            -webkit-tap-highlight-color: transparent !important; 
            -moz-tap-highlight-color: transparent !important;
            -ms-tap-highlight-color: transparent !important;
            -o-tap-highlight-color: transparent !important;
            outline: none !important; 
            box-shadow: none !important;
        }
        
        /* üî• MODIFIKASI BARU: Menghilangkan KOTAK BIRU saat klik/fokus üî• */
        button:focus, a:focus, .nav-item:focus, .icon-button:focus, .submit-btn:focus, .action-btn:focus, .custom-select:focus {
            outline: none !important;
            -webkit-tap-highlight-color: transparent !important;
            box-shadow: none !important;
        }
        *:focus-visible {
             outline: none !important;
             box-shadow: none !important;
        }
        /* üî• AKHIR MODIFIKASI KOTAK BIRU üî• */


        
        /* Khusus untuk INPUT dan TEXTAREA */
        input, textarea {
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
            -webkit-tap-highlight-color: initial !important; 
        }
        
        /* Khusus untuk GAMBAR */
        img {
            pointer-events: none;
        }
        
        /* ----------------------------------------------------------- */
        
        /* üî• MODIFIKASI (Permintaan #4): Mengubah padding-bottom body agar pas 60px */
        body { color: #e0e0e0; background-color: #000000; font-size: 14px; padding-bottom: 60px; } 

        .header { display: flex; align-items: center; justify-content: space-between; padding: 15px; background-color: #191929; border-bottom: 1px solid #2a2a3a; position: sticky; top: 0; z-index: 20; height: 55px; }
        .header-left, .header-right { display: flex; align-items: center; flex: 1; }
        .header-left { justify-content: flex-start; }
        .header-right { justify-content: flex-end; gap: 10px; }
        .header-center { flex: 2; text-align: center; }
        
        /* üî• MODIFIKASI: Mengganti ultragon.png jadi teks ùêîùêãùêìùêëùêÄùêÜùêéùêç üî• */
        .header-title-img { display: none; /* Sembunyikan img asli */ }
        .header-title-text {
            font-family: 'Orbitron', monospace;
            font-weight: 900;
            font-size: 1.8em;
            color: #fff;
            vertical-align: middle;
            height: 35px; 
            line-height: 35px; 
            display: inline-block;
        }
        /* üî• AKHIR MODIFIKASI üî• */
        
        .header-logo { height: 30px; width: auto; }
        .header-btn { background: none; border: none; cursor: pointer; padding: 5px; border-radius: 50%; 
            transition: background-color 0.2s, transform 0.1s;
        }
        .header-btn:active {
             transform: scale(0.95);
             background-color: #2a2a3a;
        }
        .header-btn img, .nav-item img, .icon-button img { width: 24px; height: 24px; filter: invert(30%) sepia(90%) saturate(2000%) hue-rotate(340deg) brightness(100%) contrast(100%); transition: filter 0.3s; }
        .nav-item.active img { filter: invert(30%) sepia(90%) saturate(2000%) hue-rotate(340deg) brightness(120%) contrast(100%); }
        
        main { 
            padding: 20px 15px; 
        }
        
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .content-box { background: rgba(25, 25, 41, 0.8); padding: 25px; border-radius: 15px; text-align: center; width: 100%; border: 1px solid #2a2a3a; margin-bottom: 20px; }
        .content-box h2 { margin-bottom: 20px; color: #88d3ce; }
        
        /* --- START MODIFIKASI NAV BAR (FINAL) --- */
        .nav-bar { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            width: 100%; 
            background: #000000; 
            display: flex; 
            justify-content: space-around; 
            padding: 10px 0; 
            border-top: 1px solid #2a2a3a; 
            z-index: 10; 
            height: 60px;
            flex-wrap: nowrap; 
            overflow-x: hidden; 
        }
        .nav-item { 
            cursor: pointer; 
            text-align: center; 
            color: #ffffff; 
            position: relative;
            flex: 1 1 0; 
            min-width: 0; 
            padding: 0; 
            box-sizing: border-box; 
            transition: background-color 0.2s, transform 0.1s;
        }
        .nav-item:active {
            transform: scale(0.95);
            background-color: transparent !important; 
            -webkit-tap-highlight-color: transparent !important;
        }
        .nav-item:focus {
             outline: none !important;
             background-color: transparent !important;
        }
        /* AKHIR MODIFIKASI NAV BAR */

        .nav-item span { 
            font-size: 0.7em; 
            display: block; 
            white-space: nowrap; 
            overflow: hidden;
            text-overflow: ellipsis; 
            color: #ffffff; 
            filter: brightness(0.6); 
            transition: filter 0.3s, color 0.3s, font-weight 0.3s; 
            padding: 0 1px;
        }
        .nav-item.active span { color: #ffffff; filter: brightness(1); font-weight: bold; }
        .nav-bar .admin-only,
        .nav-bar .owner-only {
            display: none !important; 
        }
        /* --- END MODIFIKASI NAV BAR --- */
        
        .main-banner { 
            position: relative; 
            /* üî• MODIFIKASI (Permintaan #3): Mengubah radius 16px -> 14px */
            border-radius: 14px; 
            overflow: hidden; 
            margin-bottom: 20px; 
            box-shadow: 0 8px 25px rgba(0,0,0,0.3); 
            display: block; 
            width: 100%; 
            margin-left: 0;
            max-width: 100%; 
            box-sizing: border-box;
            border: none; 
        }
        
        /* üî• MODIFIKASI (Permintaan #3): border-radius 14px */
        .main-banner img, .main-banner video { 
            width: 100%; 
            display: block; 
            height: auto; 
            border-radius: 14px; 
            border: 2px solid white !important; 
            box-sizing: border-box;
            position: relative; 
            z-index: 1; 
            background-color: #000000;
        }

        /* üî• MODIFIKASI: Mengganti ultragon.png jadi teks ùêîùêãùêìùêëùêÄùêÜùêéùêç üî• */
        .banner-overlay .banner-logo-img { 
             display: none; /* Sembunyikan img asli */
        }
        .banner-overlay .banner-logo-text { 
            font-family: 'Orbitron', monospace;
            font-weight: 900;
            font-size: 1.8em; /* Samakan dengan header */
            color: #fff;
            display: block; 
            
            /* üî• MODIFIKASI: Menghapus margin -10px agar lurus/rapih üî• */
            margin: 0 0 5px 0; /* Diubah dari margin: 0 0 5px -10px; */
            
            border: none !important; 
            pointer-events: all; 
            mix-blend-mode: lighten; /* Pertahankan blend mode */
            height: 35px; /* Pertahankan tinggi */
            line-height: 35px; /* Vertikal center */
        }
        /* üî• AKHIR PERBAIKAN BANNER */


        #live-announcement {
            position: absolute; 
            top: 15px; 
            left: 50%;
            transform: translateX(-50%);
            z-index: 5; 
            text-align: center; 
            color: #ffeb3b; 
            font-weight: 900; 
            font-size: 0.9em; 
            text-shadow: 0 0 5px #000; 
            background: rgba(0, 0, 0, 0.4); 
            padding: 2px 8px;
            border-radius: 5px;
            width: 90%;
            display: none; 
        }
        
        /* üî• PERBAIKAN BORDER SAITAMA.PNG üî• */
        .banner-overlay { 
            position: absolute; 
            bottom: 2px; 
            left: 2px; 
            transform: none; 
            width: calc(100% - 4px); 
            max-width: 100%; 
            padding: 10px 20px; 
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); 
            z-index: 2; 
            /* üî• MODIFIKASI (Permintaan #3): Mengubah radius 11px -> 12px agar cocok dgn 14px */
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
        }
        /* üî• AKHIR PERBAIKAN BORDER üî• */

        
        .banner-overlay h2 { font-size: 1.5em; color: #fff; }
        
        
        .banner-overlay p { font-size: 0.9em; color: #aaa; }
        
        .icon-nav-grid { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 15px; 
            margin-bottom: 20px; 
        }

        .icon-button .icon-bg { 
            width: 50px; height: 50px; background-color: #191929; border-radius: 50%; display: flex; justify-content: center; align-items: center; 
            border: 2px solid red !important; 
            transition: background-color 0.3s; 
        }
        
        .icon-button { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 8px; 
            text-decoration: none; 
            color: #ccc; 
            transition: transform 0.15s;
        }
        .icon-button:active {
             transform: scale(0.9);
        }
        
        
        .icon-button:hover .icon-bg { background-color: #2a2a3a; }

        .icon-button span {
            font-size: 0.8em;
            text-align: center;
            width: 100%;
        }

        .input-group { text-align: left; margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; color: #a7a9be; }
        
        .content-box input:focus, 
        .content-box select:focus, 
        .input-group input:focus {
            outline: 2px solid #88d3ce !important; 
            border-color: #88d3ce !important; 
            box-shadow: 0 0 5px rgba(136, 211, 206, 0.7) !important;
        }

        .input-group input, .input-group select { 
            width: 100%; padding: 12px; border: 1px solid #2a2a3a; background: #10101a; border-radius: 8px; color: #fff; font-size: 1em; 
            font-family: 'Orbitron', monospace; 
        }
        
        .duration-group { display: flex; gap: 10px; align-items: flex-end; }
        
        .unlimited-mode .input-value, 
        .unlimited-mode .input-unit {
            display: none !important;
        }

        .unlimited-mode .unlimited-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 44px; 
            padding: 12px;
            border: 1px solid #2a2a3a;
            background: #10101a;
            border-radius: 8px;
            color: #88d3ce;
            font-size: 1em;
            font-weight: bold;
        }
        
        .input-group .unlimited-placeholder {
            display: none;
        }


        .duration-group .input-value { flex-grow: 1; } 
        .duration-group .input-unit { width: auto; flex-shrink: 0; } 

        .submit-btn { 
            width: 100%; 
            padding: 12px; 
            border: none; 
            border-radius: 8px; 
            background: #88d3ce; 
            color: #10101a; 
            font-size: 1.1em; 
            font-weight: bold; 
            cursor: pointer; 
            margin-top: 10px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px;
            font-family: 'Orbitron', monospace; 
            transition: background-color 0.2s, transform 0.1s, opacity 0.2s;
        }
        
        .submit-btn:active {
             transform: scale(0.98);
        }
        
        .submit-btn img { 
            display: none;
        }
        
        .submit-btn span {
            font-weight: 900; 
        }

        .submit-btn:disabled {
            background-color: #555;
            color: #999;
            cursor: not-allowed;
            transform: none;
        }

        /* üî• MODIFIKASI: Tombol Kirim Bug üî• */
        #send-bug-btn {
             position: relative;
        }
        #send-bug-btn img { 
            width: 28px; 
            height: 28px; 
            display: inline-block !important; 
            filter: none; 
            pointer-events: none; 
            
            /* üî• MODIFIKASI: Menggeser 24% -> 26% (Permintaan user) */
            position: absolute;
            left: 26%; /* Diubah dari 24% */
            top: 50%;
            transform: translateY(-50%); 
            margin-right: 0;
        }
        #send-bug-btn span {
             /* Teks otomatis center karena <img> position: absolute */
        }
        /* üî• AKHIR MODIFIKASI TOMBOL KIRIM BUG üî• */


        /* Wrapper untuk tombol send-bug untuk menangani event klik saat disabled */
        #send-bug-wrapper {
             width: 100%;
             margin-top: 10px;
        }
        #send-bug-wrapper .submit-btn {
             margin-top: 0;
        }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); z-index: 1000; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s; }
        .modal-overlay.active { display: flex; opacity: 1; }
        .modal-box { background: #191929; padding: 25px; border-radius: 15px; text-align: center; width: 90%; max-width: 350px; border: 1px solid #2a2a3a; transform: scale(0.9); transition: transform 0.3s; }
        .modal-overlay.active .modal-box { transform: scale(1); }
        .modal-box p { margin-bottom: 20px; color: #a7a9be; }
        .modal-buttons { display: flex; gap: 10px; }
        .modal-buttons button { 
            flex: 1; padding: 10px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; 
            font-family: 'Orbitron', monospace; 
            transition: background-color 0.2s, transform 0.1s;
        }
        .modal-buttons button:active {
             transform: scale(0.95);
        }
        
        .profile-info { text-align: left; margin-bottom: 25px; }
        .profile-info p { border-bottom: 1px solid #2a2a3a; padding: 10px 0; color: #fff; display: flex; justify-content: space-between; }
        .profile-info p span { color: #aaa; }
        .status-active { color: #2ecc71 !important; } .status-expired { color: #e74c3c !important; }
        .account-data-table { width: 100%; border-collapse: collapse; margin-top: 20px; table-layout: fixed; }
        .account-data-table th, .account-data-table td { padding: 8px; border: 1px solid #2a2a3a; text-align: left; font-size: 0.9em; word-wrap: break-word; }
        .account-data-table th { background-color: #10101a; }
        .online-status { display: inline-block; width: 10px; height: 10px; background-color: #e74c3c; border-radius: 50%; margin-right: 5px; }
        .online-status.online { background-color: #2ecc71; }
        .action-btn { 
             border: none; padding: 5px 8px; border-radius: 5px; cursor: pointer; color: white; margin: 2px 0; display: inline-block; width: 100%; 
             transition: background-color 0.2s, transform 0.1s;
        }
        .action-btn:active {
             transform: scale(0.95);
        }
        .action-btn:disabled {
             opacity: 0.6;
             transform: none;
             cursor: not-allowed;
        }
        .delete-btn { background-color: #c0392b; }
        .edit-btn { background-color: #3498db; }
        .renew-account-btn { background-color: #3498db; }
        .frozen-overlay { width: 100%; height: 100vh; display: flex; justify-content: center; align-items: center; text-align: center; flex-direction: column; position: fixed; top: 0; left: 0; background: rgba(0,0,0,0.8); z-index: 9999; }
        
        /* --- START MODIFIKASI: NOTIFIKASI SAVE --- */
        #notification-container {
             position: fixed;
             top: 60px; /* Di bawah header */
             right: 15px;
             z-index: 9999;
             width: 90%;
             max-width: 350px;
             pointer-events: none;
             display: block !important; /* Pastikan terlihat */
        }
        .notification {
            background: #27ae60; /* Hijau sukses */
            color: white;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-family: 'Poppins', sans-serif;
            font-size: 0.9em;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            animation: slideIn 0.5s forwards; /* Pakai keyframes user */
            opacity: 1; /* Mulai dari opacity 1 setelah slideIn */
        }
        .notification.error {
            background: #c0392b; /* Merah error */
        }
        .notification.info {
            background: #3498db; /* Biru info */
        }
        
        /* üî• PERMINTAAN MUSIK: Notifikasi khusus untuk musik üî• */
        .notification.music {
            background: #191929; /* Warna gelap agar emoji üî•üî• terlihat */
            border: 1px solid #88d3ce;
        }
        /* --- END MODIFIKASI: NOTIFIKASI SAVE --- */
        
        @keyframes slideIn { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
        @keyframes slideOut { to { opacity: 0; transform: translateX(100%); } }
        .subscription-status { background: #10101a; border-radius: 8px; padding: 15px; margin-bottom: 20px; text-align: left; border: 1px solid #2a2a3a;}
        .owner-controls { margin-top: 20px; border-top: 1px solid #2a2a3a; padding-top: 20px; }
        .control-buttons { display: flex; gap: 10px; }
        .control-buttons button { 
            flex: 1; padding: 10px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; 
            font-family: 'Orbitron', monospace; 
        }
        .apk-on-btn { background-color: #2ecc71; color: white; }
        .apk-off-btn { background-color: #e74c3c; color: white; }
        .message-inbox { max-height: 400px; overflow-y: auto; text-align: left; }
        .message-item { background: #10101a; border: 1px solid #2a2a3a; border-radius: 10px; padding: 15px; margin-bottom: 15px; }
        .message-item p { margin-bottom: 10px; word-wrap: break-word; }
        .message-item b { color: #88d3ce; }
        .message-actions { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 15px; }
        .message-actions button { 
            width: 100%; padding: 8px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; 
            font-family: 'Orbitron', monospace; 
        }
        
        /* üî• CSS UNTUK TAB INBOX & DATA (Permintaan #6) üî• */
        .inbox-tabs {
            display: flex;
            flex-wrap: wrap; /* Biar bisa ke bawah kalo ga muat */
            gap: 8px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #2a2a3a;
        }
        /* Style untuk tombol filter data page (menggunakan style yg sama) */
        #data-page .inbox-tabs {
             border-bottom: none; 
             padding-bottom: 0; 
        }
        
        .inbox-tab-btn {
            background-color: #10101a;
            border: 1px solid #2a2a3a;
            color: #a7a9be;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Orbitron', monospace;
            font-size: 0.9em;
            transition: background-color 0.2s, color 0.2s, transform 0.1s;
        }
        .inbox-tab-btn:active {
            transform: scale(0.95);
        }
        .inbox-tab-btn.active {
            background-color: #88d3ce;
            color: #10101a;
            font-weight: bold;
            border-color: #88d3ce;
        }
        /* üî• AKHIR CSS TAB INBOX & DATA üî• */

        .accept-btn { background-color: #27ae60; color: white; }
        .telegram-btn { background-color: #3498db; color: white; }
        .reject-btn { background-color: #c0392b; color: white; }
        .conversation-list-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #2a2a3a; cursor: pointer; position: relative; }
        .conversation-list-item:hover { background-color: #10101a; }
        
        .delete-chat-btn {
            position: absolute;
            right: 15px;
            background: none;
            border: none;
            color: #c0392b;
            font-size: 1.2em;
            cursor: pointer;
            padding: 5px;
            z-index: 5;
            opacity: 0.7;
            transition: opacity 0.2s, transform 0.1s;
        }
        .delete-chat-btn:hover {
            color: #e74c3c;
            opacity: 1;
        }
        .delete-chat-btn:active {
             transform: scale(0.9);
        }

        .conversation-info { text-align: left; flex-grow: 1; margin-right: 10px; }
        .conversation-info .username { font-weight: bold; color: #fff; }
        .conversation-info .last-message { font-size: 0.9em; color: #aaa; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #chat-window-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        #message-container { height: calc(100vh - 300px); overflow-y: auto; display: flex; flex-direction: column; padding: 10px; border: 1px solid #2a2a3a; border-radius: 8px; background-color: #10101a; margin-bottom: 10px;}
        .message-bubble { max-width: 70%; padding: 10px 15px; border-radius: 18px; margin-bottom: 10px; word-wrap: break-word; position: relative; }
        .message-bubble .timestamp { font-size: 0.7em; color: #bbb; display: block; margin-top: 5px; text-align: right; }
        .sent { background-color: #3498db; color: white; align-self: flex-end; }
        .received { background-color: #2c3e50; color: white; align-self: flex-start; }
        .delete-msg-btn { position: absolute; top: 2px; left: -25px; background: none; border: none; color: #999; cursor: pointer; font-size: 1.2em; padding: 0; line-height: 1; opacity: 0; transition: opacity 0.2s; } 
        .message-bubble.sent:hover .delete-msg-btn { opacity: 1; }
        .delete-msg-btn:hover { color: #ff4d4d; }
        .delete-msg-btn:active { transform: scale(0.9); }
        #message-form { display: flex; margin-top: 10px; gap: 10px; }
        #message-input { flex-grow: 1; }
        #user-search-results { max-height: 200px; overflow-y: auto; margin-top: 15px; border: 1px solid #2a2a3a; border-radius: 8px;}
        .search-result-item { padding: 12px; text-align: left; border-bottom: 1px solid #2a2a3a; cursor: pointer; }
        .search-result-item:hover { background-color: #2a2a3a; }
        .search-result-item:last-child { border-bottom: none; }

        .stats-panel {
            background: linear-gradient(-45deg, #600000, #a00000, #3d0000, #500000);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            border-radius: 12px;
            padding: 0;
            margin-top: 0px; 
            border: 1px solid rgba(255, 100, 100, 0.2);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            font-size: 14px;
            color: #ffffff;
            overflow: hidden;
            width: 100%;
            margin-left: 0; 
            box-sizing: border-box;
            margin-bottom: 0px; 
        }
        .stats-header { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            padding: 15px; 
            background-color: #b8860b; 
            font-weight: bold; 
            font-size: 1.4em; 
            letter-spacing: 0.5px;
        }
        .stats-header span { 
            color: #ffffff; 
            line-height: 1; 
        }
        .stats-header img { 
            width: 30px; 
            height: 30px; 
            display: block; 
            filter: none; 
            flex-shrink: 0; 
        }
        .stats-content { padding: 0 15px 5px 15px; }
        .stats-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; }
        .stats-row + .stats-row { border-top: 1px solid gold; }
        .stats-row .label { display: flex; align-items: center; gap: 10px; color: #ffcccc; }
        .stats-row .label img { 
            width: 25px; 
            height: 25px; 
            display: block; 
            filter: none; 
        }
        .stats-row .value { font-weight: normal; color: #ffffff; text-align: right; font-family: 'Orbitron', monospace; font-size: 1em; } 

        .telegram-custom-banner {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(-45deg, #600000, #a00000, #3d0000, #500000);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            border-radius: 12px;
            padding: 10px 15px; 
            width: 100%;
            margin-left: 0;
            box-sizing: border-box;
            border: 1px solid rgba(255, 100, 100, 0.2);
            box-shadow: 0 4px 10px rgba(0,0,0,0.25);
            text-decoration: none;
            color: #ffffff;
            font-size: 14px;
            cursor: pointer;
            height: 65px; 
            margin-bottom: 20px; 
            transition: transform 0.1s;
        }
        .telegram-custom-banner:active {
             transform: scale(0.98);
        }
        
        .telegram-custom-banner .banner-content { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            flex-grow: 1; 
        }
        
        .telegram-custom-banner .banner-icon-img { 
            width: 45px; 
            height: 45px; 
            flex-shrink: 0; 
            display: block; 
            margin-left: -5px; 
            object-fit: contain; 
        }
        .telegram-custom-banner .banner-text { 
            flex-grow: 1; 
            margin-right: 0px; 
            font-weight: bold; 
            line-height: 1.1; 
            text-align: left; 
            font-family: 'Press Start 2P', cursive; 
            font-size: 0.9em; 
            letter-spacing: -0.5px; 
            min-width: 0; 
        }
        .telegram-custom-banner .banner-text span { 
            display: block; 
            font-size: 1em; 
        }

        .telegram-custom-banner .arrow-icon { font-size: 1.5em; color: #ffffff; flex-shrink: 0; }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .banner-settings-section {
             margin-top: 20px;
             border-top: 1px solid #2a2a3a;
             padding-top: 20px;
             text-align: left; 
        }
        .banner-settings-section label {
             display: block;
             margin-bottom: 5px;
             color: #a7a9be;
        }
        .banner-settings-section .input-group {
             margin-bottom: 10px; 
        }
        .banner-settings-section .submit-btn {
             margin-top: 5px; 
        }

        .input-group select {
            appearance: none; 
            -webkit-appearance: none; 
            -moz-appearance: none; 
            background-color: #10101a; 
            background-image: url('data:image/svg+xml;utf8,<svg fill="white" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>'); 
            background-repeat: no-repeat;
            background-position: right 10px center; 
            background-size: 20px; 
            padding-right: 40px; 
        }

        select::-moz-focus-inner {
            border: 0;
        }
        select::-ms-expand {
            display: none;
        }

        #home-page {
        }
        
        .custom-select-wrapper {
            position: relative;
            display: block; 
            text-align: left;
        }

        .custom-select {
            position: relative;
            width: 100%;
            padding: 12px;
            border: 1px solid #2a2a3a;
            background: #10101a;
            border-radius: 8px;
            color: #fff;
            font-size: 1em;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Orbitron', monospace;
            z-index: 1;
            outline: none !important; 
            -webkit-tap-highlight-color: transparent !important; 
            user-select: none; 
            transition: background-color 0.2s, border-color 0.2s;
        }
        .custom-select:active {
             border-color: #88d3ce;
        }


        .custom-select-arrow {
            font-size: 1.2em;
            color: #88d3ce; 
            transition: transform 0.3s;
        }
        .custom-select.open .custom-select-arrow {
            transform: rotate(180deg);
        }

        .select-options {
            position: absolute;
            top: 100%; 
            left: 0;
            right: 0;
            background: #191929; 
            border: 1px solid #2a2a3a;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            display: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }

        .select-option-item {
            padding: 12px;
            cursor: pointer;
            color: #a7a9be;
            transition: background-color 0.2s, color 0.2s;
            font-family: 'Orbitron', monospace;
            -webkit-tap-highlight-color: transparent !important; 
            user-select: none;
        }

        .select-option-item:hover,
        .select-option-item.selected {
            background-color: #2a2a3a;
            color: #88d3ce; 
        }
        
        .select-option-item.disabled-mode {
            color: #555; 
            background-color: #10101a; 
            cursor: not-allowed; 
            opacity: 0.7;
        }

        .select-option-item.disabled-mode:hover {
            background-color: #10101a; 
            color: #555; 
        }

        .hidden-select {
            display: none !important;
        }
        
        .floating-cs-button {
            position: fixed;
            right: 20px; 
            bottom: 80px; 
            z-index: 1000; 
            background-color: #4CAF50; 
            padding: 10px;
            border-radius: 50%; 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4); 
            transition: background-color 0.3s, transform 0.3s;
            text-decoration: none;
            width: 60px;
            height: 60px;
            display: flex; 
            align-items: center;
            justify-content: center;
        }

        .floating-cs-button img {
            width: 100%; 
            height: 100%;
            object-fit: contain; 
            border-radius: 50%; 
            filter: invert(100%); 
        }

        .floating-cs-button:hover {
            background-color: #45a049; 
            transform: scale(1.05); 
        }
        
        .floating-cs-button:active {
            transform: scale(0.95);
        }
        
        /* STYLE KHUSUS MODAL BUG UMUM */
        #bug-success-modal .modal-box,
        #cooldown-modal .modal-box { 
            max-width: 320px;
            background-color: #111; 
            border: 2px solid #555; 
            box-shadow: 0 0 20px rgba(136, 211, 206, 0.3); 
        }
        
        #bug-success-modal .bug-status-title,
        #cooldown-modal .cooldown-status-title {
            display: flex;
            align-items: center;
            justify-content: flex-start; 
            color: #88d3ce; 
            font-size: 1.6em; 
            font-weight: 900;
            margin-bottom: 20px;
        }
        
        /* Ikon Centang (Success) dan Jam Pasir (Cooldown) */
        #bug-success-modal .bug-status-title .icon-container,
        #cooldown-modal .cooldown-status-title .icon-container {
             font-size: 1.2em; 
             margin-right: 10px;
             line-height: 1;
        }

        /* Style untuk teks Judul */
        #bug-success-modal .bug-status-title span,
        #cooldown-modal .cooldown-status-title span {
            font-family: 'Orbitron', monospace;
            text-shadow: 0 0 5px rgba(136, 211, 206, 0.7); 
        }
        
        #bug-success-modal .bug-message,
        #cooldown-modal .cooldown-message {
            text-align: left;
            color: #ccc;
            margin-bottom: 30px; 
            line-height: 1.4;
            font-family: 'Poppins', sans-serif; 
            font-size: 0.95em;
        }

        #bug-success-modal .modal-buttons,
        #cooldown-modal .modal-buttons {
            justify-content: flex-end; 
        }

        #bug-success-modal .modal-buttons button,
        #cooldown-modal .modal-buttons button {
            flex: unset; 
            width: 80px; 
            background-color: #88d3ce;
            color: #10101a;
            font-weight: 900;
        }
        
        /* Style untuk Status Update */
        .status-update {
            color: #00bcd4 !important; 
        }

        /* --- START MODIFIKASI: CSS UNTUK MENU & PROFIL POP-UP --- */
        
        /* Overlay untuk kedua pop-up */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 1100; /* Di atas segalanya kecuali modal lain */
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .popup-overlay.active {
            display: block;
            opacity: 1;
        }
        
        /* 1. Pop-up Menu (Garis Tiga) */
        .menu-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 75%; /* Lebar "setengah aplikasi kurang sedikit" */
            max-width: 300px; /* Lebar maksimum */
            height: 100%;
            background: #10101a; /* Warna gelap */
            border-right: 1px solid #2a2a3a;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            z-index: 1101;
            transform: translateX(-100%);
            transition: transform 0.3s ease-out;
            padding: 20px;
            padding-top: 60px; /* Jarak dari atas */
        }
        .menu-popup.active {
            transform: translateX(0);
        }
        
        /* üî• PERMINTAAN SIDEBAR: Mengganti H3 ULTRAGON jadi Gambar (LAMA) üî• */
        .menu-popup h3 {
            /* Sembunyikan H3 yang lama */
            display: none; 
        }
        
        /* üî• MODIFIKASI: Mengganti ultragon.png jadi teks ùêîùêãùêìùêëùêÄùêÜùêéùêç üî• */
        .menu-popup .menu-popup-logo {
             display: none; /* Sembunyikan img asli */
        }
        .menu-popup .menu-popup-logo-text {
            /* Style untuk teks ùêîùêãùêìùêëùêÄùêÜùêéùêç di sidebar */
            font-family: 'Orbitron', monospace;
            font-weight: 900;
            font-size: 2.2em; /* Lebih besar untuk sidebar */
            color: #fff;
            text-align: center;
            margin-bottom: 15px;
            display: block;
        }
        /* üî• AKHIR PERBAIKAN SIDEBAR (MODIFIKASI) üî• */

        .menu-popup p {
            color: #aaa;
            font-size: 1em;
            margin-bottom: 20px;
        }

        /* 2. Pop-up Profil (Ikon Profil) */
        .profile-popup {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #191929; /* Warna header */
            border-top: 1px solid #2a2a3a;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.4);
            z-index: 1101;
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            padding: 25px;
        }
        .profile-popup.active {
            transform: translateY(0);
        }
        /* Menggunakan style .subscription-status yang sudah ada untuk info */
        .profile-popup .subscription-status {
            margin-bottom: 15px;
            background: none; /* Hilangkan background .subscription-status */
            border: none; /* Hilangkan border .subscription-status */
            padding: 0;
        }
        .profile-popup .subscription-status p {
            padding: 8px 0;
        }
        /* Tombol logout di dalam pop-up profil */
        #profile-popup-logout-btn {
            width:100%; 
            padding:12px; 
            border:none; 
            border-radius:8px; 
            background:#c0392b; 
            color:white; 
            font-weight:bold;
            font-family: 'Orbitron', monospace;
            font-size: 1.1em;
        }
        /* --- END MODIFIKASI: CSS UNTUK MENU & PROFIL POP-UP --- */
        
        /* --- üî• MODIFIKASI BARU: CSS UNTUK TOMBOL LOCK AKUN DEV üî• --- */
        .developer-lock-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #2a2a3a;
        }
        .developer-lock-section p {
            color: #a7a9be;
            font-size: 0.9em;
            margin-bottom: 10px;
            line-height: 1.4;
        }
        .developer-lock-section button {
             width: 100%;
             padding: 12px;
             border: none;
             border-radius: 8px;
             font-weight: bold;
             cursor: pointer;
             font-family: 'Orbitron', monospace;
             font-size: 1.1em;
             transition: background-color 0.2s, transform 0.1s;
        }
        .developer-lock-section button:active {
             transform: scale(0.98);
        }
        .developer-lock-section button.lock-on {
             background-color: #2ecc71; /* Hijau */
             color: white;
        }
        .developer-lock-section button.lock-off {
             background-color: #e74c3c; /* Merah */
             color: white;
        }
        /* --- üî• AKHIR MODIFIKASI üî• --- */

    </style>
</head>
<body>
    
    <div id="app-wrapper">
        <div id="notification-container"></div>
        <div class="header">
            <div class="header-left">
                <button class="header-btn" id="header-menu-btn">
                    <img src="tandatiga.png" alt="Menu">
                </button>
            </div>
            <div class="header-center">
                <span class="header-title-text">ùêîùêãùêìùêëùêÄùêÜùêéùêç</span>
            </div >
            <div class="header-right">
                <img src="logoug.png" alt="Logo ULTRAGON" class="header-logo">
                <button class="header-btn" id="header-profile-btn">
                    <img src="profil.png" alt="Profile">
                </button>
            </div>
        </div>
        <main>
            <div id="home-page" class="page">
                <div class="main-banner">
                    <div id="live-announcement" style="position: absolute; top: 15px; left: 50%; transform: translateX(-50%); z-index: 5; text-align: center; color: #ffeb3b; font-weight: 900; font-size: 0.9em; text-shadow: 0 0 5px #000; background: rgba(0, 0, 0, 0.4); padding: 2px 8px; border-radius: 5px; width: 90%; display: none;"></div>

                    <img src="saitama.png" alt="Main Banner">
                    <div class="banner-overlay">
                        <span class="banner-logo-text">ùêîùêãùêìùêëùêÄùêÜùêéùêç</span>
                        <p>Welcome, <span id="welcome-username">User</span>!</p>
                    </div>
                </div>
                <div class="icon-nav-grid">
                    <a href="#" class="icon-button" data-page="admin-page">
                        <div class="icon-bg"><img src="tambah.png" alt="Create Account"></div>
                        <span>Create Account</span>
                    </a>
                    <a href="#" class="icon-button" data-page="data-page">
                        <div class="icon-bg"><img src="data.png" alt="Data"></div>
                        <span>Data</span>
                    </a>
                    <a href="#" class="icon-button" data-page="messages-page">
                        <div class="icon-bg"><img src="inbox.png" alt="Admin Inbox"></div>
                        <span>Admin Inbox</span>
                    </a>
                    
                    <a href="#" class="icon-button" id="music-toggle-btn">
                        <div class="icon-bg"><img src="music.png" alt="Music"></div>
                        <span>Music</span>
                    </a>
                    <a href="#" class="icon-button" data-page="chat-list-page">
                        <div class="icon-bg"><img src="pesan.png" alt="Messages"></div>
                        <span>Messages</span>
                    </a>
                    <a href="#" class="icon-button" data-page="sender-page">
                        <div class="icon-bg"><img src="kumbang1.png" alt="Bug"></div>
                        <span>Bug</span>
                    </a>
                    <a href="#" class="icon-button" data-page="settings-page">
                        <div class="icon-bg"><img src="pengaturan.png" alt="Settings"></div>
                        <span>Settings</span>
                    </a>
                </div>

                
                    <a href="https://t.me/ultragonpro" id="telegram-banner-link" target="_blank" class="telegram-custom-banner">
                        <div class="banner-content">
                            <img src="orang.png" alt="People Icon" class="banner-icon-img">
                            <span class="banner-text">
                                <span id="banner-text-line1">üî• Telegram Channel: Join To Get</span>
                                <span id="banner-text-line2">More Info!</span>
                            </span>
                        </div>
                        <span class="arrow-icon">‚ü©</span>
                    </a>
                
                    <div class="stats-panel">
                        <div class="stats-header">
                            <img src="stats.png" alt="Stats Icon"> <span>Server Stats</span>
                        </div>
                        <div class="stats-content">
                            <div class="stats-row">
                                <span class="label">
                                    <img src="onlineusers.png" alt="Users Icon"> <span>Online Users</span>
                                </span>
                                <span class="value" id="online-users-stat">0</span>
                            </div>
                            <div class="stats-row">
                                <span class="label">
                                    <img src="activesender.png" alt="Sender Icon"> <span>Active Senders</span>
                                </span>
                                <span class="value" id="active-sender-stat">0</span>
                            </div>
                        </div>
                    </div>
                

            </div>

            <div id="data-page" class="page">
                 <div class="content-box">
                    <h2>Account Data Dashboard</h2>
                    
                    <div class="inbox-tabs" id="data-page-filters" style="border-bottom: 1px solid #2a2a3a; padding-bottom: 10px;">
                        <button class="inbox-tab-btn active" data-filter="ALL">ALL</button>
                        <button class="inbox-tab-btn" data-filter="EXPIRED">EXPIRED</button>
                    </div>
                    
                    <div class="input-group" style="margin-top: 15px;">
                        <input type="search" id="search-account-input" placeholder="Search username...">
                    </div>
                    
                    <button class="submit-btn delete-btn" id="delete-all-expired-btn" style="display: none; margin-bottom: 15px;">DELETE ALL ACCOUNT</button>
                    
                    <p>Total Accounts: <b id="total-accounts-data">0</b></p>
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table class="account-data-table">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Password</th>
                                    <th>Role</th>
                                    <th style="width:25%; min-width: 100px;">Action</th> <th style="width:25%; min-width: 100px;">Extend</th>
                                </tr>
                            </thead>
                            <tbody id="account-list-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="sender-page" class="page">
                 <div class="content-box">

                    <div class="main-banner"> 
                        <video src="saitama1.mp4" autoplay muted loop playsinline poster="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=">
                            Browser kamu tidak support video.
                        </video>
                        </div>
                    <h2>WhatsApp Bug</h2>
                     <div id="prefix-settings" style="display: none; border-bottom: 1px solid #2a2a3a; padding-bottom: 15px; margin-bottom: 15px;">
                        <h4>Prefix Settings (Developer Only)</h4>
                        <div class="input-group"><label>Prefix Invisible Delay (Mode: delay)</label><input id="delay-prefix-input"></div>
                        <div class="input-group"><label>Prefix Andro Crash (Mode: bug)</label><input id="bug-prefix-input"></div>
                        <div class="input-group"><label>Prefix Invisible Delay V2 (Mode: delayV2)</label><input id="delayV2-prefix-input"></div>
                        <div class="input-group"><label>Prefix Ultra Killer (Mode: ultra)</label><input id="ultra-prefix-input"></div>
                        <div class="input-group"><label>Prefix Dark Killer (Mode: dark)</label><input id="dark-prefix-input"></div>
                        <div class="input-group"><label>Prefix Ultimate ZX (Mode: zx)</label><input id="zx-prefix-input"></div>
                        <button class="submit-btn" id="save-prefix-btn" style="background-color:#3498db">Save All Prefix Settings</button>
                    </div>
                    
                    <form id="wa-form">
                        
                        <div class="input-group">
                            <label for="target-number">Target Number</label>
                            <input type="number" id="target-number" placeholder="628xxxxxxxxxx" required>
                        </div>
                        
                        <div class="input-group custom-select-wrapper" id="bug-mode-wrapper" style="margin-top: 5px;">
                            <label for="bug-mode-select">Select Bug Mode</label>
                            <select id="bug-mode-select" class="hidden-select" required></select>
                        </div>
                        
                        <div id="send-bug-wrapper">
                            <button type="button" id="send-bug-btn" class="submit-btn">
                                <img src="kirim.png" alt="Send">
                                <span>SEND BUG</span>
                            </button>
                        </div>
                        
                        <p id="cooldown-timer" style="margin-top:10px; color: #ff9e9e; font-weight: bold;"></p>

                    </form>
                </div>
            </div>

            <div id="admin-page" class="page">
                <div class="content-box">
                    <h2>ADMIN PANEL: Create Account</h2>
                    <form id="create-account-form">
                        <div class="input-group custom-select-wrapper" id="new-role-wrapper">
                            <label for="new-role">Select Role</label>
                            <select id="new-role" required class="hidden-select"></select>
                        </div>
                        <div class="input-group"><label for="new-username">New Username</label><input type="text" id="new-username" required></div>
                        <div class="input-group"><label for="new-password">New Password</label><input type="text" id="new-password" required></div>
                        
                        <div class="input-group duration-group-wrapper" id="duration-group-wrapper">
                             <label>Duration</label>
                             <div class="duration-group">
                                <input type="number" id="new-duration-value" placeholder="e.g., 30" class="input-value" required>
                                
                                <div class="custom-select-wrapper" id="new-duration-unit-wrapper" style="width: auto; flex-shrink: 0;">
                                    <select id="new-duration-unit" class="input-unit hidden-select" required>
                                        <option value="days">Days</option>
                                        <option value="months">Months</option>
                                        <option value="years">Years</option>
                                    </select>
                                </div>
                                
                                <div class="unlimited-placeholder">‚àû UNLIMITED</div>
                             </div>
                             
                             <div class="custom-select-wrapper" id="duration-mode-select-wrapper">
                                 <select id="duration-mode-select" class="input-unit hidden-select" style="margin-top: 10px; width: 100%;">
                                     <option value="time">Set Time</option>
                                     <option value="unlimited">Unlimited</option>
                                 </select>
                             </div>

                        </div>
                        <button type="button" id="create-account-btn" class="submit-btn">Create Account</button>
                    </form>
                </div>
            </div>
            <div id="settings-page" class="page">
                 <div class="content-box">
                    <h2>Account Settings</h2>
                    <div class="subscription-status">
                        <p>Username: <span id="settings-username" style="color:white;"></span></p>
                        <p>Role: <span id="settings-role" style="color:white;"></span></p><hr style="border-color:#2a2a3a; margin:10px 0;">
                        <p>Purchase Date: <span id="purchase-date"></span></p>
                        <p>Expires On: <span id="expiry-date"></span></p>
                        <p>Application Status: <span id="app-status-display"></span></p>
                        <a href="#" id="renew-link" class="action-btn renew-account-btn" style="display:block; text-decoration:none; margin-top:10px;">Request Extension</a>
                    </div>
                    
                    <div id="developer-lock-container"></div>
                    
                    <button id="logout-btn" style="width:100%; padding:12px; border:none; border-radius:8px; background:#c0392b; color:white; font-weight:bold;">Logout</button>

                    <div id="owner-controls-container"></div>

                </div>
            </div>
           
            <div id="messages-page" class="page">
                <div class="content-box">
                    <h2>Admin Inbox</h2>

                    <label style="text-align: left; display: block; margin-bottom: 5px; color: #a7a9be;">Filter by Role:</label>
                    <div class="inbox-tabs" id="inbox-role-filters">
                        <button class="inbox-tab-btn active" data-filter-type="role" data-filter-value="ALL">ALL</button>
                        <button class="inbox-tab-btn" data-filter-type="role" data-filter-value="Developer">Developer</button>
                        <button class="inbox-tab-btn" data-filter-type="role" data-filter-value="Owner">Owner</button>
                        <button class="inbox-tab-btn" data-filter-type="role" data-filter-value="Reseller">Reseller</button>
                        <button class="inbox-tab-btn" data-filter-type="role" data-filter-value="VIP">VIP</button>
                        <button class="inbox-tab-btn" data-filter-type="role" data-filter-value="Member">Member</button>
                    </div>
                    
                    <label style="text-align: left; display: block; margin-top: 10px; margin-bottom: 5px; color: #a7a9be;">Filter by Mode:</label>
                    <div class="inbox-tabs" id="inbox-mode-filters">
                        <button class="inbox-tab-btn active" data-filter-type="mode" data-filter-value="ALL">ALL</button>
                        <button class="inbox-tab-btn" data-filter-type="mode" data-filter-value="delay">Invisible Delay</button>
                        <button class="inbox-tab-btn" data-filter-type="mode" data-filter-value="bug">Andro Crash</button>
                        <button class="inbox-tab-btn" data-filter-type="mode" data-filter-value="delayV2">Invisible Delay V2</button>
                        <button class="inbox-tab-btn" data-filter-type="mode" data-filter-value="ultra">Ultra Killer</button>
                        <button class="inbox-tab-btn" data-filter-type="mode" data-filter-value="dark">Dark Killer</button>
                        <button class="inbox-tab-btn" data-filter-type="mode" data-filter-value="zx">Ultimate ZX</button>
                    </div>

                    <div class="input-group" style="margin-top: 20px;">
                        <label>Your WA Number (to reply)</label>
                        <input type="number" id="admin-wa-number" placeholder="62...">
                    </div>
                    <div class="input-group">
                        <label>Your Telegram Username/ID (to reply)</label>
                        <input type="text" id="admin-tg-id" placeholder="@username or 12345678">
                    </div>
                     <div id="message-inbox-container" class="message-inbox"></div>
                </div>
            </div>
            <div id="chat-list-page" class="page">
                 <div class="content-box">
                    <h2>Messages</h2>
                    <button id="start-new-chat-btn" class="submit-btn" style="margin-bottom: 20px; background-color: #27ae60;">Start New Chat</button>
                    <div id="conversation-list" style="max-height: 400px; overflow-y: auto;"></div>
                </div>
            </div>

            <div id="chat-window-page" class="page">
                <div class="content-box">
                    <div id="chat-window-header">
                        <button id="back-to-chat-list-btn" class="action-btn" style="width:auto;background-color:#555;">Back</button>
                        <h3 id="chat-partner-username"></h3>
                        
                        <button id="delete-chat-history-btn" class="action-btn" style="width:auto;background-color:#c0392b; flex-shrink: 0; padding: 5px 10px;">
                            Delete History
                        </button>
                        
                    </div>
                    <div id="message-container" style="position: relative;"></div>
                    <form id="message-form">
                        <input type="text" id="message-input" placeholder="Type message..." required>
                        <button type="submit" class="submit-btn" style="width:auto;margin-top:0;">Send</button>
                    </form>
                </div>
            </div>

        </main>
        
                <div class="modal-overlay" id="edit-account-modal">
        <div class="modal-box">
            <h3 id="edit-title" style="color: #88d3ce; margin-bottom: 20px;">Edit Account: <span id="edit-username-title"></span></h3>
            <form id="edit-account-form">
                <input type="hidden" id="edit-account-uid">
                <div class="input-group"><label for="edit-username">Username</label><input type="text" id="edit-username" required></div>
                <div class="input-group"><label for="edit-password">Password</label><input type="text" id="edit-password" required></div>
                <div class="input-group custom-select-wrapper" id="edit-role-wrapper">
                    <label for="edit-role">Role</label>
                    <select id="edit-role" required class="hidden-select"></select>
                </div>
                
                <div class="input-group duration-group-wrapper" id="edit-duration-group-wrapper">
                     <label>Duration / Expiry</label>
                     <div class="duration-group">
                        <input type="number" id="edit-duration-value" placeholder="e.g., 30" class="input-value">
                        
                        <div class="custom-select-wrapper" id="edit-duration-unit-wrapper" style="width: auto; flex-shrink: 0;">
                            <select id="edit-duration-unit" class="input-unit hidden-select">
                                <option value="days">Days</option>
                                <option value="months">Months</option>
                                <option value="years">Years</option>
                            </select>
                        </div>
                        
                        <div class="unlimited-placeholder">‚àû UNLIMITED</div>
                     </div>
                     
                     <div class="custom-select-wrapper" id="edit-duration-mode-select-wrapper">
                         <select id="edit-duration-mode-select" class="input-unit hidden-select" style="margin-top: 10px; width: 100%;">
                             <option value="keep">Keep Existing Expiry</option>
                             <option value="time">Set Time (Add/Set)</option>
                             <option value="unlimited">Unlimited</option>
                         </select>
                     </div>
                     
                     <p id="current-expiry-display" style="font-size:0.8em; margin-top:5px; color:#aaa;"></p>
                </div>
                <button type="button" id="save-edit-btn" class="submit-btn" style="background-color: #27ae60;">Save Changes</button>
                <button type="button" id="close-edit-modal-btn" class="submit-btn" style="background-color: #555; margin-top: 5px;">Cancel</button>
            </form>
        </div>
    </div>
    
    <div class="modal-overlay" id="bug-success-modal">
        <div class="modal-box">
            <div class="bug-status-title">
                <span class="icon-container">‚úÖ</span> 
                <span>Berhasil</span>
            </div>
            <p class="bug-message" id="bug-success-message">Bug berhasil dikirim ke 628xxxxxxxxxx.</p>
            <div class="modal-buttons">
                <button id="bug-success-ok-btn">OK</button>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="cooldown-modal">
        <div class="modal-box">
            <div class="cooldown-status-title">
                <span class="icon-container">‚è≥</span> 
                <span>COOLDOWN</span>
            </div>
            <p class="cooldown-message" id="cooldown-message-text">Silahkan tunggu selama [WAKTU] untuk bisa melanjutkan ini!!</p>
            <div class="modal-buttons">
                <button id="cooldown-ok-btn">OK</button>
            </div>
        </div>
    </div>
    
    
    <nav class="nav-bar">
            <div class="nav-item" data-page="home-page"><img src="home.png" alt="Home"><span>Home</span></div>
            
            <div class="nav-item admin-only" data-page="admin-page"><img src="tambah.png" alt="Create"><span>Create</span></div>
            <div class="nav-item admin-only" data-page="data-page"><img src="data.png" alt="Data"><span>Data</span></div>
            
            <div class="nav-item owner-only" data-page="messages-page">
                <img src="inbox.png" alt="Inbox">
                <span>Inbox</span>
            </div>

            <div class="nav-item" data-page="chat-list-page">
                <img src="pesan.png" alt="Messages">
                <span>Messages</span>
            </div>
            <div class="nav-item" data-page="sender-page"><img src="kumbang1.png" alt="Bug"><span>Bug</span></div>
            <div class="nav-item" data-page="settings-page"><img src="pengaturan.png" alt="Settings"><span>Settings</span></div>
        </nav>
    </div>

    <div class="modal-overlay" id="confirm-modal">
        <div class="modal-box">
            <h3 id="confirm-title" style="color: #e94560; margin-bottom: 10px;">Confirm Action</h3>
            <p id="confirm-text">Are you sure?</p>
            <div class="modal-buttons">
                <button id="confirm-no-btn" style="background-color: #555; color: white;">Cancel</button>
                <button id="confirm-yes-btn" style="background-color: #e94560; color: white;">Yes, Continue</button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="user-search-modal">
        <div class="modal-box">
            <h3 style="color: #88d3ce; margin-bottom: 20px;">Start New Chat</h3>
            <div class="input-group"><input type="search" id="user-search-input" placeholder="Type username to search..."></div>
            <div id="user-search-results"></div>
            <div class="modal-buttons" style="margin-top: 20px;"><button id="close-user-search-modal-btn" style="background-color: #555; color: white;">Close</button></div>
        </div>
    </div>
    
    <a href="index2.html" class="floating-cs-button" title="Customer Service">
        <img src="cs1.png" alt="Customer Service Icon">
    </a>

    <div class="popup-overlay" id="popup-overlay"></div>
    
    <div class="menu-popup" id="menu-popup">
        <span class="menu-popup-logo-text">ùêîùêãùêìùêëùêÄùêÜùêéùêç</span>
        
        <p>User: <span id="menu-popup-username">...</span></p>
        <p>Role: <span id="menu-popup-role">...</span></p>
    </div>
    <div class="profile-popup" id="profile-popup">
        <div class="subscription-status">
            <p>Username: <span id="profile-popup-username" style="color:white;">...</span></p>
            <p>Role: <span id="profile-popup-role" style="color:white;">...</span></p><hr style="border-color:#2a2a3a; margin:10px 0;">
            <p>Application Status: <span id="profile-popup-app-status">...</span></p>
            <p>Expires On: <span id="profile-popup-expiry">...</span></p>
        </div>
        <button id="profile-popup-logout-btn">Logout</button>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script>
        // --- KONFIGURASI GLOBAL ---
        const COOLDOWN_MINUTES = 5; 
        const MASTER_OWNER_USERNAME = "Ultragon"; // Username Master Anda
        const MASTER_OWNER_PASSWORD = "MASTER KING";
        // Mengubah role akun Master Anda menjadi "Developer"
        const DEVELOPER_ROLE = "Developer"; 
        
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDmg3JbCywbOh__iDMgwbCGG480SzZSaiY",
            authDomain: "ultragon-app.firebaseapp.com",
            databaseURL: "https://ultragon-app-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ultragon-app",
            storageBucket: "ultragon-app.firebasestorage.app",
            messagingSenderId: "119387094211",
            appId: "1:119387094211:web:e43f951de20e793ac9b676"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- GLOBAL VARIABLES ---
        let currentUserData = {};
        let globalConfig = {};
        let allUsers = {};
        let chatsListener = null;
        let currentChatPartnerUid = null;
        let sessionListenerRef = null; 
        let isMusicPlaying = false; 
        // --- MODIFIKASI WEB AUDIO API (Bagian 1) ---
        let audioCtx = null; // Ini akan jadi 'speaker' kita
        let ultragonMusicBuffer = null; // Ini untuk menyimpan 'audio mentah'
        let currentMusicSource = null; // Ini untuk kontrol play/stop
        // --- AKHIR MODIFIKASI ---
        let globalInboxMessages = []; 
        let currentInboxFilters = { role: 'ALL', mode: 'ALL' }; 
        
        // üî• MODIFIKASI (Permintaan #6): Variabel baru untuk filter data
        let currentDataPageFilter = 'ALL'; // Default 'ALL'


        
        // ===========================================
        // ### START: COOKIE FUNCTIONS (PENTING)
        // ===========================================

        function setCookie(name, value, days) {
            let expires = "";
            if (days) {
                const date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "")  + expires + "; path=/; Secure; SameSite=Strict"; 
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for(let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        function eraseCookie(name) {   
            document.cookie = name+'=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
        }

        // ===========================================
        // ### END: COOKIE FUNCTIONS
        // ===========================================


        // --- UTILITY FUNCTIONS ---
        
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            if (!container) return;
            const notification = document.createElement('div');
            
            notification.className = `notification ${type}`; 
            
            // üî• MODIFIKASI BARU (Permintaan #1): Mengizinkan HTML di notifikasi
            notification.innerHTML = message; // Diubah dari .textContent ke .innerHTML
            
            container.appendChild(notification);
            
            // Perpanjang durasi notifikasi admin agar bisa dibaca
            const duration = type === 'music' ? 8000 : 4000; // 8 detik untuk notif admin, 4 detik u/ lainnya
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.5s forwards';
                setTimeout(() => { if (container.contains(notification)) container.removeChild(notification); }, 500);
            }, duration); 
        }
        
        function showCooldownModal(remainingMinutes, remainingSeconds) {
            const modal = document.getElementById('cooldown-modal');
            const messageEl = document.getElementById('cooldown-message-text');
            const okBtn = document.getElementById('cooldown-ok-btn');

            if (!modal || !messageEl || !okBtn) {
                 showNotification(`Cooldown aktif: ${remainingMinutes}:${remainingSeconds}`, 'error');
                 return;
            }
            
            const displaySeconds = remainingSeconds < 10 ? '0' + remainingSeconds : remainingSeconds;
            const remainingTimeText = `${remainingMinutes}:${displaySeconds}`;

            messageEl.textContent = `Silahkan tunggu selama ${remainingTimeText} untuk bisa melanjutkan ini!!`;
            modal.classList.add('active');

            const closeModal = () => {
                modal.classList.remove('active');
                okBtn.removeEventListener('click', closeModal);
            };

            okBtn.addEventListener('click', closeModal);
        }
        
        function showBugSuccessModal(targetNumber) {
            const modal = document.getElementById('bug-success-modal');
            const messageEl = document.getElementById('bug-success-message');
            const okBtn = document.getElementById('bug-success-ok-btn');

            if (!modal || !messageEl || !okBtn) {
                 showNotification(`Bug berhasil dikirim ke ${targetNumber}.`, 'success');
                 return;
            }
            
            messageEl.textContent = `Bug berhasil dikirim ke ${targetNumber}.`;
            modal.classList.add('active');

            const closeModal = () => {
                modal.classList.remove('active');
                okBtn.removeEventListener('click', closeModal);
            };

            okBtn.addEventListener('click', closeModal);
        }

        // üî• MODIFIKASI (Permintaan #6): Ubah teks pop-up ke Bahasa Inggris
        function showConfirm(text, onConfirm, title = "Confirm Action", yesText = "Yes, Continue", noText = "Cancel") {
            const modal = document.getElementById('confirm-modal');
            modal.classList.add('active');
            const yesBtn = document.getElementById('confirm-yes-btn');
            const noBtn = document.getElementById('confirm-no-btn');
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-text').textContent = text;
            yesBtn.textContent = yesText;
            noBtn.textContent = noText;
            
            const cleanup = () => {
                yesBtn.removeEventListener('click', confirmHandler);
                noBtn.removeEventListener('click', cancelHandler);
            };
            const confirmHandler = () => { onConfirm(); modal.classList.remove('active'); cleanup(); };
            const cancelHandler = () => { modal.classList.remove('active'); cleanup(); };
            yesBtn.addEventListener('click', confirmHandler);
            noBtn.addEventListener('click', cancelHandler);
        }

        function logout() {
            if (sessionListenerRef) { sessionListenerRef.off(); sessionListenerRef = null; }
            
            // üî• MODIFIKASI: Hapus Sesi Saat Logout üî•
            // Pindahkan ini ke atas agar 'currentUserData' pasti masih ada
            if (currentUserData && currentUserData.uid) { 
                const myNotifRef = db.ref('user_notifications/' + currentUserData.uid); 
                myNotifRef.off(); 
                
                // Ini adalah kunci agar orang lain bisa login
                db.ref('users/' + currentUserData.uid + '/currentSessionId').set(null); // Diubah dari .remove() ke .set(null) untuk keamanan
            }
            // üî• AKHIR MODIFIKASI üî•
            
            
            // üî• MODIFIKASI (Permintaan #1): Hentikan listener notifikasi admin saat logout
            db.ref('admin_notifications').off(); 

            // --- MODIFIKASI WEB AUDIO API (Bagian 2) ---
            // Hentikan musik dan tutup 'speaker' saat logout
            if (currentMusicSource) {
                currentMusicSource.stop();
                currentMusicSource = null;
            }
            if (audioCtx && audioCtx.state !== 'closed') {
                audioCtx.close();
                audioCtx = null;
            }
            isMusicPlaying = false;
            // --- AKHIR MODIFIKASI ---

            eraseCookie('userUid'); 
            eraseCookie('sessionId'); 
            
            window.location.href = 'index.html'; 
        }

        
        // --- MODIFIKASI WEB AUDIO API (Bagian 1) ---
        // Fungsi baru untuk memuat audio mentah
        async function loadMusic() {
            // Jangan lakukan apa-apa jika audio context gagal dibuat
            if (!audioCtx) return; 
            
            try {
                // 1. Ambil file musiknya
                const response = await fetch('ultragon.mp3');
                if (!response.ok) {
                    throw new Error('Gagal mengambil ultragon.mp3');
                }
                // 2. Ubah jadi data buffer
                const arrayBuffer = await response.arrayBuffer();
                
                // 3. Ubah data buffer jadi 'audio mentah' yang bisa dimainkan
                // Kita gunakan .then() di sini agar tidak memblokir kode lain
                audioCtx.decodeAudioData(arrayBuffer).then((buffer) => {
                    ultragonMusicBuffer = buffer; // Simpan di variabel global
                    console.log("Musik Ultragon berhasil dimuat.");
                }).catch((error) => {
                    console.error('Gagal decode audio:', error);
                    showNotification('Gagal memuat file musik.', 'error');
                });

            } catch (error) {
                console.error('Error memuat musik:', error);
                showNotification('File musik (ultragon.mp3) tidak ditemukan.', 'error');
            }
        }
        // --- AKHIR MODIFIKASI ---


        // --- START MODIFIKASI: FUNGSI POP-UP BARU ---
        const popupOverlay = document.getElementById('popup-overlay');
        const menuPopup = document.getElementById('menu-popup');
        const profilePopup = document.getElementById('profile-popup');

        function showMenuPopup() {
            if (!menuPopup || !popupOverlay || !currentUserData) return;
            
            document.getElementById('menu-popup-username').textContent = currentUserData.username || '...';
            document.getElementById('menu-popup-role').textContent = currentUserData.role || '...';
            
            popupOverlay.classList.add('active');
            menuPopup.classList.add('active');
        }

        function showProfilePopup() {
            if (!profilePopup || !popupOverlay || !currentUserData) return;
            
            document.getElementById('profile-popup-username').textContent = currentUserData.username || '...';
            document.getElementById('profile-popup-role').textContent = currentUserData.role || '...';
            
            const status = globalConfig.appStatus || 'ON';
            const statusEl = document.getElementById('profile-popup-app-status');
            statusEl.textContent = status === 'UPDATE_REQUIRED' ? 'UPDATING' : status;
            statusEl.className = status === 'ON' ? 'status-active' : (status === 'OFF' ? 'status-expired' : 'status-update');
            if (status === 'UPDATE_REQUIRED') statusEl.style.color = '#00bcd4';

            let displayExpiryDate;
            const isOwnerOrDev = currentUserData.role === 'Owner' || currentUserData.role === DEVELOPER_ROLE;
            if (currentUserData.expiryDate === 'UNLIMITED' || isOwnerOrDev) { 
                displayExpiryDate = '‚àû (Unlimited)';
            } else {
                displayExpiryDate = currentUserData.expiryDate ? new Date(currentUserData.expiryDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric'}) : 'N/A';
            }
            document.getElementById('profile-popup-expiry').textContent = displayExpiryDate;
            
            popupOverlay.classList.add('active');
            profilePopup.classList.add('active');
        }

        function closeAllPopups() {
            if (popupOverlay) popupOverlay.classList.remove('active');
            if (menuPopup) menuPopup.classList.remove('active');
            if (profilePopup) profilePopup.classList.remove('active');
        }
        
        // --- MODIFIKASI WEB AUDIO API (Bagian 3) ---
        // Fungsi handleMusicToggle yang ditulis ulang
        function handleMusicToggle() {
            // Cek 1: Pastikan 'speaker' (audioCtx) ada
            if (!audioCtx) {
                showNotification("Audio system error.", "error");
                return;
            }

            // Cek 2: Pastikan 'audio mentah' (buffer) sudah selesai dimuat
            if (!ultragonMusicBuffer) {
                showNotification("Music not loaded yet. Please wait...", "info");
                return;
            }

            // Jika musik sedang menyala (isMusicPlaying true)
            if (isMusicPlaying) {
                // Hentikan sumber suara yang sedang berjalan
                if (currentMusicSource) {
                    currentMusicSource.stop();
                    currentMusicSource = null; // Hapus referensi
                }
                showNotification("Music off", "music");
                isMusicPlaying = false; // Set status ke mati
            
            // Jika musik sedang mati (isMusicPlaying false)
            } else {
                // Buat sumber suara baru dari 'audio mentah'
                currentMusicSource = audioCtx.createBufferSource();
                currentMusicSource.buffer = ultragonMusicBuffer;
                currentMusicSource.loop = true; // Set agar berulang (loop)
                
                // Sambungkan sumber suara ke 'speaker' (destination)
                currentMusicSource.connect(audioCtx.destination);
                
                // Mulai mainkan
                currentMusicSource.start();
                
                showNotification("Music onüî•üî•", "music");
                isMusicPlaying = true; // Set status ke menyala

                // Tambahan: 'Awasi' jika sumber suara selesai (meski loop, ini jaga-jaga)
                currentMusicSource.onended = () => {
                    // Jika selesai BUKAN karena kita klik stop
                    if (isMusicPlaying) { 
                        isMusicPlaying = false;
                    }
                };
            }
        }
        // --- AKHIR MODIFIKASI ---


        function checkBugCooldown() {
            const btn = document.getElementById('send-bug-btn');
            const timerEl = document.getElementById('cooldown-timer');
            if (!btn || !timerEl || !currentUserData) return;
            const now = Date.now();
            const cooldownUntil = currentUserData.bugCooldownUntil || 0;
            if (cooldownUntil > now) {
                const remainingMs = cooldownUntil - now;
                const remainingMinutes = Math.floor(remainingMs / 60000);
                const remainingSeconds = Math.floor((remainingMs % 60000) / 1000);
                const displaySeconds = remainingSeconds < 10 ? '0' + remainingSeconds : remainingSeconds;
                timerEl.textContent = `Please wait ${remainingMinutes}:${displaySeconds}`;
                btn.disabled = true;
                btn.innerHTML = `<span>COOLDOWN</span>`; 
            } else {
                timerEl.textContent = '';
                btn.disabled = false;
                btn.innerHTML = `<img src="kirim.png" alt="Send"><span>SEND BUG</span>`; 
            }
        }

        function listenForMyNotifications() {
            if (!currentUserData || !currentUserData.uid) return;
            const myNotifRef = db.ref('user_notifications/' + currentUserData.uid);
            myNotifRef.on('child_added', (snapshot) => {
                const notif = snapshot.val();
                if (notif && notif.text && notif.type) {
                    showNotification(notif.text, notif.type);
                    db.ref('user_notifications/' + currentUserData.uid + '/' + snapshot.key).remove();
                }
            });
        }
        
        // üî• MODIFIKASI BARU (Permintaan #1): Fungsi untuk mendengarkan notifikasi Admin
        function listenForAdminNotifications() {
            const isAdmin = ['Owner', 'Reseller', DEVELOPER_ROLE].includes(currentUserData.role);
            if (!isAdmin) return;

            // Hanya dengarkan notifikasi baru yang dibuat SETELAH login
            const notificationsRef = db.ref('admin_notifications').orderByChild('timestamp').startAt(new Date().toISOString());
            
            notificationsRef.on('child_added', (snapshot) => {
                const notif = snapshot.val();
                
                // Tampilkan notifikasi HANYA jika bukan kita sendiri yang buat
                if (notif && notif.text && notif.type && notif.creatorUid !== currentUserData.uid) {
                    // Gunakan 'music' style (hitam border cyan) sesuai permintaan
                    showNotification(notif.text, 'music'); 
                }
                
                // Hapus notifikasi setelah 1 menit agar database bersih
                // (Ini lebih baik daripada membiarkannya menumpuk)
                const notifAge = Date.now() - new Date(notif.timestamp).getTime();
                if (notifAge > 60000) {
                    snapshot.ref.remove();
                }
            });
        }

        function listenForSessionChanges() {
            if (!currentUserData || !currentUserData.uid) return;
            
            // --- üî• MODIFIKASI: Cek Tombol Lock Developer üî• ---
            // Jika user adalah Developer DAN lock-nya TIDAK aktif (false/null),
            // maka JANGAN jalankan listener ini.
            if (currentUserData.role === DEVELOPER_ROLE && currentUserData.accountLockEnabled !== true) {
                if (sessionListenerRef) {
                    sessionListenerRef.off(); // Matikan listener jika ada
                    sessionListenerRef = null;
                }
                console.log("Account Lock OFF: Session listener dinonaktifkan.");
                return; // Stop, jangan dengarkan perubahan sesi
            }
            // --- üî• AKHIR MODIFIKASI üî•
            
            console.log("Account Lock ON: Session listener diaktifkan.");

            const mySessionId = getCookie('sessionId'); 
            if (!mySessionId) { logout(); return; }

            sessionListenerRef = db.ref('users/' + currentUserData.uid + '/currentSessionId');
            sessionListenerRef.on('value', (snapshot) => {
                const dbSessionId = snapshot.val();
                
                // Jika session ID di database menjadi null/kosong (karena kita di-kick atau logout manual),
                // DAN sessionListener-nya masih aktif, paksa logout.
                if (sessionListenerRef && !dbSessionId) {
                    showNotification("Logged out: Session has been cleared.", "error");
                    logout(); // Panggil fungsi logout yang sudah dimodifikasi
                }
                // Jika session ID di database BEDA (orang lain login), paksa logout.
                else if (sessionListenerRef && dbSessionId && dbSessionId !== mySessionId) {
                    showNotification("Logged out: Account used on another device.", "error");
                    logout();
                }
            });
        }
        async function initializeApp() {
            // --- MODIFIKASI WEB AUDIO API (Bagian 3) ---
            // Buat AudioContext (speaker) SEBELUM hal lain
            try {
                // (window.AudioContext || window.webkitAudioContext) adalah untuk browser lama
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                console.error('Web Audio API tidak didukung!', e);
                showNotification('Browser tidak support audio.', 'error');
                // ... (lanjutkan tanpa audio)
            }
            // --- AKHIR MODIFIKASI ---
            
            const localUserUid = getCookie('userUid'); 
            const localSessionId = getCookie('sessionId'); 
            
            if (!localUserUid || !localSessionId) { 
                window.location.href = 'index.html'; 
                return; 
            }
            
            if (window.history && window.history.replaceState) {
                window.history.replaceState(null, null, window.location.href);
            }

            try {
                const userSnapshot = await db.ref('users/' + localUserUid).get();
                if (!userSnapshot.exists()) { 
                    showNotification("Your data not found.", "error"); 
                    logout(); 
                    return; 
                }
                currentUserData = userSnapshot.val();
                currentUserData.uid = localUserUid;
                
                const isMasterUser = currentUserData.username === MASTER_OWNER_USERNAME && currentUserData.password === MASTER_OWNER_PASSWORD;
                
                if (isMasterUser && currentUserData.role !== DEVELOPER_ROLE) {
                    await db.ref('users/' + currentUserData.uid).update({ role: DEVELOPER_ROLE, expiryDate: 'UNLIMITED' });
                    currentUserData.role = DEVELOPER_ROLE;
                    currentUserData.expiryDate = 'UNLIMITED';
                }
                const isDeveloper = currentUserData.role === DEVELOPER_ROLE;

                const configSnapshot = await db.ref('config').get();
                globalConfig = configSnapshot.val() || {};

                if ((globalConfig.appStatus === 'OFF' || globalConfig.appStatus === 'UPDATE_REQUIRED') && !isDeveloper) {
                    const statusText = globalConfig.appStatus === 'OFF' ? 
                                       "Application is currently offline." : 
                                       "Application is currently under maintenance/update.";
                    
                    showNotification(statusText, "error");
                    
                    const overlay = document.createElement('div');
                    overlay.className = 'frozen-overlay';
                    overlay.id = 'app-status-overlay'; 
                    overlay.innerHTML = `<div class="content-box"><h2>${globalConfig.appStatus === 'OFF' ? 'Application Offline' : 'App Under Update'}</h2><p>${statusText}</p><button style="background:#c0392b; color:white; padding:10px; border-radius:8px; border:none; margin-top:15px;" onclick="logout()">Logout</button></div>`;
                    document.body.appendChild(overlay);
                    return; 
                }
                
                // üî• MODIFIKASI: Pengecekan Sesi Aktif (Kunci Utama) üî•
                // Ini memvalidasi cookie DENGAN database.
                if (!currentUserData.currentSessionId || currentUserData.currentSessionId !== localSessionId) {
                    // Jika session ID di cookie tidak sama dengan di DB (mis. sudah di-logout dari device lain)
                    // ATAU jika session ID di DB tidak ada (mis. habis di-kick 'onDisconnect' atau manual logout)
                    // maka paksa logout.
                    showNotification("Session invalid or expired. Please log in again.", "error");
                    // Hapus cookie yang salah
                    eraseCookie('userUid');
                    eraseCookie('sessionId');
                    // Paksa ke index.html (tanpa memanggil logout() agar tidak loop)
                    window.location.href = 'index.html';
                    return;
                }
                // üî• AKHIR MODIFIKASI üî•

            } catch (error) {
                showNotification("Failed to connect or data corrupted.", "error");
                return;
            }

            setupEventListeners();
            checkAccountExpiration(); // <-- Pengecekan expired untuk user yang sedang login
            listenToGlobalConfig(); 
            listenToAllUsers();
            listenForMyNotifications();
            listenForSessionChanges(); 
            
            // üî• MODIFIKASI: onDisconnect() DIHAPUS üî•
            // Sesuai permintaan Anda, sesi TIDAK AKAN dihapus saat browser ditutup.
            // Ini akan membuat fitur "Remember Me" berfungsi,
            // TAPI akun bisa "terkunci" jika user tidak menekan logout manual.
            
            // db.ref('users/'.../currentSessionId').onDisconnect().remove(); // <-- BARIS INI SENGAJA DIHAPUS
            
            // üî• AKHIR MODIFIKASI üî•
            
            
            // üî• MODIFIKASI BARU (Permintaan #1): Panggil listener notifikasi admin
            listenForAdminNotifications(); 

             const welcomeEl = document.getElementById('welcome-username');
             if(welcomeEl && currentUserData.username) {
                welcomeEl.textContent = currentUserData.username;
             }

            // --- MODIFIKASI WEB AUDIO API (Bagian 3) ---
            // Panggil fungsi untuk memuat musik di background
            if (audioCtx) {
                loadMusic();
            }
            // --- AKHIR MODIFIKASI ---
            
            setupRolePermissions();
            populateBugModeSelect(); 
            showPage('home-page');
            setInterval(checkBugCooldown, 1000);
        }
        
        function initializeCustomSelect(selectElementId, wrapperId, mode) {
            const originalSelect = document.getElementById(selectElementId);
            const wrapper = document.getElementById(wrapperId) || originalSelect.parentElement;

            if (!originalSelect) { return; }

            wrapper.querySelectorAll('.custom-select, .select-options').forEach(el => el.remove());

            const customSelect = document.createElement('div');
            customSelect.className = 'custom-select';
            customSelect.setAttribute('tabindex', '0');
            
            const selectedText = document.createElement('span');
            selectedText.className = 'selected-text';
            selectedText.textContent = originalSelect.options[originalSelect.selectedIndex]?.text || '';
            
            const arrow = document.createElement('span');
            arrow.className = 'custom-select-arrow';
            arrow.innerHTML = '&#9660;';

            customSelect.appendChild(selectedText);
            customSelect.appendChild(arrow);

            const optionsList = document.createElement('div');
            optionsList.className = 'select-options';

            Array.from(originalSelect.options).forEach(option => {
                const optionItem = document.createElement('div');
                optionItem.className = 'select-option-item';
                optionItem.textContent = option.text;
                optionItem.dataset.value = option.value;
                
                const isMember = currentUserData.role === 'Member';
                const restrictedModes = ['ultra', 'dark', 'zx']; 
                
                if (selectElementId === 'bug-mode-select' && isMember && restrictedModes.includes(option.value)) {
                    optionItem.classList.add('disabled-mode');
                    optionItem.addEventListener('click', (e) => {
                        e.stopPropagation(); 
                        showNotification(`Access denied: This mode is only available for VIP, Reseller, Owner, and Developer.`, 'error');
                    });
                } else {
                    if (option.selected) {
                        optionItem.classList.add('selected');
                    }
                    optionItem.addEventListener('click', (e) => {
                        originalSelect.value = option.value;
                        selectedText.textContent = option.text;
                        optionsList.style.display = 'none';
                        customSelect.classList.remove('open');
                        
                        optionsList.querySelectorAll('.select-option-item').forEach(item => item.classList.remove('selected'));
                        optionItem.classList.add('selected');
                        
                        originalSelect.dispatchEvent(new Event('change'));
                    });
                }
                
                optionsList.appendChild(optionItem);
            });

            customSelect.addEventListener('click', (e) => {
                e.stopPropagation();
                const isOpen = optionsList.style.display === 'block';
                document.querySelectorAll('.select-options').forEach(o => o.style.display = 'none');
                document.querySelectorAll('.custom-select').forEach(s => s.classList.remove('open'));
                
                if (!isOpen) {
                     optionsList.style.display = 'block';
                     customSelect.classList.add('open');
                }
            });

            document.addEventListener('click', () => {
                optionsList.style.display = 'none';
                customSelect.classList.remove('open');
            });
            
            originalSelect.classList.add('hidden-select');
            
            if (mode === 'duration-unit') {
                const durationGroup = originalSelect.closest('.duration-group');
                if (durationGroup) {
                    wrapper.appendChild(customSelect);
                    wrapper.appendChild(optionsList);
                }
            } else {
                 wrapper.insertBefore(optionsList, originalSelect);
                 wrapper.insertBefore(customSelect, originalSelect);
            }

        }
        
        function populateBugModeSelect() {
            const bugSelect = document.getElementById('bug-mode-select');
            if (!bugSelect || !currentUserData) return;
            
            const allModes = [
                { value: "delay", text: "Invisible Delay" },
                { value: "bug", text: "Andro Crash" },
                { value: "delayV2", text: "Invisible Delay V2" },
                { value: "ultra", text: "Ultra Killer" },
                { value: "dark", text: "Dark Killer" },
                { value: "zx", text: "Ultimate ZX" }
            ];

            let options = '';
            allModes.forEach(mode => {
                options += `<option value="${mode.value}">${mode.text}</option>`;
            });
            
            bugSelect.innerHTML = options;
            bugSelect.value = bugSelect.options[0]?.value || 'delay'; 
            
            initializeCustomSelect('bug-mode-select', 'bug-mode-wrapper');
        }

        function showPage(pageId, context = null) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            const targetPage = document.getElementById(pageId);
            if (targetPage) targetPage.classList.add('active');
            const navItem = document.querySelector(`.nav-item[data-page='${pageId}']`) || document.querySelector(`.nav-item[data-page='${pageId.replace('-window', '').replace('-list','')}']`);
            if (navItem) navItem.classList.add('active');

            // üî• MODIFIKASI BARU (Permintaan #3): Logika Kunci Scroll
            // Selalu reset scroll/height saat pindah halaman
            document.body.style.overflow = 'auto';
            document.body.style.touchAction = 'auto';
            const homePageEl = document.getElementById('home-page');
            if (homePageEl) {
                homePageEl.style.height = 'auto';
            }

            // Kunci scroll HANYA jika VIP/Member di Home Page
            const isMemberOrVip = currentUserData.role === 'Member' || currentUserData.role === 'VIP';
            if (isMemberOrVip && pageId === 'home-page') {
                document.body.style.overflow = 'hidden';
                document.body.style.touchAction = 'none'; // Mencegah pull-to-refresh/scroll di mobile
            } else {
                // Pastikan halaman lain bisa di-scroll
                document.body.style.overflow = 'auto';
                document.body.style.touchAction = 'auto';
            }
            // üî• AKHIR MODIFIKASI (Permintaan #3)

            if (pageId === 'sender-page' && currentUserData) {
                checkBugCooldown();
                populateBugModeSelect(); 
            }
            
            const isAdmin = ['Owner', 'Reseller', DEVELOPER_ROLE].includes(currentUserData.role);
            if (pageId === 'admin-page' && isAdmin) {
                const durationModeSelect = document.getElementById('duration-mode-select');
                const newRoleSelect = document.getElementById('new-role');
                const isDeveloper = currentUserData.role === DEVELOPER_ROLE;

                if (durationModeSelect && newRoleSelect) {
                    
                    const currentMode = durationModeSelect.value;
                    const newRole = newRoleSelect.value;
                    
                    const newMode = newRole === 'Owner' || newRole === DEVELOPER_ROLE ? 'unlimited' : currentMode;
                    
                    durationModeSelect.value = newMode || 'time';
                    
                    const unlimitedOption = Array.from(durationModeSelect.options).find(opt => opt.value === 'unlimited');
                    
                    if (unlimitedOption) {
                        if (!isDeveloper) {
                            unlimitedOption.style.display = (newRole === 'Owner' || newRole === DEVELOPER_ROLE) ? 'block' : 'none';
                        } else {
                            unlimitedOption.style.display = 'block'; 
                        }
                    }
                    
                    toggleDurationMode({ 
                        target: { value: durationModeSelect.value }
                    });
                    
                    durationModeSelect.disabled = newRole === 'Owner' || newRole === DEVELOPER_ROLE;
                    
                    const customSelectMode = document.getElementById('duration-mode-select-wrapper').querySelector('.selected-text');
                    if(customSelectMode) customSelectMode.textContent = durationModeSelect.options[durationModeSelect.selectedIndex].text;
                }
            }

            if (pageId === 'data-page' && isAdmin) {
                 currentDataPageFilter = 'ALL';
                 document.querySelectorAll('#data-page-filters .inbox-tab-btn').forEach(btn => {
                     btn.classList.toggle('active', btn.dataset.filter === 'ALL');
                 });
                 populateDataPageTable();
            }
            

            const renderFunctionName = 'render' + pageId.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join('');
            if (typeof window[renderFunctionName] === 'function') {
                window[renderFunctionName](context);
            }
        }

        function listenToGlobalConfig() {
            db.ref('config').on('value', (snapshot) => {
                globalConfig = snapshot.val() || {};

                const announcementEl = document.getElementById('live-announcement');
                const liveText = globalConfig.liveAnnouncementText || '';

                if (announcementEl) {
                    announcementEl.textContent = liveText;
                    announcementEl.style.display = liveText ? 'block' : 'none';
                }
                
                const isDeveloper = currentUserData.role === DEVELOPER_ROLE;
                
                if ((globalConfig.appStatus === 'OFF' || globalConfig.appStatus === 'UPDATE_REQUIRED') && !isDeveloper) {
                    
                    if (globalConfig.appStatus === 'UPDATE_REQUIRED') {
                        showNotification("Application is updating. Please log in again later.", "info");
                        setTimeout(logout, 2000); 
                        return; 
                    }
                    
                    const statusText = "Application is currently offline.";
                    
                    if (!document.getElementById('app-status-overlay')) { 
                        const overlay = document.createElement('div');
                        overlay.className = 'frozen-overlay';
                        overlay.id = 'app-status-overlay'; 
                        overlay.innerHTML = `<div class="content-box"><h2>Application Offline</h2><p>${statusText}</p><button style="background:#c0392b; color:white; padding:10px; border-radius:8px; border:none; margin-top:15px;" onclick="logout()">Logout</button></div>`;
                        document.body.appendChild(overlay);
                    }
                } else if (globalConfig.appStatus === 'ON' || isDeveloper) {
                    const overlay = document.getElementById('app-status-overlay');
                    if (overlay) {
                        overlay.remove();
                    }
                }

                updateUI();
            });
        }

        function listenToAllUsers() {
             db.ref('users').on('value', (snapshot) => {
                allUsers = snapshot.val() || {};
                updateUI(); 
             });
        }

        function setupRolePermissions() {
             if (!currentUserData) return; 
            
            const isAdmin = ['Owner', 'Reseller', DEVELOPER_ROLE].includes(currentUserData.role);
            const isDeveloper = currentUserData.role === DEVELOPER_ROLE;
            const isMemberOrVip = currentUserData.role === 'Member' || currentUserData.role === 'VIP';
            
            const iconNavGrid = document.querySelector('.icon-nav-grid');
            if (iconNavGrid) {
                
                if (isMemberOrVip) {
                    document.querySelector("a[data-page='admin-page']").style.display = 'none';
                    document.querySelector("a[data-page='data-page']").style.display = 'none';
                    document.querySelector("a[data-page='messages-page']").style.display = 'none';
                } else {
                    document.querySelector("a[data-page='admin-page']").style.display = 'flex';
                    document.querySelector("a[data-page='data-page']").style.display = 'flex';
                    document.querySelector("a[data-page='messages-page']").style.display = isDeveloper ? 'flex' : 'none';
                }
            }

            const navBarAdminItems = document.querySelectorAll('.nav-bar .admin-only');
            const navBarOwnerItems = document.querySelectorAll('.nav-bar .owner-only');
            
            navBarAdminItems.forEach(item => {
                item.style.display = isAdmin ? 'flex' : 'none';
            });

            navBarOwnerItems.forEach(item => {
                item.style.display = isDeveloper ? 'flex' : 'none'; 
            });

            const navBar = document.querySelector('.nav-bar');
            if (navBar) {
                const visibleItems = Array.from(navBar.children).filter(item => item.style.display !== 'none');
                const numVisible = visibleItems.length;
                const flexBasis = numVisible > 0 ? (100 / numVisible) + '%' : 'auto';

                visibleItems.forEach(item => {
                    item.style.flex = `1 1 ${flexBasis}`;
                });
            }

            const prefixSettings = document.getElementById('prefix-settings');
            if (prefixSettings) prefixSettings.style.display = isDeveloper ? 'block' : 'none';
        }

        function setupDynamicOwnerControls() {
            const isDeveloper = currentUserData.role === DEVELOPER_ROLE;
            if (!isDeveloper) return;

            const saveAnnouncementBtn = document.getElementById('save-announcement-btn');
            const apkOnBtn = document.querySelector('.apk-on-btn');
            const apkOffBtn = document.querySelector('.apk-off-btn');
            const appUpdateBtn = document.getElementById('app-update-btn');
            const appFinishUpdateBtn = document.getElementById('app-finish-update-btn');
            const saveSenderBtn = document.getElementById('save-sender-btn');
            const saveWaBtn = document.getElementById('save-wa-btn');
            const saveExtensionWaBtn = document.getElementById('save-extension-wa-btn');
            const saveTelegramTextBtn = document.getElementById('save-telegram-text-btn');
            const saveTelegramLinkBtn = document.getElementById('save-telegram-link-btn');


            if (saveAnnouncementBtn) saveAnnouncementBtn.addEventListener('click', handleSaveAnnouncement); 
            if (apkOnBtn) apkOnBtn.addEventListener('click', () => { db.ref('config/appStatus').set('ON'); showNotification('Application Status: ON', 'success'); });
            if (apkOffBtn) apkOffBtn.addEventListener('click', () => { db.ref('config/appStatus').set('OFF'); showNotification('Application Status: OFF', 'error'); });
            
            if (appUpdateBtn) appUpdateBtn.addEventListener('click', () => { 
                db.ref('config/appStatus').set('UPDATE_REQUIRED'); 
                showNotification('Status Aplikasi: UPDATE DIBUTUHKAN. Semua non-Developer akan di-logout.', 'info'); 
                updateSettingsPageUI(); 
            });
            if (appFinishUpdateBtn) appFinishUpdateBtn.addEventListener('click', () => { 
                db.ref('config/appStatus').set('ON'); 
                showNotification('Status Aplikasi: ON (Update Selesai)', 'success'); 
                updateSettingsPageUI(); 
            });
            
            if (saveSenderBtn) saveSenderBtn.addEventListener('click', () => { 
                const input = document.getElementById('active-sender-input');
                if(input) db.ref('config/activeSenderCount').set(parseInt(input.value) || 0); 
                showNotification('Active Senders saved!', 'success'); 
            });
            
            if (saveWaBtn) saveWaBtn.addEventListener('click', () => { 
                const input = document.getElementById('admin-wa-input');
                if(input) db.ref('config/adminWaNumberLogin').set(input.value); 
                showNotification('Admin WA Number saved!', 'success'); 
            });
            
            if (saveExtensionWaBtn) saveExtensionWaBtn.addEventListener('click', () => { 
                const input = document.getElementById('extension-wa-input');
                if(input) db.ref('config/extensionWaNumber').set(input.value); 
                showNotification('Extension Request WA Number saved!', 'success'); 
            });
            
            if (saveTelegramTextBtn) saveTelegramTextBtn.addEventListener('click', () => {
                const text1 = document.getElementById('telegram-text1-input');
                const text2 = document.getElementById('telegram-text2-input');
                if(text1 && text2){
                    db.ref('config').update({
                        telegramBannerTextLine1: text1.value,
                        telegramBannerTextLine2: text2.value
                    }).then(() => showNotification('Banner Text saved!', 'success')); 
                }
            });
            
            if (saveTelegramLinkBtn) saveTelegramLinkBtn.addEventListener('click', () => {
                 const input = document.getElementById('telegram-link-input');
                 if(input) db.ref('config/telegramBannerLink').set(input.value);
                 showNotification('Banner Link saved!', 'success'); 
            });
        }

        // --- üî• MODIFIKASI BARU: Fungsi untuk Tombol Lock Akun Dev üî• ---
        async function handleToggleAccountLock() {
            const btn = document.getElementById('developer-lock-btn');
            if (!btn || !currentUserData || currentUserData.role !== DEVELOPER_ROLE) return;

            btn.disabled = true;
            const currentLockStatus = currentUserData.accountLockEnabled === true;
            const newLockStatus = !currentLockStatus; // Kebalikannya

            try {
                await db.ref('users/' + currentUserData.uid + '/accountLockEnabled').set(newLockStatus);
                currentUserData.accountLockEnabled = newLockStatus; // Update data lokal
                
                // Perbarui tampilan tombol
                updateDeveloperLockUI(); 
                
                if (newLockStatus) {
                    showNotification('Account Lock: ON. Akun Anda sekarang terlindungi dari login ganda.', 'success');
                } else {
                    showNotification('Account Lock: OFF. Akun Anda sekarang bisa login di banyak perangkat.', 'info');
                }
                
                // PENTING: Panggil ulang session listener untuk menerapkan aturan baru
                listenForSessionChanges();
                
            } catch (error) {
                showNotification('Gagal mengubah status lock.', 'error');
            } finally {
                btn.disabled = false;
            }
        }
        
        // --- üî• MODIFIKASI BARU: Fungsi untuk update UI Tombol Lock üî• ---
        function updateDeveloperLockUI() {
            const container = document.getElementById('developer-lock-container');
            if (!container || !currentUserData || currentUserData.role !== DEVELOPER_ROLE) {
                 if(container) container.innerHTML = ''; // Kosongkan jika bukan developer
                 return;
            }
            
            const isLockOn = currentUserData.accountLockEnabled === true;
            
            let buttonText = isLockOn ? 'Account Lock: ON (Tekan untuk OFF)' : 'Account Lock: OFF (Tekan untuk ON)';
            let buttonClass = isLockOn ? 'lock-on' : 'lock-off';
            let description = isLockOn ? 
                'Perangkat lain tidak bisa login ke akun ini. Klik untuk mematikan.' : 
                'Perangkat lain BISA login ke akun ini (mode tidak aman). Klik untuk menyalakan.';

            container.innerHTML = `
                <div class="developer-lock-section">
                    <h4>Developer Account Lock</h4>
                    <p>${description}</p>
                    <button id="developer-lock-btn" class="${buttonClass}">${buttonText}</button>
                </div>
            `;
        }

        function setupEventListeners() {
            const profileBtn = document.getElementById('header-profile-btn');
            const menuBtn = document.getElementById('header-menu-btn');
            
            const createAccBtn = document.getElementById('create-account-btn');
            const searchAccInput = document.getElementById('search-account-input');
            const accListBody = document.getElementById('account-list-body');
            const sendBugWrapper = document.getElementById('send-bug-wrapper');
            const savePrefixBtn = document.getElementById('save-prefix-btn');
            const settingsPage = document.getElementById('settings-page');
            const logoutBtn = document.getElementById('logout-btn'); 
            const messagesPage = document.getElementById('messages-page');
            const startChatBtn = document.getElementById('start-new-chat-btn');
            const closeSearchBtn = document.getElementById('close-user-search-modal-btn');
            const userSearchInput = document.getElementById('user-search-input');
            const convoList = document.getElementById('conversation-list');
            const backChatListBtn = document.getElementById('back-to-chat-list-btn');
            const msgForm = document.getElementById('message-form');
            const msgContainer = document.getElementById('message-container');
            const durationModeSelect = document.getElementById('duration-mode-select'); 
            const editDurationModeSelect = document.getElementById('edit-duration-mode-select'); 
            const newRoleSelect = document.getElementById('new-role'); 
            const saveEditBtn = document.getElementById('save-edit-btn');
            const closeEditModalBtn = document.getElementById('close-edit-modal-btn');
            const deleteChatHistoryBtn = document.getElementById('delete-chat-history-btn');
            const bugModeSelect = document.getElementById('bug-mode-select');
            
            const musicBtn = document.getElementById('music-toggle-btn');
            if (musicBtn) musicBtn.addEventListener('click', handleMusicToggle);
            
            const roleFilters = document.getElementById('inbox-role-filters');
            const modeFilters = document.getElementById('inbox-mode-filters');
            if (roleFilters) roleFilters.addEventListener('click', handleInboxFilterClick);
            if (modeFilters) modeFilters.addEventListener('click', handleInboxFilterClick);

            // üî• MODIFIKASI (Permintaan #6): Tambah listener filter data page
            const dataPageFilters = document.getElementById('data-page-filters');
            if (dataPageFilters) dataPageFilters.addEventListener('click', handleDataPageFilterClick);
            
            const deleteAllExpiredBtn = document.getElementById('delete-all-expired-btn');
            if(deleteAllExpiredBtn) deleteAllExpiredBtn.addEventListener('click', handleDeleteAllExpired);

            if (profileBtn) profileBtn.addEventListener('click', showProfilePopup);
            if (menuBtn) menuBtn.addEventListener('click', showMenuPopup);

            const overlay = document.getElementById('popup-overlay');
            if (overlay) overlay.addEventListener('click', closeAllPopups);
            
            const profileLogoutBtn = document.getElementById('profile-popup-logout-btn');
            if (profileLogoutBtn) profileLogoutBtn.addEventListener('click', () => {
                closeAllPopups(); 
                logout(); 
            });

            document.querySelectorAll('.nav-item, .icon-button').forEach(btn => {
                if (btn.id === 'music-toggle-btn') return; 
                
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (btn.dataset.page) showPage(btn.dataset.page); 
                });
            });

            if (createAccBtn) createAccBtn.addEventListener('click', handleCreateAccount);
            if (searchAccInput) searchAccInput.addEventListener('input', populateDataPageTable);
            
            if (accListBody) accListBody.addEventListener('click', handleDataPageActions);
            
            if (sendBugWrapper) {
                sendBugWrapper.addEventListener('click', handleBugSend); 
            }
            
            if (savePrefixBtn) savePrefixBtn.addEventListener('click', handleSavePrefix);
            
            if (settingsPage) settingsPage.addEventListener('click', handleSettingsPageActions);
            if (logoutBtn) logoutBtn.addEventListener('click', logout); 
            if (messagesPage) messagesPage.addEventListener('click', handleMessagesPageActions);
            
            if (startChatBtn) startChatBtn.addEventListener('click', () => {
                 if ((globalConfig.appStatus === 'OFF' || globalConfig.appStatus === 'UPDATE_REQUIRED') && currentUserData.role !== DEVELOPER_ROLE) {
                    showNotification("Application is currently OFF or Updating.", "error");
                    return; 
                 }
                 const modal = document.getElementById('user-search-modal');
                 if (modal) modal.classList.add('active');
            });
            
            // --- üî• MODIFIKASI BARU: Listener untuk Tombol Lock Developer üî• ---
            // Kita harus mendelegasikan event ke 'settings-page' karena tombolnya dibuat dinamis
            if (settingsPage) {
                settingsPage.addEventListener('click', (e) => {
                    if (e.target && e.target.id === 'developer-lock-btn') {
                        handleToggleAccountLock();
                    }
                });
            }

            if (closeSearchBtn) closeSearchBtn.onclick = () => {
                 const modal = document.getElementById('user-search-modal');
                 if (modal) modal.classList.remove('active');
            };
            if (userSearchInput) userSearchInput.addEventListener('input', handleUserSearch);
            if (convoList) convoList.addEventListener('click', handleConversationListActions);
            
            if (backChatListBtn) backChatListBtn.addEventListener('click', () => showPage('chat-list-page'));
            if (msgForm) msgForm.addEventListener('submit', handleSendMessage);
            if (msgContainer) msgContainer.addEventListener('click', handleDeleteMessageClick);
            
            if (deleteChatHistoryBtn) deleteChatHistoryBtn.addEventListener('click', handleDeleteChatHistory);


            initializeCustomSelect('new-role', 'new-role-wrapper');
            initializeCustomSelect('new-duration-unit', 'new-duration-unit-wrapper', 'duration-unit');
            initializeCustomSelect('duration-mode-select', 'duration-mode-select-wrapper');
            
            if (bugModeSelect) {
                 initializeCustomSelect('bug-mode-select', 'bug-mode-wrapper');
            }


            if (durationModeSelect) {
                durationModeSelect.addEventListener('change', (e) => toggleDurationMode({ 
                    target: e.target, 
                    wrapperId: 'duration-group-wrapper', 
                    valueInputId: 'new-duration-value', 
                    unitSelectId: 'new-duration-unit' 
                }));
            }
            
            if (newRoleSelect) {
                newRoleSelect.addEventListener('change', (e) => {
                    const isOwnerOrDeveloperRole = e.target.value === 'Owner' || e.target.value === DEVELOPER_ROLE;
                    const isDeveloper = currentUserData.role === DEVELOPER_ROLE;
                    
                    if (durationModeSelect) {
                        
                        if (isOwnerOrDeveloperRole) {
                            durationModeSelect.value = 'unlimited';
                        } else {
                            durationModeSelect.value = 'time';
                        }
                        
                        const unlimitedOption = Array.from(durationModeSelect.options).find(opt => opt.value === 'unlimited');
                        if (unlimitedOption) {
                            unlimitedOption.style.display = (isOwnerOrDeveloperRole || isDeveloper) ? 'block' : 'none';
                        }

                        const customModeSelect = document.getElementById('duration-mode-select-wrapper').querySelector('.selected-text');
                        if (customModeSelect) customModeSelect.textContent = durationModeSelect.options[durationModeSelect.selectedIndex].text;
                        
                        toggleDurationMode({ 
                            target: durationModeSelect, 
                            wrapperId: 'duration-group-wrapper', 
                            valueInputId: 'new-duration-value', 
                            unitSelectId: 'new-duration-unit' 
                        });
                        
                        durationModeSelect.disabled = isOwnerOrDeveloperRole; 
                    }
                });
            }

            if (editDurationModeSelect) {
                editDurationModeSelect.addEventListener('change', (e) => toggleDurationMode({ 
                    target: e.target, 
                    wrapperId: 'edit-duration-group-wrapper', 
                    valueInputId: 'edit-duration-value', 
                    unitSelectId: 'edit-duration-unit' 
                }));
            }
            if (saveEditBtn) saveEditBtn.addEventListener('click', handleSaveEditAccount);
            if (closeEditModalBtn) closeEditModalBtn.addEventListener('click', () => { 
                document.getElementById('edit-account-modal').classList.remove('active'); 
            });
            
            const cooldownOkBtn = document.getElementById('cooldown-ok-btn');
            if (cooldownOkBtn) cooldownOkBtn.addEventListener('click', () => {
                document.getElementById('cooldown-modal').classList.remove('active');
            });


        }
        
        function toggleDurationMode(event) {
            const wrapperId = event.wrapperId || 'duration-group-wrapper';
            const valueInputId = event.valueInputId || 'new-duration-value';
            const unitSelectId = event.unitSelectId || 'new-duration-unit';

            const wrapper = document.getElementById(wrapperId);
            const durationValueInput = document.getElementById(valueInputId);
            const durationUnitSelect = document.getElementById(unitSelectId);
            const selectedMode = event.target.value;
            const isUnlimited = selectedMode === 'unlimited';
            const isTime = selectedMode === 'time';
            const isKeep = selectedMode === 'keep'; 

            if (!wrapper) return;

            if (isUnlimited || isKeep) {
                wrapper.classList.add('unlimited-mode');
            } else {
                wrapper.classList.remove('unlimited-mode');
            }

            if (durationValueInput) {
                if (isTime) durationValueInput.setAttribute('required', 'required');
                else durationValueInput.removeAttribute('required');
                durationValueInput.disabled = !isTime;
            }
            if (durationUnitSelect) {
                if (isTime) durationUnitSelect.setAttribute('required', 'required');
                else durationUnitSelect.removeAttribute('required');
                durationUnitSelect.disabled = !isTime;
            }
            
            const customUnitWrapper = document.getElementById(unitSelectId + '-wrapper');
            if (customUnitWrapper) {
                 customUnitWrapper.style.display = isTime ? 'block' : 'none';
            }
        }

        function checkAccountExpiration() {
             if (!currentUserData || currentUserData.role === 'Owner' || currentUserData.role === DEVELOPER_ROLE) return;
            const expiryDateISO = currentUserData.expiryDate;
            
            if (expiryDateISO === 'UNLIMITED') return; 

            if (!expiryDateISO || new Date() < new Date(expiryDateISO)) return;
            
            // üî• MODIFIKASI: Pengecekan Expired di Dashboard üî•
            const overlay = document.createElement('div');
            overlay.className = 'frozen-overlay';
            overlay.id = 'expired-overlay'; 
            // Ubah pesan dan pastikan memanggil logout() yang sudah benar
            overlay.innerHTML = `<div class="content-box"><h2>Subscription Expired</h2><p>Your account has expired. Contact admin for renewal.</p><button style="background:#c0392b; color:white; padding:10px; border-radius:8px; border:none; margin-top:15px;" onclick="logout()">Logout</button></div>`;

            if (document.body) {
                 document.body.appendChild(overlay);
            } else {
                 document.addEventListener('DOMContentLoaded', () => document.body.appendChild(overlay));
            }
        }

        function updateUI() {
             const activeSenderEl = document.getElementById('active-sender-stat');
             const onlineUsersEl = document.getElementById('online-users-stat');
             const bannerLinkEl = document.getElementById('telegram-banner-link');
             const bannerText1El = document.getElementById('banner-text-line1');
             const bannerText2El = document.getElementById('banner-text-line2');
             const newRoleSelect = document.getElementById('new-role');
             const editRoleSelect = document.getElementById('edit-role'); 
             const delayPrefixInput = document.getElementById('delay-prefix-input');
             const bugPrefixInput = document.getElementById('bug-prefix-input');
             const delayV2PrefixInput = document.getElementById('delayV2-prefix-input');
             const ultraPrefixInput = document.getElementById('ultra-prefix-input');
             const darkPrefixInput = document.getElementById('dark-prefix-input');
             const zxPrefixInput = document.getElementById('zx-prefix-input');


             if (activeSenderEl) activeSenderEl.textContent = globalConfig.activeSenderCount || '0';
             if (onlineUsersEl) onlineUsersEl.textContent = Object.keys(allUsers).length;

             if (bannerLinkEl) { bannerLinkEl.href = globalConfig.telegramBannerLink || 'https://t.me/ultragonpro'; }
             if (bannerText1El) { bannerText1El.textContent = globalConfig.telegramBannerTextLine1 || 'üî• Telegram Channel: Join To Get'; }
             if (bannerText2El) { bannerText2El.textContent = globalConfig.telegramBannerTextLine2 || 'More Info!'; }

             const announcementEl = document.getElementById('live-announcement');
             const liveText = globalConfig.liveAnnouncementText || '';

             if (announcementEl) {
                 announcementEl.textContent = liveText;
                 announcementEl.style.display = liveText ? 'block' : 'none';
             }

             const isOwner = currentUserData.role === 'Owner';
             const isDeveloper = currentUserData.role === DEVELOPER_ROLE;
             const roleOptions = `<option value="" disabled selected>Select a role</option><option value="Member">Member</option><option value="VIP">VIP</option>`;
             const resellerOption = `<option value="Reseller">Reseller</option>`;
             const ownerOption = `<option value="Owner">Owner</option>`; 
             const developerOption = `<option value="${DEVELOPER_ROLE}">${DEVELOPER_ROLE}</option>`; 

             if (newRoleSelect && currentUserData) { 
                 let options = roleOptions;
                 if (currentUserData.role === 'Reseller') options += resellerOption;
                 if (isOwner) options += resellerOption + ownerOption; 
                 if (isDeveloper) options += resellerOption + ownerOption + developerOption; 
                 newRoleSelect.innerHTML = options;
                 initializeCustomSelect('new-role', 'new-role-wrapper');
            }
             if (editRoleSelect && currentUserData) {
                 let options = roleOptions;
                 if (isOwner) options += resellerOption + ownerOption;
                 if (isDeveloper) options += resellerOption + ownerOption + developerOption; 
                 editRoleSelect.innerHTML = options;
                 initializeCustomSelect('edit-role', 'edit-role-wrapper');
             }

             updateSettingsPageUI(); 

             if(delayPrefixInput) delayPrefixInput.value = globalConfig.customDelayPrefix || '.delay';
             if(bugPrefixInput) bugPrefixInput.value = globalConfig.customBugPrefix || '.bug';
             if(delayV2PrefixInput) delayV2PrefixInput.value = globalConfig.customDelayV2Prefix || '.delayV2';
             if(ultraPrefixInput) ultraPrefixInput.value = globalConfig.customUltraPrefix || '.ultra';
             if(darkPrefixInput) darkPrefixInput.value = globalConfig.customDarkPrefix || '.dark';
             if(zxPrefixInput) zxPrefixInput.value = globalConfig.customZxPrefix || '.zx';

             const isAdmin = ['Owner', 'Reseller', DEVELOPER_ROLE].includes(currentUserData?.role);
             const accListBody = document.getElementById('account-list-body');
             if (document.getElementById('message-inbox-container')) populateMessagesInbox();
             if (accListBody && isAdmin && accListBody.closest('.page.active')) {
                 populateDataPageTable();
             }
             if (document.getElementById('conversation-list')) populateChatList();
        }

        async function handleCreateAccount(e) {
            if ((globalConfig.appStatus === 'OFF' || globalConfig.appStatus === 'UPDATE_REQUIRED') && currentUserData.role !== DEVELOPER_ROLE) {
                showNotification("Application is currently OFF or Updating.", "error");
                return;
            }
            const btn = document.getElementById('create-account-btn');
            const form = document.getElementById('create-account-form');
            const durationModeSelect = document.getElementById('duration-mode-select');
            const newRoleSelect = document.getElementById('new-role');

            if (!btn || !form || !durationModeSelect || !newRoleSelect) return; 
            btn.disabled = true; btn.textContent = 'Creating...';
            const usernameInput = document.getElementById('new-username');
            const passwordInput = document.getElementById('new-password');
            const durationValueInput = document.getElementById('new-duration-value'); 
            const durationUnitSelect = document.getElementById('new-duration-unit'); 
            
            const newUsername = usernameInput.value;
            const newPassword = passwordInput.value;
            const newRole = newRoleSelect.value;
            let selectedMode = durationModeSelect.value;
            
            const isDeveloper = currentUserData.role === DEVELOPER_ROLE;
            const isOwner = currentUserData.role === 'Owner';
            const isReseller = currentUserData.role === 'Reseller';
            
            if (isReseller && (newRole === 'Owner' || newRole === DEVELOPER_ROLE)) {
                showNotification(`Access denied: Reseller tidak dapat membuat akun ${newRole}.`, 'error');
                btn.disabled = false; btn.textContent = 'Create Account';
                return;
            }
            if (isOwner && newRole === DEVELOPER_ROLE) {
                showNotification('Access denied: Owner tidak dapat membuat akun Developer.', 'error');
                btn.disabled = false; btn.textContent = 'Create Account';
                return;
            }
            
            if (newRole === 'Owner' || newRole === DEVELOPER_ROLE) {
                selectedMode = 'unlimited'; 
            } else if (!isDeveloper && selectedMode === 'unlimited') {
                showNotification('Access denied: Hanya Developer yang dapat membuat akun Unlimited (selain Owner/Developer).', 'error');
                btn.disabled = false; btn.textContent = 'Create Account';
                return;
            }

            let expiryDate = null;
            let durationValue = null;
            let durationUnit = null;
            let durationText = "";
            let expiryDateText = ""; // Teks untuk notifikasi

            if (selectedMode === 'unlimited') {
                expiryDate = 'UNLIMITED';
                durationText = "Unlimited";
                expiryDateText = "Unlimited"; // Notifikasi
            } else {
                durationValue = parseInt(durationValueInput.value, 10); 
                durationUnit = durationUnitSelect.value; 

                if (!newUsername || !newPassword || !newRole) { 
                    showNotification('Username, Password, dan Role wajib diisi!', 'error');
                    btn.disabled = false; btn.textContent = 'Create Account';
                    return;
                }
                if (selectedMode === 'time' && (isNaN(durationValue) || durationValue <= 0)) { 
                     showNotification('Masukkan nilai durasi yang valid.', 'error');
                    btn.disabled = false; btn.textContent = 'Create Account';
                    return;
                }
            }


            try {
                if ((await db.ref('usernames/' + newUsername).get()).exists()) {
                    showNotification(`Username "${newUsername}" is already taken!`, 'error'); throw new Error('Username taken');
                }
                const newUid = `user-${Date.now()}`;
                const now = new Date(); 
                
                if (selectedMode === 'time') {
                    const expiry = new Date();
                    if (durationUnit === 'days') {
                        expiry.setDate(now.getDate() + durationValue); 
                    } else if (durationUnit === 'months') {
                        expiry.setMonth(now.getMonth() + durationValue);
                    } else if (durationUnit === 'years') {
                        expiry.setFullYear(now.getFullYear() + durationValue);
                    } else {
                         showNotification('Invalid duration unit selected.', 'error'); 
                         throw new Error('Invalid unit');
                    }
                    expiryDate = expiry.toISOString();
                    durationText = `${durationValue} ${durationUnit.charAt(0).toUpperCase() + durationUnit.slice(1)}`;
                    expiryDateText = expiry.toLocaleDateString(); // Notifikasi
                }
                
                // üî• MODIFIKASI: Tambahkan 'accountLockEnabled' saat buat akun Developer
                let newUserObject = { 
                    username: newUsername, 
                    password: newPassword, 
                    role: newRole, 
                    purchaseDate: now.toISOString(), 
                    expiryDate: expiryDate,
                    creatorUid: currentUserData.uid 
                };
                
                if (newRole === DEVELOPER_ROLE) {
                    newUserObject.accountLockEnabled = true; // Default Lock ON untuk Developer baru
                }
                // üî• AKHIR MODIFIKASI

                await db.ref('users/' + newUid).set(newUserObject);
                await db.ref('usernames/' + newUsername).set(newUid);
                
                // üî• MODIFIKASI BARU (Permintaan #1): Kirim notifikasi admin yang detail
                const isAdminCreator = ['Owner', DEVELOPER_ROLE, 'Reseller'].includes(newRole);
                if (isAdminCreator) {
                    // Format pesan notifikasi dengan HTML
                    const notificationMessage = `
                        <div style="font-family: 'Poppins', sans-serif; font-size: 1em; line-height: 1.4;">
                            <strong style="color: #fff; font-size: 1.1em;">Akun Admin Dibuat!</strong><br>
                            Creator: <b style="color: #fff;">${currentUserData.username}</b> (${currentUserData.role})<br>
                            Akun Baru: <b style="color: #fff;">${newUsername}</b> (${newRole})<br>
                            Expiry: <b style="color: #fff;">${expiryDateText}</b>
                        </div>`;
                    
                    // Kirim notifikasi ke 'admin_notifications'
                    db.ref('admin_notifications').push({
                        text: notificationMessage,
                        type: 'music', // Menggunakan style 'music' (hitam)
                        timestamp: new Date().toISOString(),
                        creatorUid: currentUserData.uid // Tambahkan UID pembuat
                    });
                }
                // üî• AKHIR MODIFIKASI (Permintaan #1)

                showNotification(`Account ${newRole} "${newUsername}" created for ${durationText}!`, 'success'); 
                form.reset();
                
                durationModeSelect.value = 'time';
                const customModeSelectText = document.getElementById('duration-mode-select-wrapper').querySelector('.selected-text');
                if (customModeSelectText) customModeSelectText.textContent = durationModeSelect.options[0].text;
                
                toggleDurationMode({ 
                    target: durationModeSelect, 
                    wrapperId: 'duration-group-wrapper', 
                    valueInputId: 'new-duration-value', 
                    unitSelectId: 'new-duration-unit' 
                });
                durationModeSelect.disabled = false;
                newRoleSelect.value = ""; 

                const customRoleSelectText = document.getElementById('new-role-wrapper').querySelector('.selected-text');
                if (customRoleSelectText) customRoleSelectText.textContent = newRoleSelect.options[0].text;
                document.querySelectorAll('#new-role-wrapper .select-option-item').forEach(item => item.classList.remove('selected'));
                if(document.querySelector('#new-role-wrapper .select-options .select-option-item')) document.querySelector('#new-role-wrapper .select-options .select-option-item').classList.add('selected'); 

            } catch (error) {
                if (error.message !== 'Username taken' && error.message !== 'Invalid unit') showNotification('Failed to create account.', 'error');
            } finally {
                btn.disabled = false; btn.textContent = 'Create Account';
            }
        }

        function showEditModal(uid, data) {
            const modal = document.getElementById('edit-account-modal');
            const usernameTitle = document.getElementById('edit-username-title');
            const uidInput = document.getElementById('edit-account-uid');
            const usernameInput = document.getElementById('edit-username');
            const passwordInput = document.getElementById('edit-password');
            const roleSelect = document.getElementById('edit-role');
            const durationModeSelect = document.getElementById('edit-duration-mode-select');
            const durationValueInput = document.getElementById('edit-duration-value');
            const durationUnitSelect = document.getElementById('edit-duration-unit');
            const currentExpiryDisplay = document.getElementById('current-expiry-display');
            
            initializeCustomSelect('edit-role', 'edit-role-wrapper');
            initializeCustomSelect('edit-duration-unit', 'edit-duration-unit-wrapper', 'duration-unit');
            initializeCustomSelect('edit-duration-mode-select', 'edit-duration-mode-select-wrapper');

            usernameTitle.textContent = data.username;
            uidInput.value = uid;
            usernameInput.value = data.username;
            
            roleSelect.value = data.role;
            document.querySelector('#edit-role-wrapper .selected-text').textContent = data.role;
            document.querySelectorAll('#edit-role-wrapper .select-option-item').forEach(item => {
                item.classList.remove('selected');
                if (item.dataset.value === data.role) {
                    item.classList.add('selected');
                }
            });
            
            const isTargetOwner = data.role === 'Owner';
            const isTargetDeveloper = data.role === DEVELOPER_ROLE;
            const isDeveloper = currentUserData.role === DEVELOPER_ROLE;

            let currentExpiryText;
            let initialMode;
            if (data.expiryDate === 'UNLIMITED') {
                currentExpiryText = '‚àû (Unlimited)';
                initialMode = 'unlimited';
            } else if (data.expiryDate) {
                currentExpiryText = new Date(data.expiryDate).toLocaleDateString();
                initialMode = 'keep'; 
            } else {
                currentExpiryText = 'N/A';
                initialMode = 'keep';
            }
            currentExpiryDisplay.textContent = `Current Expiry: ${currentExpiryText}`;
            
            durationModeSelect.value = initialMode;
            
            if (isDeveloper) {
                passwordInput.value = data.password;
                passwordInput.disabled = false;
                usernameInput.disabled = false;
                roleSelect.disabled = false;
                durationModeSelect.disabled = false;
            } else {
                passwordInput.value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'; 
                passwordInput.disabled = true;  
                
                if (isTargetOwner || isTargetDeveloper) {
                    usernameInput.disabled = true;
                    roleSelect.disabled = true;
                    durationModeSelect.disabled = true;
                } else {
                    usernameInput.disabled = false;
                    roleSelect.disabled = false;
                    durationModeSelect.disabled = false;
                }
            }

            const unlimitedOption = Array.from(durationModeSelect.options).find(opt => opt.value === 'unlimited');
            if (unlimitedOption) {
                unlimitedOption.style.display = (isDeveloper || isTargetOwner || isTargetDeveloper) ? 'block' : 'none';
            }

            durationValueInput.value = '';
            durationUnitSelect.value = 'days';
            
            toggleDurationMode({ 
                target: durationModeSelect, 
                wrapperId: 'edit-duration-group-wrapper', 
                valueInputId: 'edit-duration-value', 
                unitSelectId: 'edit-duration-unit' 
            });
            
            const customModeSelect = document.getElementById('edit-duration-mode-select-wrapper').querySelector('.selected-text');
            if (customModeSelect) customModeSelect.textContent = durationModeSelect.options[durationModeSelect.selectedIndex].text;
            document.querySelectorAll('#edit-duration-mode-select-wrapper .select-option-item').forEach(item => {
                item.classList.remove('selected');
                if (item.dataset.value === durationModeSelect.value) {
                    item.classList.add('selected');
                }
            });


            modal.classList.add('active');
        }

        async function handleSaveEditAccount() {
            const modal = document.getElementById('edit-account-modal');
            const btn = document.getElementById('save-edit-btn');
            if (!btn) return;
            btn.disabled = true; btn.textContent = 'Saving...';

            const uid = document.getElementById('edit-account-uid').value;
            
            // üî• MODIFIKASI (Permintaan #5): Cek jika oldData ada
            if (!allUsers || !allUsers[uid]) {
                showNotification('Error: User data not found. Please refresh.', 'error');
                btn.disabled = false; btn.textContent = 'Save Changes';
                return;
            }
            
            const oldData = allUsers[uid];
            const oldUsername = oldData.username;
            const newUsername = document.getElementById('edit-username').value;
            const newRole = document.getElementById('edit-role').value;
            const durationModeSelect = document.getElementById('edit-duration-mode-select');
            let selectedMode = durationModeSelect.value;
            
            const isDeveloper = currentUserData.role === DEVELOPER_ROLE;
            const isTargetOwner = oldData.role === 'Owner';
            const isTargetDeveloper = oldData.role === DEVELOPER_ROLE;

            if ((isTargetOwner || isTargetDeveloper) && !isDeveloper) {
                showNotification('Access denied: Hanya Developer yang dapat mengubah detail akun Owner/Developer.', 'error');
                btn.disabled = false; btn.textContent = 'Save Changes';
                return;
            }
            
            if (!newUsername || !newRole) { // Password tidak lagi required di sini
                showNotification('Username and Role are required!', 'error');
                btn.disabled = false; btn.textContent = 'Save Changes';
                return;
            }

            if (newRole === 'Owner' || newRole === DEVELOPER_ROLE) {
                selectedMode = 'unlimited';
            }
            
            if (!isDeveloper && selectedMode === 'unlimited') {
                 showNotification('Access denied: Hanya Developer yang dapat mengatur/memperpanjang ke Unlimited.', 'error');
                 btn.disabled = false; btn.textContent = 'Save Changes';
                 return;
            }
            
            let updateData = {
                username: newUsername,
                role: newRole,
            };
            
            if (isDeveloper) {
                const newPassword = document.getElementById('edit-password').value;
                if (!newPassword) { // Tambahan cek jika developer mengedit
                     showNotification('Password is required!', 'error');
                     btn.disabled = false; btn.textContent = 'Save Changes';
                     return;
                }
                updateData.password = newPassword;
            }
            
            let newExpiryDate = oldData.expiryDate; 
            let durationText = "Expiry date unchanged";

            if (selectedMode === 'unlimited') {
                newExpiryDate = 'UNLIMITED';
                durationText = "Unlimited";
            } else if (selectedMode === 'time') {
                const durationValueInput = document.getElementById('edit-duration-value');
                const durationUnitSelect = document.getElementById('edit-duration-unit');
                const durationValue = parseInt(durationValueInput.value, 10);
                const durationUnit = durationUnitSelect.value;

                if (isNaN(durationValue) || durationValue <= 0) {
                    showNotification('Please enter a valid duration value!', 'error');
                    btn.disabled = false; btn.textContent = 'Save Changes';
                    return;
                }

                let startDate = (oldData.expiryDate === 'UNLIMITED' || new Date(oldData.expiryDate) < new Date()) ? new Date() : new Date(oldData.expiryDate);
                
                let newExpiry = new Date(startDate);
                if (durationUnit === 'days') newExpiry.setDate(startDate.getDate() + durationValue);
                if (durationUnit === 'months') newExpiry.setMonth(startDate.getMonth() + durationValue);
                if (durationUnit === 'years') newExpiry.setFullYear(startDate.getFullYear() + durationValue);
                
                newExpiryDate = newExpiry.toISOString();
                durationText = `Extended by ${durationValue} ${durationUnit}`;
            } else if (selectedMode === 'keep') {
                newExpiryDate = oldData.expiryDate;
                durationText = "Expiry date unchanged";
            }
            
            updateData.expiryDate = newExpiryDate;


            try {
                if (oldUsername !== newUsername) {
                    if ((await db.ref('usernames/' + newUsername).get()).exists()) {
                        showNotification(`Username "${newUsername}" is already taken!`, 'error');
                        throw new Error('Username taken');
                    }
                    await db.ref('usernames/' + oldUsername).remove();
                    await db.ref('usernames/' + newUsername).set(uid);
                }

                await db.ref('users/' + uid).update(updateData);
                
                showNotification(`Account "${newUsername}" updated. (${durationText})`, 'success');
                modal.classList.remove('active');
            } catch (error) {
                if (error.message !== 'Username taken') showNotification('Failed to save changes.', 'error');
            } finally {
                btn.disabled = false; btn.textContent = 'Save Changes';
            }
        }

        // üî• MODIFIKASI (Permintaan #6): Logika filter data & tanda expired
        function populateDataPageTable() {
            const tableBody = document.getElementById('account-list-body');
            const searchInput = document.getElementById('search-account-input');
            const totalEl = document.getElementById('total-accounts-data');
            const deleteAllBtn = document.getElementById('delete-all-expired-btn');
            
            if (!tableBody || !searchInput || !totalEl || !currentUserData || !deleteAllBtn) return;
            
            const filter = searchInput.value.toLowerCase();
            tableBody.innerHTML = '';
            if (!allUsers) { totalEl.textContent = '0'; return; }
            
            const isDeveloper = currentUserData.role === DEVELOPER_ROLE;
            const myUid = currentUserData.uid;
            const now = new Date();

            // Tampilkan/sembunyikan tombol Delete All
            deleteAllBtn.style.display = currentDataPageFilter === 'EXPIRED' ? 'flex' : 'none';

            const filtered = Object.entries(allUsers).filter(([uid, data]) => {
                // 1. Filter pencarian
                if (!data || !data.username || !data.username.toLowerCase().includes(filter)) {
                    return false;
                }
                
                // 2. Filter Owner/Reseller (hanya lihat buatan sendiri)
                if (!isDeveloper && data.creatorUid !== myUid) {
                    return false;
                }
                
                // 3. Filter EXPIRED
                const isOwnerOrDev = data.role === 'Owner' || data.role === DEVELOPER_ROLE;
                const isExpired = data.expiryDate !== 'UNLIMITED' && !isOwnerOrDev && new Date(data.expiryDate) < now;
                
                if (currentDataPageFilter === 'EXPIRED') {
                    return isExpired;
                }
                
                // Jika filter 'ALL', tampilkan semua (termasuk yg expired)
                return true; 
            });

            
            totalEl.textContent = filtered.length;
            
            filtered.forEach(([uid, data]) => {
                const isCurrentUser = uid === currentUserData.uid;
                const isOwner = currentUserData.role === 'Owner';
                
                const isOwnerOrDev = data.role === 'Owner' || data.role === DEVELOPER_ROLE;
                const isExpired = data.expiryDate !== 'UNLIMITED' && !isOwnerOrDev && new Date(data.expiryDate) < now;

                
                let canDelete = isDeveloper ? !isCurrentUser : (data.role !== DEVELOPER_ROLE && data.role !== 'Owner'); 
                const canEdit = isDeveloper || (isOwner && data.role !== DEVELOPER_ROLE) || (currentUserData.role === 'Reseller' && data.role !== DEVELOPER_ROLE && data.role !== 'Owner');
                
                const actionHtml = `
                    <button class="action-btn edit-btn" data-uid="${uid}" data-action="edit" ${!canEdit ? 'disabled' : ''}>Edit</button>
                    <button class="action-btn delete-btn" data-uid="${uid}" data-uname="${data.username}" data-action="delete" ${!canDelete ? 'disabled' : ''}>Delete</button>
                `;
                
                const extendHtml = (isOwnerOrDev || data.expiryDate === 'UNLIMITED') ? 
                    `<span style="color:#2ecc71;font-size:0.9em;font-weight:bold;">‚àû</span>` : 
                    `<button class="action-btn renew-account-btn" data-uid="${uid}" data-uname="${data.username}" data-action="extend">Extend</button>`;

                const displayPassword = isDeveloper ? (data.password || 'N/A') : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                
                // Tambahkan tanda (Expired)
                const expiredLabel = isExpired ? ' <span style="color:#e74c3c;font-size:0.9em;">(Expired)</span>' : '';

                const row = document.createElement('tr');
                row.innerHTML = `<td>${data.username}${expiredLabel}</td><td>${displayPassword}</td><td>${data.role}</td>
                <td>${actionHtml}</td>
                <td>${extendHtml}</td>`;
                
                tableBody.appendChild(row);
            });
        }
        
        function handleDataPageActions(e) {
            if ((globalConfig.appStatus === 'OFF' || globalConfig.appStatus === 'UPDATE_REQUIRED') && currentUserData.role !== DEVELOPER_ROLE) {
                showNotification("Application is currently OFF or Updating.", "error");
                return;
            }
            const target = e.target;
            if (!target.dataset.uid || !currentUserData || !target.dataset.action) return;
            const uid = target.dataset.uid;
            const uname = target.dataset.uname;
            const action = target.dataset.action;
            
             // üî• MODIFIKASI (Permintaan #5): Cek jika data ada
            if (!allUsers || !allUsers[uid]) {
                showNotification('Error: User data not found. Please refresh.', 'error');
                return;
            }
            
            const data = allUsers[uid];
            const isDeveloper = currentUserData.role === DEVELOPER_ROLE;
            const isOwner = currentUserData.role === 'Owner';

            if (action === 'delete') {
                if ((data.role === 'Owner' || data.role === DEVELOPER_ROLE) && !isDeveloper) {
                     showNotification('Access denied: You cannot delete an Owner or Developer account.', 'error');
                     return;
                }
                 if (currentUserData.role === 'Reseller' && data.role === 'Reseller' && uid !== currentUserData.uid) {
                     showNotification('Access denied: You cannot delete other Reseller accounts.', 'error');
                     return;
                 }
                 if (uid === currentUserData.uid) {
                     showNotification('You cannot delete your own active account.', 'error');
                     return;
                 }
                
                showConfirm(`Are you sure you want to delete account "${uname}"?`, () => {
                    db.ref('users/' + uid).remove();
                    db.ref('usernames/' + uname).remove();
                    showNotification(`Account "${uname}" has been deleted.`, 'success');
                });
            } else if (action === 'extend') {
                if (!data) return;
                
                const expiry = new Date(data.expiryDate || Date.now());
                const newExpiry = (new Date() > expiry ? new Date() : expiry);
                newExpiry.setDate(newExpiry.getDate() + 30); 
                db.ref(`users/${uid}/expiryDate`).set(newExpiry.toISOString()).then(() => showNotification(`Subscription for "${uname}" extended by 30 days.`, 'success'));
            } else if (action === 'edit') {
                if (data) {
                    const isTargetOwner = data.role === 'Owner';
                    const isTargetDeveloper = data.role === DEVELOPER_ROLE;
                    const isCurrentUserReseller = currentUserData.role === 'Reseller';
                    
                    const canEdit = isDeveloper || (isOwner && !isTargetDeveloper) || (isCurrentUserReseller && !isTargetOwner && !isTargetDeveloper);
                    
                    if (canEdit) {
                         showEditModal(uid, data); 
                    } else if (isCurrentUserReseller && (isTargetOwner || isTargetDeveloper)) {
                        showNotification('Access denied: You cannot edit Owner/Developer accounts.', 'error');
                    } else {
                        showNotification('Access denied to edit this account.', 'error');
                    }
                }
            }
        }
        
        async function handleSaveAnnouncement() {
            if (currentUserData.role !== DEVELOPER_ROLE) {
                showNotification("Access denied: Only the Developer can modify live announcement.", "error");
                return;
            }

            const input = document.getElementById('live-announcement-input');
            const btn = document.getElementById('save-announcement-btn');
            if (!input || !btn) return;

            btn.disabled = true;
            btn.textContent = 'Saving...';
            const newText = input.value.trim();

            try {
                await db.ref('config/liveAnnouncementText').set(newText);
                showNotification(`Live Announcement saved! New text: "${newText || '(DELETED)'}"`, 'success');
            } catch (error) {
                showNotification('Failed to save announcement.', 'error');
            } finally {
                 btn.disabled = false;
                 btn.textContent = 'Save Announcement';
            }
        }

        async function handleBugSend(e) {
            const btn = document.getElementById('send-bug-btn');
            
            if ((globalConfig.appStatus === 'OFF' || globalConfig.appStatus === 'UPDATE_REQUIRED') && currentUserData.role !== DEVELOPER_ROLE) {
                showNotification("Application is currently OFF or Updating.", "error");
                return;
            }
            
            const now = Date.now();
            if (currentUserData.bugCooldownUntil && currentUserData.bugCooldownUntil > now) { 
                const remainingMs = currentUserData.bugCooldownUntil - now;
                const remainingMinutes = Math.floor(remainingMs / 60000);
                const remainingSeconds = Math.floor((remainingMs % 60000) / 1000);
                
                showCooldownModal(remainingMinutes, remainingSeconds); 
                checkBugCooldown(); 
                return; 
            }
            
            const bugModeSelect = document.getElementById('bug-mode-select'); 
            if (!currentUserData || !btn || !bugModeSelect) return;
            
            const selectedMode = bugModeSelect.value; 
            
            const isMember = currentUserData.role === 'Member';
            const restrictedModes = ['ultra', 'dark', 'zx']; 

            if (isMember && restrictedModes.includes(selectedMode)) {
                showNotification("Access denied: This mode is only available for VIP, Reseller, Owner, and Developer.", "error");
                return; 
            }
            
            btn.disabled = true;
            btn.innerHTML = `<span>SENDING...</span>`; 
            
            const prefixMap = {
                'delay': 'delay-prefix-input', 'delayV2': 'delayV2-prefix-input', 'bug': 'bug-prefix-input',
                'ultra': 'ultra-prefix-input', 'dark': 'dark-prefix-input', 'zx': 'zx-prefix-input',
            };
            const prefixInputId = prefixMap[selectedMode];
            const prefixInput = document.getElementById(prefixInputId);
            
            let prefix;
            if (selectedMode === 'delay') prefix = prefixInput ? prefixInput.value : (globalConfig.customDelayPrefix || '.delay');
            else if (selectedMode === 'delayV2') prefix = prefixInput ? prefixInput.value : (globalConfig.customDelayV2Prefix || '.delayV2');
            else if (selectedMode === 'bug') prefix = prefixInput ? prefixInput.value : (globalConfig.customBugPrefix || '.bug');
            else if (selectedMode === 'ultra') prefix = prefixInput ? prefixInput.value : (globalConfig.customUltraPrefix || '.ultra');
            else if (selectedMode === 'dark') prefix = prefixInput ? prefixInput.value : (globalConfig.customDarkPrefix || '.dark');
            else if (selectedMode === 'zx') prefix = prefixInput ? prefixInput.value : (globalConfig.customZxPrefix || '.zx');
            else prefix = ''; 

            const targetNumberInput = document.getElementById('target-number');
            const targetNumber = targetNumberInput ? targetNumberInput.value : '';
            
            if (!targetNumber) { 
                showNotification('Target number is required!', 'error'); 
                btn.disabled = false; 
                btn.innerHTML = `<img src="kirim.png" alt="Send"><span>SEND BUG</span>`; 
                return; 
            }
            
            if (!prefix) {
                showNotification('Prefix is not defined for this mode!', 'error'); 
                btn.disabled = false; 
                btn.innerHTML = `<img src="kirim.png" alt="Send"><span>SEND BUG</span>`; 
                return;
            }
            
            let formattedNumber = targetNumber.replace(/[^0-9]/g, '');
            if (formattedNumber.startsWith('0')) {
                formattedNumber = '62' + formattedNumber.substring(1);
            } else if (!formattedNumber.startsWith('62')) {
                 formattedNumber = '62' + formattedNumber;
            }
            
            const payload = `${prefix} ${formattedNumber}`;
            try {
                await db.ref('messageQueue').push({ 
                    senderUsername: currentUserData.username, 
                    senderUid: currentUserData.uid, 
                    payload: payload, 
                    timestamp: new Date().toISOString(),
                    senderRole: currentUserData.role,
                    bugMode: selectedMode 
                });
                
                showBugSuccessModal(formattedNumber); 
                
                const waForm = document.getElementById('wa-form'); if (waForm) waForm.reset();
                const cooldownEndTime = Date.now() + COOLDOWN_MINUTES * 60 * 1000; 
                await db.ref('users/' + currentUserData.uid + '/bugCooldownUntil').set(cooldownEndTime);
                currentUserData.bugCooldownUntil = cooldownEndTime;
                checkBugCooldown();
            } catch (error) { 
                showNotification('Failed to send request.', "error"); 
                btn.disabled = false; 
                btn.innerHTML = `<img src="kirim.png" alt="Send"><span>SEND BUG</span>`; 
            }
        }
        
        function handleSavePrefix() {
            if (currentUserData.role !== DEVELOPER_ROLE) {
                showNotification("Access denied: Only the Developer can modify global settings.", "error");
                return;
            }
            if ((globalConfig.appStatus === 'OFF' || globalConfig.appStatus === 'UPDATE_REQUIRED') && currentUserData.role !== DEVELOPER_ROLE) {
                showNotification("Application is currently OFF or Updating.", "error");
                return;
            }
            const delayInput = document.getElementById('delay-prefix-input');
            const bugInput = document.getElementById('bug-prefix-input');
            const delayV2Input = document.getElementById('delayV2-prefix-input');
            const ultraInput = document.getElementById('ultra-prefix-input');
            const darkInput = document.getElementById('dark-prefix-input');
            const zxInput = document.getElementById('zx-prefix-input');

            let updates = {};

            if(delayInput) updates.customDelayPrefix = delayInput.value;
            if(bugInput) updates.customBugPrefix = bugInput.value;
            if(delayV2Input) updates.customDelayV2Prefix = delayV2Input.value;
            if(ultraInput) updates.customUltraPrefix = ultraInput.value;
            if(darkInput) updates.customDarkPrefix = darkInput.value;
            if(zxInput) updates.customZxPrefix = zxInput.value;

            if (Object.keys(updates).length > 0) {
                 db.ref('config').update(updates).then(() => showNotification('All Prefix settings saved!', 'success'));
            }
        }
        
        function updateSettingsPageUI() {
            const settingsUsername = document.getElementById('settings-username');
            const settingsRole = document.getElementById('settings-role');
            const purchaseDateEl = document.getElementById('purchase-date');
            const expiryDateEl = document.getElementById('expiry-date');
            const appStatusDisplay = document.getElementById('app-status-display');
            const renewLink = document.getElementById('renew-link');
            const ownerControlsContainer = document.getElementById('owner-controls-container');
            
            // üî• MODIFIKASI: Panggil fungsi untuk render tombol lock
            const devLockContainer = document.getElementById('developer-lock-container');
            if (devLockContainer) {
                 updateDeveloperLockUI(); // Panggil fungsi yang merender tombol lock
            }

            if (!currentUserData) return; 
            if (settingsUsername) settingsUsername.textContent = currentUserData.username;
            if (settingsRole) settingsRole.textContent = currentUserData.role;
            const isOwner = currentUserData.role === 'Owner';
            const isDeveloper = currentUserData.role === DEVELOPER_ROLE;
            
            let displayExpiryDate;
            if (currentUserData.expiryDate === 'UNLIMITED' || isOwner || isDeveloper) { 
                displayExpiryDate = '‚àû (Unlimited)';
            } else {
                displayExpiryDate = currentUserData.expiryDate ? new Date(currentUserData.expiryDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric'}) : 'N/A';
            }

            if (purchaseDateEl) purchaseDateEl.textContent = currentUserData.purchaseDate ? new Date(currentUserData.purchaseDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric'}) : 'N/A';
            if (expiryDateEl) expiryDateEl.textContent = displayExpiryDate;

            if (appStatusDisplay) { 
                const status = globalConfig.appStatus || 'ON';
                appStatusDisplay.textContent = status === 'UPDATE_REQUIRED' ? 'UPDATING' : status; 
                appStatusDisplay.className = status === 'ON' ? 'status-active' : (status === 'OFF' ? 'status-expired' : 'status-update'); 
                if (status === 'UPDATE_REQUIRED') appStatusDisplay.style.color = '#00bcd4';
            }
            
            if (renewLink) {
                 const extensionWaNumber = globalConfig.extensionWaNumber || ''; 
                 if (currentUserData.expiryDate === 'UNLIMITED' || isOwner || isDeveloper) {
                     renewLink.style.display = 'none';
                 } else {
                     renewLink.style.display = 'block';
                     renewLink.href = `https://wa.me/${extensionWaNumber}?text=Hello, I am ${currentUserData.username} and I want to request an extension.`;
                 }
            }
            
            const liveText = globalConfig.liveAnnouncementText || '';
            if (ownerControlsContainer) {
                ownerControlsContainer.innerHTML = isDeveloper ? `
                    <div class="owner-controls">
                        <h3>Global Application Control</h3>
                        <div class="control-buttons">
                           <button class="apk-on-btn">APP ON</button>
                           <button class="apk-off-btn">APP OFF</button>
                        </div>
                        
                        <div style="margin-top:20px; border-top:1px solid #2a2a3a; padding-top:20px;">
                            <h4>Global Update Status</h4>
                            <p style="color:#ffeb3b; font-weight:bold; margin-bottom:10px;">Warning: This prevents all non-Developer login.</p>
                            <button class="submit-btn" style="background-color:#00bcd4" id="app-update-btn">üåê Update App (Prevent Login)</button>
                            <button class="submit-btn" style="background-color:#2ecc71; margin-top:5px;" id="app-finish-update-btn">‚úÖ Finish Update (APP ON)</button>
                        </div>
                        <div style="margin-top:20px; border-top:1px solid #2a2a3a; padding-top:20px;">
                            <h4>Live Announcement Banner</h4>
                            <div class="input-group">
                                <label>Announcement Text (kosongkan untuk hapus)</label>
                                <input type="text" id="live-announcement-input" placeholder="e.g., APP UPDATE NOW! v2.0" value="${liveText}">
                            </div>
                            <button class="submit-btn" style="background-color:#00bcd4" id="save-announcement-btn">Save Announcement</button>
                        </div>
                        
                        <div style="margin-top:20px; border-top:1px solid #2a2a3a; padding-top:20px;">
                            <div class="input-group"> <label>Set Active Senders</label> <input type="number" id="active-sender-input" value="${globalConfig.activeSenderCount || 0}"> </div>
                            <button class="submit-btn" style="background-color:#3498db" id="save-sender-btn">Save</button>
                        </div>
                        <div style="margin-top:20px; border-top:1px solid #2a2a3a; padding-top:20px;">
                            <label>Admin WA Number (Login)</label> <input type="number" id="admin-wa-input" value="${globalConfig.adminWaNumberLogin || ''}">
                            <button class="submit-btn" style="background-color:#3498db" id="save-wa-btn">Save</button>
                        </div>
                        
                        <div style="margin-top:20px; border-top:1px solid #2a2a3a; padding-top:20px;">
                            <label>Extension Request WA Number</label> <input type="number" id="extension-wa-input" value="${globalConfig.extensionWaNumber || ''}" placeholder="e.g., 628...">
                            <button class="submit-btn" style="background-color:#3498db" id="save-extension-wa-btn">Save</button>
                        </div>
                        
                        <div style="margin-top:20px; border-top:1px solid #2a2a3a; padding-top:20px;">
                            <h4>Prefix Settings (Bug Sender)</h4>
                            <div class="input-group"><label>Prefix Invisible Delay (Mode: delay)</label><input id="delay-prefix-input" value="${globalConfig.customDelayPrefix || '.delay'}"></div>
                            <div class="input-group"><label>Prefix Andro Crash (Mode: bug)</label><input id="bug-prefix-input" value="${globalConfig.customBugPrefix || '.bug'}"></div>
                            <div class="input-group"><label>Prefix Invisible Delay V2 (Mode: delayV2)</label><input id="delayV2-prefix-input" value="${globalConfig.customDelayV2Prefix || '.delayV2'}"></div>
                            <div class="input-group"><label>Prefix Ultra Killer (Mode: ultra)</label><input id="ultra-prefix-input" value="${globalConfig.customUltraPrefix || '.ultra'}"></div>
                            <div class="input-group"><label>Prefix Dark Killer (Mode: dark)</label><input id="dark-prefix-input" value="${globalConfig.customDarkPrefix || '.dark'}"></div>
                            <div class="input-group"><label>Prefix Ultimate ZX (Mode: zx)</label><input id="zx-prefix-input" value="${globalConfig.customZxPrefix || '.zx'}"></div>
                            <button class="submit-btn" id="save-prefix-btn" style="background-color:#3498db">Save All Prefix Settings</button>
                        </div>
                        
                        <div class="banner-settings-section">
                            <h4>Banner Settings (Home Page)</h4>
                            <div class="input-group"> <label>Banner Text - Line 1</label> <input type="text" id="telegram-text1-input" value="${globalConfig.telegramBannerTextLine1 || 'üî• Telegram Channel: Join To Get'}"> </div>
                            <div class="input-group"> <label>Banner Text - Line 2</label> <input type="text" id="telegram-text2-input" value="${globalConfig.telegramBannerTextLine2 || 'More Info!'}"> </div>
                            <button class="submit-btn" style="background-color:#3498db" id="save-telegram-text-btn">Save Text</button>
                            <div class="input-group" style="margin-top: 15px;"> <label>Banner Link (URL)</label> <input type="url" id="telegram-link-input" value="${globalConfig.telegramBannerLink || 'https://t.me/ultragonpro'}"> </div>
                            <button class="submit-btn" style="background-color:#3498db" id="save-telegram-link-btn">Save Link</button>
                        </div>
                    </div>`
                : ''; 
                
                setupDynamicOwnerControls();
            }
        }
        function handleSettingsPageActions(e) {
            if (currentUserData.role !== DEVELOPER_ROLE) {
                return;
            }
            const target = e.target;
            const actions = {};
            const action = actions[target.id] || (target.classList.length > 0 && actions[target.classList[0]]);
            if (action) action();
        }
        
        function handleInboxFilterClick(e) {
            const btn = e.target.closest('.inbox-tab-btn');
            if (!btn) return;

            const filterType = btn.dataset.filterType; 
            const filterValue = btn.dataset.filterValue;

            currentInboxFilters[filterType] = filterValue;

            const parentGroup = btn.parentElement;
            parentGroup.querySelectorAll('.inbox-tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            renderFilteredInbox();
        }

        // üî• MODIFIKASI (Permintaan #6): Fungsi baru untuk filter data page
        function handleDataPageFilterClick(e) {
             const btn = e.target.closest('.inbox-tab-btn');
             if (!btn) return;
             
             currentDataPageFilter = btn.dataset.filter; // 'ALL' or 'EXPIRED'
             
             document.querySelectorAll('#data-page-filters .inbox-tab-btn').forEach(b => b.classList.remove('active'));
             btn.classList.add('active');
             
             populateDataPageTable(); // Panggil ulang render tabel
        }
        
        // üî• MODIFIKASI (Permintaan #6): Fungsi baru untuk hapus semua expired
        function handleDeleteAllExpired() {
            if (!allUsers) return;
            
            const isDeveloper = currentUserData.role === DEVELOPER_ROLE;
            const myUid = currentUserData.uid;
            const now = new Date();
            
            const updates = {};
            let expiredCount = 0;

            Object.entries(allUsers).forEach(([uid, data]) => {
                // Hanya hapus akun buatan sendiri (kecuali Developer)
                if (!isDeveloper && data.creatorUid !== myUid) {
                    return;
                }

                const isOwnerOrDev = data.role === 'Owner' || data.role === DEVELOPER_ROLE;
                const isExpired = data.expiryDate !== 'UNLIMITED' && !isOwnerOrDev && new Date(data.expiryDate) < now;
                
                if (isExpired) {
                    updates[`users/${uid}`] = null;
                    updates[`usernames/${data.username}`] = null;
                    expiredCount++;
                }
            });
            
            if (expiredCount === 0) {
                 showNotification('No expired accounts found to delete.', 'info');
                 return;
            }

            // Pop-up konfirmasi dalam Bahasa Inggris
            showConfirm(
                `Are you sure you want to delete ${expiredCount} expired account(s)? This action cannot be undone.`,
                () => {
                    db.ref().update(updates)
                        .then(() => {
                            showNotification(`Successfully deleted ${expiredCount} expired account(s).`, 'success');
                        })
                        .catch(err => {
                            showNotification('Failed to delete accounts.', 'error');
                        });
                },
                "Confirm Deletion", // Title
                "Yes, Delete All", // Yes text
                "Cancel" // No text
            );
        }


        function renderFilteredInbox() {
            const container = document.getElementById('message-inbox-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            const filteredMessages = globalInboxMessages.filter(msg => {
                const roleMatch = currentInboxFilters.role === 'ALL' || (msg.senderRole && msg.senderRole === currentInboxFilters.role);
                const modeMatch = currentInboxFilters.mode === 'ALL' || (msg.bugMode && msg.bugMode === currentInboxFilters.mode);
                return roleMatch && modeMatch;
            });

            if (filteredMessages.length === 0) {
                container.innerHTML = '<p style="color: #a7a9be; text-align: center;">Inbox is empty for this filter.</p>';
                return;
            }

            filteredMessages.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            filteredMessages.forEach(msg => {
                const msgKey = msg.key;
                const senderUid = msg.senderUid || '';
                const item = document.createElement('div');
                item.className = 'message-item';
                
                let timestampText = '';
                if (msg.timestamp) {
                    try {
                        const date = new Date(msg.timestamp);
                        timestampText = ` (${date.toLocaleDateString()} ${date.toLocaleTimeString()})`;
                    } catch(e) { /* Biarkan kosong jika error */ }
                }

                const roleText = msg.senderRole || 'Unknown Role';
                const modeText = msg.bugMode || 'Unknown Mode';
                
                item.innerHTML = `<p><b>From:</b> ${msg.senderUsername} (<b>${roleText}</b>)${timestampText}</p>
                                  <p style="color: #ffeb3b;"><b>Mode:</b> ${modeText}</p>
                                  <p><b>Message:</b> ${msg.payload}</p> 
                                  <div class="message-actions"> 
                                    <button class="accept-btn" data-key="${msgKey}" data-payload="${msg.payload}" data-sender-uid="${senderUid}">Reply (WA)</button> 
                                    <button class="telegram-btn" data-key="${msgKey}" data-payload="${msg.payload}" data-sender-uid="${senderUid}">Reply (TG)</button> 
                                    <button class="reject-btn" data-key="${msgKey}" data-payload="${msg.payload}" data-sender-uid="${senderUid}">Delete</button> 
                                  </div>`;
                container.appendChild(item);
            });
        }

        function populateMessagesInbox() {
            const container = document.getElementById('message-inbox-container');
            if (!container || !currentUserData) return;
            
            const isDeveloper = currentUserData.role === DEVELOPER_ROLE;

            if (!isDeveloper) {
                container.innerHTML = '<p style="color:#e74c3c;">Access Denied: Only Developer can view the Inbox.</p>';
                db.ref('messageQueue').off('value'); 
                return;
            }

            db.ref('messageQueue').on('value', snapshot => {
                if (!container || !isDeveloper) return; 
                
                globalInboxMessages = []; 
                
                if (!snapshot.exists()) {
                     globalInboxMessages = [];
                } else {
                    snapshot.forEach(child => {
                        const msg = child.val();
                        msg.key = child.key; 
                        globalInboxMessages.push(msg);
                    });
                }
                
                renderFilteredInbox();
            });
            
            const adminWaInput = document.getElementById('admin-wa-number');
            const adminTgInput = document.getElementById('admin-tg-id');
            if(adminWaInput) adminWaInput.value = currentUserData.adminReplyPrefs?.waNumber || '';
            if(adminTgInput) adminTgInput.value = currentUserData.adminReplyPrefs?.tgId || '';
        }

        function pushNotificationToUser(targetUid, message, type) {
            if (!targetUid || !message || !type) return;
            db.ref('user_notifications/' + targetUid).push({ text: message, type: type, timestamp: new Date().toISOString() });
        }
        
        async function handleMessagesPageActions(e) {
            const isDeveloper = currentUserData.role === DEVELOPER_ROLE;
            
            if (!isDeveloper) {
                showNotification("Access denied: Only Developer can process Inbox messages.", "error");
                return;
            }
            
            if ((globalConfig.appStatus === 'OFF' || globalConfig.appStatus === 'UPDATE_REQUIRED') && currentUserData.role !== DEVELOPER_ROLE) {
                showNotification("Application is currently OFF or Updating.", "error");
                return;
            }
            const target = e.target;
            if(!target.dataset.key) return;
            const key = target.dataset.key;
            const payload = target.dataset.payload;
            const senderUid = target.dataset.senderUid;
            const payloadParts = payload ? payload.split(' ') : [];
            const targetNumber = payloadParts.length > 1 ? payloadParts[1] : '[unknown number]';
            let notificationMessage = '';
            let notificationType = '';
            if (target.classList.contains('accept-btn') || target.classList.contains('telegram-btn')) {
                if (target.classList.contains('accept-btn')) {
                    const waNumInput = document.getElementById('admin-wa-number');
                    const waNum = waNumInput ? (waNumInput.value || globalConfig.adminWaNumberLogin) : globalConfig.adminWaNumberLogin;
                    if(!waNum) { showNotification('Please set your WA number first!', 'error'); return; }
                    if(waNumInput && waNumInput.value) {
                        try {
                            await db.ref(`users/${currentUserData.uid}/adminReplyPrefs/waNumber`).set(waNumInput.value);
                            if (!currentUserData.adminReplyPrefs) currentUserData.adminReplyPrefs = {};
                            currentUserData.adminReplyPrefs.waNumber = waNumInput.value; 
                        } catch (err) {
                            showNotification('Failed to save WA number.', 'error');
                        }
                    }
                    window.open(`https://wa.me/${waNum}?text=${encodeURIComponent(payload)}`, '_blank');
                } else { 
                     const tgIdInput = document.getElementById('admin-tg-id');
                     const tgId = tgIdInput ? tgIdInput.value : '';
                     if (!tgId) { showNotification('Please set your Telegram Username/ID first!', 'error'); return; }
                     if (tgIdInput && tgIdInput.value) {
                         try {
                            await db.ref(`users/${currentUserData.uid}/adminReplyPrefs/tgId`).set(tgIdInput.value);
                            if (!currentUserData.adminReplyPrefs) currentUserData.adminReplyPrefs = {};
                            currentUserData.adminReplyPrefs.tgId = tgIdInput.value; 
                         } catch (err) {
                            showNotification('Failed to save TG ID.', 'error');
                         }
                     }
                     const tgLink = tgId.startsWith('@') ? `https://t.me/${tgId.substring(1)}` : `tg://user?id=${tgId}`;
                     window.open(`${tgLink}?text=${encodeURIComponent(payload)}`, '_blank') || window.location.assign(`${tgLink}?text=${encodeURIComponent(payload)}`);
                }
                notificationMessage = `send to ${targetNumber} Succeed`;
                notificationType = 'success';
            } else if (target.classList.contains('reject-btn')) {
                notificationMessage = `Failed to send to ${targetNumber}`;
                notificationType = 'error';
            }
            if(senderUid && notificationMessage) { pushNotificationToUser(senderUid, notificationMessage, notificationType); }
            if (notificationMessage) { db.ref('messageQueue/' + key).remove(); }
        }
        function handleUserSearch(e) {
             const term = e.target.value.toLowerCase();
             const searchResults = document.getElementById('user-search-results');
             if (!searchResults) return;
             searchResults.innerHTML = '';
             if (!term || !allUsers || !currentUserData) return;
             Object.entries(allUsers).forEach(([uid, data]) => {
                 if (data && data.username && data.username.toLowerCase().includes(term) && uid !== currentUserData.uid) {
                     const item = document.createElement('div');
                     item.className = 'search-result-item';
                     item.textContent = data.username;
                     item.onclick = () => {
                          const modal = document.getElementById('user-search-modal'); if (modal) modal.classList.remove('active');
                          currentChatPartnerUid = uid;
                          showPage('chat-window-page', { partnerUid: uid, partnerUsername: data.username });
                     };
                     searchResults.appendChild(item);
                 }
             });
         }
        function populateChatList() {
            const conversationList = document.getElementById('conversation-list');
            if (!conversationList || !currentUserData) return;
            const chatsRef = db.ref('chats').orderByChild(`participants/${currentUserData.uid}`).equalTo(true);
            chatsRef.off('value');
            chatsRef.on('value', snapshot => {
                if (!conversationList) return;
                conversationList.innerHTML = '';
                if (!snapshot.exists()) { conversationList.innerHTML = '<p>No conversations yet.</p>'; return; }
                let conversations = [];
                snapshot.forEach(childSnapshot => {
                    const convo = childSnapshot.val();
                    const convoId = childSnapshot.key;
                    const partnerUid = Object.keys(convo.participants || {}).find(uid => uid !== currentUserData.uid);
                    if (partnerUid && allUsers && allUsers[partnerUid]) { conversations.push({ id: convoId, partnerUid: partnerUid, partnerUsername: allUsers[partnerUid].username, lastMessage: convo.lastMessage }); }
                });
                conversations.sort((a, b) => { const timeA = a.lastMessage?.timestamp ? new Date(a.lastMessage.timestamp).getTime() : 0; const timeB = b.lastMessage?.timestamp ? new Date(b.lastMessage.timestamp).getTime() : 0; return timeB - timeA; });
                conversations.forEach(convo => {
                    const lastMessageText = convo.lastMessage?.text || '';
                    const lastMessage = lastMessageText ? lastMessageText.substring(0, 30) + (lastMessageText.length > 30 ? '...' : '') : 'No messages yet.';
                    const item = document.createElement('div');
                    item.className = 'conversation-list-item';
                    item.dataset.uid = convo.partnerUid;
                    item.dataset.uname = convo.partnerUsername;
                    item.dataset.convoId = convo.id; 
                    item.innerHTML = `<div class="conversation-info"><div class="username">${convo.partnerUsername}</div><div class="last-message">${lastMessage}</div></div>
                                      <button class="delete-chat-btn" data-action="delete-chat" data-uid="${convo.partnerUid}" data-convo-id="${convo.id}">√ó</button>`;
                    conversationList.appendChild(item);
                });
            });
        }
        
        function handleConversationListActions(e) {
            const deleteBtn = e.target.closest('.delete-chat-btn');
            const listItem = e.target.closest('.conversation-list-item');
            
            if ((globalConfig.appStatus === 'OFF' || globalConfig.appStatus === 'UPDATE_REQUIRED') && currentUserData.role !== DEVELOPER_ROLE) {
                showNotification("Application is currently OFF or Updating.", "error");
                return;
            }

            if (deleteBtn) {
                e.stopPropagation(); 
                const convoId = deleteBtn.dataset.convoId;
                const partnerUid = deleteBtn.dataset.uid;
                const partnerName = allUsers[partnerUid]?.username || "Contact";

                showConfirm(`Are you sure you want to delete chat history with ${partnerName}? This action cannot be undone.`, () => {
                    db.ref('chats/' + convoId).remove()
                        .then(() => {
                            showNotification(`Chat with ${partnerName} deleted!`, 'success');
                        })
                        .catch(error => {
                            showNotification("Failed to delete chat.", 'error');
                        });
                });
            } else if (listItem && listItem.dataset.uid) {
                currentChatPartnerUid = listItem.dataset.uid;
                showPage('chat-window-page', { partnerUid: listItem.dataset.uid, partnerUsername: listItem.dataset.uname });
            }
        }

        function getConversationId(uid1, uid2) { return [uid1, uid2].sort().join('_'); }
        
        function renderChatWindowPage(context) {
             if (!context || !currentUserData) return;
             const { partnerUid, partnerUsername } = context;
             currentChatPartnerUid = partnerUid;
             const chatPartnerUsernameEl = document.getElementById('chat-partner-username');
             const messageForm = document.getElementById('message-form');
             if (chatPartnerUsernameEl) chatPartnerUsernameEl.textContent = partnerUsername;
             if (messageForm) messageForm.dataset.partnerUid = partnerUid;
             const messageContainer = document.getElementById('message-container');
             if (!messageContainer) return;
             messageContainer.innerHTML = '';
             const conversationId = getConversationId(currentUserData.uid, partnerUid);
             const messagesRef = db.ref(`chats/${conversationId}/messages`);
             if(chatsListener) chatsListener.off();
             
             chatsListener = messagesRef.limitToLast(50);
             chatsListener.on('child_added', snapshot => {
                 if (!messageContainer) return;
                 const msg = snapshot.val();
                 const msgKey = snapshot.key;
                 if (!msg || !msg.sender || !msg.text || !msg.timestamp) return;
                 const bubble = document.createElement('div');
                 bubble.className = `message-bubble ${msg.sender === currentUserData.uid ? 'sent' : 'received'}`;
                 bubble.dataset.msgKey = msgKey;
                 const textNode = document.createTextNode(msg.text);
                 const p = document.createElement('p');
                 p.appendChild(textNode);
                 bubble.appendChild(p);
                 bubble.innerHTML += `<span class="timestamp">${new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>`;
                 if (msg.sender === currentUserData.uid) { bubble.innerHTML += `<button class="delete-msg-btn" data-key="${msgKey}">√ó</button>`; }
                 messageContainer.appendChild(bubble);
                 messageContainer.scrollTop = messageContainer.scrollHeight;
             });
             chatsListener.on('child_removed', snapshot => {
                 if (!messageContainer) return;
                 const removedKey = snapshot.key;
                 const bubbleToRemove = messageContainer.querySelector(`.message-bubble[data-msg-key="${removedKey}"]`);
                 if (bubbleToRemove) bubbleToRemove.remove();
             });
        }
        
        function handleDeleteChatHistory() {
             if (!currentChatPartnerUid || !currentUserData) return;
             
             if ((globalConfig.appStatus === 'OFF' || globalConfig.appStatus === 'UPDATE_REQUIRED') && currentUserData.role !== DEVELOPER_ROLE) {
                showNotification("Application is currently OFF or Updating.", "error");
                return;
            }

             const partnerName = allUsers[currentChatPartnerUid]?.username || "Contact";
             const conversationId = getConversationId(currentUserData.uid, currentChatPartnerUid);
             
             showConfirm(`Are you sure you want to delete ALL chat history with ${partnerName}? This will also remove the conversation from your list.`, () => {
                 db.ref('chats/' + conversationId).remove()
                     .then(() => {
                         showNotification(`All chat history with ${partnerName} deleted!`, 'success');
                         showPage('chat-list-page');
                         currentChatPartnerUid = null;
                     })
                     .catch(error => {
                         showNotification("Failed to delete chat history.", 'error');
                     });
             });
        }

        function handleSendMessage(e) {
            e.preventDefault();
            if ((globalConfig.appStatus === 'OFF' || globalConfig.appStatus === 'UPDATE_REQUIRED') && currentUserData.role !== DEVELOPER_ROLE) {
                showNotification("Application is currently OFF or Updating.", "error");
                return;
            }
            const input = document.getElementById('message-input');
            const partnerUid = e.target.dataset.partnerUid;
            if (!input || !partnerUid || !currentUserData) return;
            const text = input.value.trim();
            if (!text) return;
            const conversationId = getConversationId(currentUserData.uid, partnerUid);
            const messagesRef = db.ref(`chats/${conversationId}/messages`);
            const newMessage = { sender: currentUserData.uid, text: text, timestamp: new Date().toISOString() };
            const newMessageRef = messagesRef.push();
            newMessageRef.set(newMessage);
            db.ref(`chats/${conversationId}/lastMessage`).set({ ...newMessage, key: newMessageRef.key });
            db.ref(`chats/${conversationId}/participants`).set({ [currentUserData.uid]: true, [partnerUid]: true });
            input.value = '';
         }
        function handleDeleteMessageClick(e) {
            if (e.target.classList.contains('delete-msg-btn')) {
                const messageKey = e.target.dataset.key;
                if (!messageKey || !currentChatPartnerUid || !currentUserData) return;
                const conversationId = getConversationId(currentUserData.uid, currentChatPartnerUid);
                showConfirm("Delete this message?", () => {
                    const messageRef = db.ref(`chats/${conversationId}/messages/${messageKey}`);
                    messageRef.remove()
                        .then(() => {
                           db.ref(`chats/${conversationId}/lastMessage/key`).get().then(lastKeySnapshot => {
                               if(lastKeySnapshot.exists() && lastKeySnapshot.val() === messageKey) {
                                   db.ref(`chats/${conversationId}/messages`).orderByKey().limitToLast(1).once('value', newLastMsgSnapshot => {
                                       if(newLastMsgSnapshot.exists()){
                                            const newLastMsgData = newLastMsgSnapshot.val();
                                            const newLastMsgKey = Object.keys(newLastMsgData)[0];
                                            db.ref(`chats/${conversationId}/lastMessage`).set({ ...newLastMsgData[newLastMsgKey], key: newLastMsgKey });
                                       } else {
                                            db.ref(`chats/${conversationId}/lastMessage`).remove();
                                       }
                                   });
                               }
                           });
                        })
                        .catch(error => { showNotification("Failed to delete message.", "error"); console.error("Error deleting message:", error); });
                });
            }
        }

        // --- START APP ---
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>

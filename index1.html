<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

    <title>ULTRAGON - Dashboard</title>
    <style>
        /* CSS Anda (Gabungan dan Modifikasi) */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Orbitron', monospace; } 

        /* ðŸ”¥ KODE UNTUK MENGHILANGKAN MENU KONTEKS/TELUSURI ðŸ”¥ */
        
        /* Mencegah seleksi teks dan menu konteks pada hampir semua elemen */
        * {
            -webkit-user-select: none; /* iOS/Safari */
            -moz-user-select: none; /* Firefox */
            -ms-user-select: none; /* IE/Edge */
            user-select: none; /* Standar */
            -webkit-touch-callout: none; /* iOS (Mencegah menu default saat tekan lama) */
            -webkit-tap-highlight-color: transparent !important; /* Mencegah highlight biru saat tap */
        }
        
        /* Khusus untuk INPUT dan TEXTAREA agar tetap bisa diedit/disalin/dipilih */
        input, textarea {
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
        }
        
        /* Khusus untuk GAMBAR (mencegah klik kanan/tekan lama pada gambar) */
        img {
            pointer-events: none;
        }
        
        /* ----------------------------------------------------------- */
        
        body { color: #e0e0e0; background-color: #000000; font-size: 14px; padding-bottom: 80px; }
        .header { display: flex; align-items: center; justify-content: space-between; padding: 15px; background-color: #191929; border-bottom: 1px solid #2a2a3a; position: sticky; top: 0; z-index: 20; height: 55px; /* Tinggi header yang diperkirakan */ }
        .header-left, .header-right { display: flex; align-items: center; flex: 1; }
        .header-left { justify-content: flex-start; }
        .header-right { justify-content: flex-end; gap: 10px; }
        .header-center { flex: 2; text-align: center; }
        .header-title-img { height: 35px; width: auto; vertical-align: middle; }
        .header-logo { height: 30px; width: auto; }
        .header-btn { background: none; border: none; cursor: pointer; padding: 5px; border-radius: 50%; }
        .header-btn img, .nav-item img, .icon-button img { width: 24px; height: 24px; filter: invert(30%) sepia(90%) saturate(2000%) hue-rotate(340deg) brightness(100%) contrast(100%); transition: filter 0.3s; }
        .nav-item.active img { filter: invert(30%) sepia(90%) saturate(2000%) hue-rotate(340deg) brightness(120%) contrast(100%); }
        
        /* Modifikasi untuk mencegah gulir halus (body/html) pada konten pendek */
        main { 
            padding: 20px 15px; 
        }
        
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .content-box { background: rgba(25, 25, 41, 0.8); padding: 25px; border-radius: 15px; text-align: center; width: 100%; border: 1px solid #2a2a3a; margin-bottom: 20px; }
        .content-box h2 { margin-bottom: 20px; color: #88d3ce; }
        
        /* --- START MODIFIKASI NAV BAR (FINAL) --- */
        .nav-bar { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            width: 100%; 
            background: #000000; 
            display: flex; 
            justify-content: space-around; 
            padding: 10px 0; 
            border-top: 1px solid #2a2a3a; 
            z-index: 10; 
            height: 60px;
            flex-wrap: nowrap; 
            overflow-x: hidden; 
        }
        .nav-item { 
            cursor: pointer; 
            text-align: center; 
            color: #ffffff; 
            position: relative;
            flex: 1 1 0; 
            min-width: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        .nav-item span { 
            font-size: 0.7em; 
            display: block; 
            white-space: nowrap; 
            overflow: hidden;
            text-overflow: ellipsis; 
            color: #ffffff; 
            filter: brightness(0.6); 
            transition: filter 0.3s, color 0.3s, font-weight 0.3s; 
            padding: 0 1px;
        }
        .nav-item.active span { color: #ffffff; filter: brightness(1); font-weight: bold; }
        /* Sembunyikan tombol-tombol Admin/Owner secara default di nav-bar */
        .nav-bar .admin-only,
        .nav-bar .owner-only {
            display: none !important; 
        }
        /* --- END MODIFIKASI NAV BAR --- */

        button, a, input, select, .nav-item, .header-btn, .icon-button { 
            outline: none !important; 
            box-shadow: none !important; 
            -webkit-tap-highlight-color: transparent !important; /* Hapus sorotan biru/abu-abu saat tap */
        }
        
        /* --- START MODIFIKASI UKURAN BANNER SAITAMA (FINAL & BERSIH) --- */
        .main-banner { 
            position: relative; 
            border-radius: 16px; 
            overflow: hidden; 
            margin-bottom: 20px; 
            box-shadow: 0 8px 25px rgba(0,0,0,0.3); 
            display: block; 
            
            /* DIBERSIHKAN: 100% di dalam padding main */
            width: 100%; 
            margin-left: 0;
            
            max-width: 100%; 
            box-sizing: border-box; /* Memastikan border 2px dihitung di dalam lebar 100% */
            border: 2px solid rgba(255, 255, 255, 0.5); 
        }
        
        /* BARU: Pastikan pengumuman di atas semua elemen banner */
        #live-announcement {
            position: absolute; 
            top: 15px; /* Jarak dari atas */
            left: 50%;
            transform: translateX(-50%);
            z-index: 5; 
            text-align: center; 
            color: #ffeb3b; 
            font-weight: 900; 
            font-size: 0.9em; 
            text-shadow: 0 0 5px #000; 
            background: rgba(0, 0, 0, 0.4); /* Background tipis agar teks lebih terbaca */
            padding: 2px 8px;
            border-radius: 5px;
            width: 90%;
            display: none; 
        }

        .main-banner img { 
            width: 100%; 
            display: block; 
            height: auto; 
            border-radius: 14px; 
            border: none; 
            position: relative; 
            z-index: 1; 
        }

        .banner-overlay { 
            position: absolute; 
            bottom: 0; 
            left: 0; 
            transform: none; 
            width: 100%; 
            max-width: 100%; 
            padding: 10px 20px; /* Padding dikurangi */
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); 
            z-index: 2; 
            border-bottom-left-radius: 14px; 
            border-bottom-right-radius: 14px; 
        }
        /* --- END MODIFIKASI UKURAN BANNER SAITAMA --- */

        .banner-overlay h2 { font-size: 1.5em; color: #fff; }
        .banner-overlay p { font-size: 0.9em; color: #aaa; }
        .icon-nav-grid { 
            display: grid; 
            /* Grid default untuk 6 ikon Admin/Reseller (2 baris @ 3) */
            grid-template-columns: repeat(3, 1fr); 
            gap: 15px; 
            margin-bottom: 20px; 
        }
        
        /* KUNCI: Untuk Member/VIP, hanya boleh ada 3 kolom (Messages, Bug, Settings) */
        .icon-nav-grid.member-layout {
            grid-template-columns: repeat(3, 1fr);
        }

        .icon-button { display: flex; flex-direction: column; align-items: center; gap: 8px; text-decoration: none; color: #ccc; }
        
        /* Garis luar merah untuk tombol icon */
        .icon-button .icon-bg { width: 50px; height: 50px; background-color: #191929; border-radius: 50%; display: flex; justify-content: center; align-items: center; border: 2px solid red; transition: background-color 0.3s; }
        
        .icon-button:hover .icon-bg { background-color: #2a2a3a; }

        /* Perbaikan Teks Create Account */
        .icon-button span {
            font-size: 0.8em;
            text-align: center;
            width: 100%;
        }

        .input-group { text-align: left; margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; color: #a7a9be; }
        .input-group input, .input-group select { 
            width: 100%; padding: 12px; border: 1px solid #2a2a3a; background: #10101a; border-radius: 8px; color: #fff; font-size: 1em; 
            font-family: 'Orbitron', monospace; 
        }
        
        /* Style khusus untuk group durasi */
        .duration-group { display: flex; gap: 10px; align-items: flex-end; }
        
        /* Menyembunyikan input dan unit jika mode unlimited dipilih */
        .unlimited-mode .input-value, 
        .unlimited-mode .input-unit {
            display: none !important;
        }

        /* Menampilkan placeholder untuk unlimited mode */
        .unlimited-mode .unlimited-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 44px; /* Tinggi yang sama dengan input */
            padding: 12px;
            border: 1px solid #2a2a3a;
            background: #10101a;
            border-radius: 8px;
            color: #88d3ce;
            font-size: 1em;
            font-weight: bold;
        }
        
        /* Menyembunyikan placeholder di mode normal */
        .input-group .unlimited-placeholder {
            display: none;
        }


        .duration-group .input-value { flex-grow: 1; } 
        .duration-group .input-unit { width: auto; flex-shrink: 0; } 

        .submit-btn { 
            width: 100%; 
            padding: 12px; 
            border: none; 
            border-radius: 8px; 
            background: #88d3ce; 
            color: #10101a; 
            font-size: 1.1em; 
            font-weight: bold; 
            cursor: pointer; 
            margin-top: 10px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px;
            font-family: 'Orbitron', monospace; 
        }
        
        .submit-btn img { 
            display: none; 
        }
        
        /* PENTING: MENAMBAH ATURAN INI UNTUK MEMASTIKAN TEKS TOMBOL SELALU TEBAL */
        .submit-btn span {
            font-weight: 900; 
        }

        /* Style untuk Tombol Abu-abu (Disabled) */
        .submit-btn:disabled {
            background-color: #555;
            color: #999;
            cursor: not-allowed;
        }
        
        /* --- MENGHAPUS STYLE LAMA MODE SELECTOR BUG PAGE --- */
        /* .mode-selector { display: flex; width: 100%; background: #10101a; border-radius: 8px; overflow: hidden; border: 1px solid #2a2a3a; margin-bottom: 15px; }
        .mode-btn { 
            flex: 1; padding: 12px; border: none; background-color: transparent; color: #a7a9be; cursor: pointer; font-size: 0.9em; transition: all 0.3s; font-weight: bold; 
            font-family: 'Orbitron', monospace; 
        }
        .mode-btn.active { background-color: #88d3ce; color: #10101a; } */
        /* --- AKHIR MENGHAPUS STYLE LAMA --- */

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); z-index: 1000; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s; }
        .modal-overlay.active { display: flex; opacity: 1; }
        .modal-box { background: #191929; padding: 25px; border-radius: 15px; text-align: center; width: 90%; max-width: 350px; border: 1px solid #2a2a3a; transform: scale(0.9); transition: transform 0.3s; }
        .modal-overlay.active .modal-box { transform: scale(1); }
        .modal-box p { margin-bottom: 20px; color: #a7a9be; }
        .modal-buttons { display: flex; gap: 10px; }
        .modal-buttons button { 
            flex: 1; padding: 10px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; 
            font-family: 'Orbitron', monospace; 
        }
        .profile-info { text-align: left; margin-bottom: 25px; }
        .profile-info p { border-bottom: 1px solid #2a2a3a; padding: 10px 0; color: #fff; display: flex; justify-content: space-between; }
        .profile-info p span { color: #aaa; }
        .status-active { color: #2ecc71 !important; } .status-expired { color: #e74c3c !important; }
        .account-data-table { width: 100%; border-collapse: collapse; margin-top: 20px; table-layout: fixed; }
        /* Modifikasi Data Table untuk tombol edit */
        .account-data-table th, .account-data-table td { padding: 8px; border: 1px solid #2a2a3a; text-align: left; font-size: 0.9em; word-wrap: break-word; }
        .account-data-table th { background-color: #10101a; }
        .online-status { display: inline-block; width: 10px; height: 10px; background-color: #e74c3c; border-radius: 50%; margin-right: 5px; }
        .online-status.online { background-color: #2ecc71; }
        .action-btn { border: none; padding: 5px 8px; border-radius: 5px; cursor: pointer; color: white; margin: 2px 0; display: inline-block; width: 100%; }
        .delete-btn { background-color: #c0392b; }
        .edit-btn { background-color: #3498db; } /* Tombol Edit Baru */
        .renew-account-btn { background-color: #3498db; }
        .frozen-overlay { width: 100%; height: 100vh; display: flex; justify-content: center; align-items: center; text-align: center; flex-direction: column; position: fixed; top: 0; left: 0; background: rgba(0,0,0,0.8); z-index: 9999; }
        #notification-container { position: fixed; top: 20px; right: 20px; z-index: 10001; }
        .notification { padding: 15px; border-radius: 8px; color: #fff; font-weight: bold; background: #333; margin-bottom: 10px; animation: slideIn 0.5s forwards; }
        .notification.success { background: #2ecc71; } .notification.error { background: #e74c3c; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
        @keyframes slideOut { to { opacity: 0; transform: translateX(100%); } }
        .subscription-status { background: #10101a; border-radius: 8px; padding: 15px; margin-bottom: 20px; text-align: left; font-size: 0.9em; border: 1px solid #2a2a3a;}
        .owner-controls { margin-top: 20px; border-top: 1px solid #2a2a3a; padding-top: 20px; }
        .control-buttons { display: flex; gap: 10px; }
        .control-buttons button { 
            flex: 1; padding: 10px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; 
            font-family: 'Orbitron', monospace; 
        }
        .apk-on-btn { background-color: #2ecc71; color: white; }
        .apk-off-btn { background-color: #e74c3c; color: white; }
        .message-inbox { max-height: 400px; overflow-y: auto; text-align: left; }
        .message-item { background: #10101a; border: 1px solid #2a2a3a; border-radius: 10px; padding: 15px; margin-bottom: 15px; }
        .message-item p { margin-bottom: 10px; word-wrap: break-word; }
        .message-item b { color: #88d3ce; }
        .message-actions { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 15px; }
        .message-actions button { 
            width: 100%; padding: 8px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; 
            font-family: 'Orbitron', monospace; 
        }
        .accept-btn { background-color: #27ae60; color: white; }
        .telegram-btn { background-color: #3498db; color: white; }
        .reject-btn { background-color: #c0392b; color: white; }
        .conversation-list-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #2a2a3a; cursor: pointer; }
        .conversation-list-item:hover { background-color: #10101a; }
        .conversation-info { text-align: left; flex-grow: 1; margin-right: 10px; }
        .conversation-info .username { font-weight: bold; color: #fff; }
        .conversation-info .last-message { font-size: 0.9em; color: #aaa; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #chat-window-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        #message-container { height: calc(100vh - 300px); overflow-y: auto; display: flex; flex-direction: column; padding: 10px; border: 1px solid #2a2a3a; border-radius: 8px; background-color: #10101a; margin-bottom: 10px;}
        .message-bubble { max-width: 70%; padding: 10px 15px; border-radius: 18px; margin-bottom: 10px; word-wrap: break-word; position: relative; }
        .message-bubble .timestamp { font-size: 0.7em; color: #bbb; display: block; margin-top: 5px; text-align: right; }
        .sent { background-color: #3498db; color: white; align-self: flex-end; }
        .received { background-color: #2c3e50; color: white; align-self: flex-start; }
        .delete-msg-btn { position: absolute; top: 2px; left: -25px; background: none; border: none; color: #999; cursor: pointer; font-size: 1.2em; padding: 0; line-height: 1; opacity: 0; transition: opacity 0.2s; } /* Initially hidden */
        .message-bubble.sent:hover .delete-msg-btn { opacity: 1; }
        .delete-msg-btn:hover { color: #ff4d4d; }
        #message-form { display: flex; margin-top: 10px; gap: 10px; }
        #message-input { flex-grow: 1; }
        #user-search-results { max-height: 200px; overflow-y: auto; margin-top: 15px; border: 1px solid #2a2a3a; border-radius: 8px;}
        .search-result-item { padding: 12px; text-align: left; border-bottom: 1px solid #2a2a3a; cursor: pointer; }
        .search-result-item:hover { background-color: #2a2a3a; }
        .search-result-item:last-child { border-bottom: none; }

        /* ðŸ”¥ PERBAIKAN TOTAL UNTUK SERVER STATS HEADER ðŸ”¥ */
        .stats-panel {
            background: linear-gradient(-45deg, #600000, #a00000, #3d0000, #500000);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            border-radius: 12px;
            padding: 0;
            margin-top: 0px; 
            border: 1px solid rgba(255, 100, 100, 0.2);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            font-size: 14px;
            color: #ffffff;
            overflow: hidden;
            
            /* DIBERSIHKAN: 100% di dalam padding main */
            width: 100%;
            margin-left: 0; 
            box-sizing: border-box;
            margin-bottom: 20px; 
        }
        .stats-header { 
            display: flex; 
            align-items: center; /* KUNCI: Menyelaraskan vertikal di tengah */
            gap: 10px; /* ðŸ”¥ Dibuat lebih rapat */
            padding: 15px; 
            background-color: #b8860b; 
            font-weight: bold; 
            font-size: 1.4em; 
            letter-spacing: 0.5px;
        }
        .stats-header span { 
            color: #ffffff; 
            line-height: 1; /* Memastikan teks memiliki tinggi baris yang rapat */
        }
        .stats-header img { 
            width: 30px; /* ðŸ”¥ Ikon dibesarkan */
            height: 30px; /* ðŸ”¥ Ikon dibesarkan */
            display: block; 
            filter: none; 
            flex-shrink: 0; 
        }
        .stats-content { padding: 0 15px 5px 15px; }
        .stats-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; }
        .stats-row + .stats-row { border-top: 1px solid gold; }
        .stats-row .label { display: flex; align-items: center; gap: 10px; color: #ffcccc; }
        .stats-row .label img { 
            width: 25px; 
            height: 25px; 
            display: block; 
            filter: none; 
        }
        .stats-row .value { font-weight: normal; color: #ffffff; text-align: right; font-family: 'Orbitron', monospace; font-size: 1em; } 
        /* ðŸ”¥ AKHIR PERBAIKAN TOTAL UNTUK SERVER STATS HEADER ðŸ”¥ */

        /* Style Banner Dinamis (Merah Bergerak) - TELEGRAM BANNER */
        .telegram-custom-banner {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(-45deg, #600000, #a00000, #3d0000, #500000);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            border-radius: 12px;
            padding: 10px 15px; 
            
            /* DIBERSIHKAN: 100% di dalam padding main */
            width: 100%;
            margin-left: 0;
            box-sizing: border-box;

            border: 1px solid rgba(255, 100, 100, 0.2);
            box-shadow: 0 4px 10px rgba(0,0,0,0.25);
            text-decoration: none;
            color: #ffffff;
            font-size: 14px;
            cursor: pointer;
            height: 65px; 
            margin-bottom: 20px; 
        }
        .telegram-custom-banner .banner-content { 
            display: flex; 
            align-items: center; 
            /* JANGAN stretch konten vertikal */
            gap: 15px; /* Jarak antara ikon dan teks ditingkatkan */
            flex-grow: 1; 
        }
        
        /* PERBAIKAN BANNER ICON */
        .telegram-custom-banner .banner-icon-img { 
            width: 45px; 
            height: 45px; 
            filter: invert(100%); 
            flex-shrink: 0; 
            display: block; 
            margin-left: -5px; 
            /* Pastikan ikon tidak melebar/terdeformasi */
            object-fit: contain; 
        }
        /* PERBAIKAN BANNER TEXT agar tidak tertutup/tertindih */
        .telegram-custom-banner .banner-text { 
            flex-grow: 1; 
            margin-right: 0px; 
            font-weight: bold; 
            line-height: 1.1; 
            text-align: left; 
            font-family: 'Press Start 2P', cursive; 
            font-size: 0.9em; 
            letter-spacing: -0.5px; 
            /* Tambahkan min-width agar teks mengambil ruangnya */
            min-width: 0; 
        }
        .telegram-custom-banner .banner-text span { 
            display: block; 
            font-size: 1em; 
        }
        /* Akhir Modifikasi Telegram Banner */

        .telegram-custom-banner .arrow-icon { font-size: 1.5em; color: #ffffff; flex-shrink: 0; }

        /* Animasi Gradient (Merah Bergerak) */
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Style Tambahan untuk Bagian Banner Settings */
        .banner-settings-section {
             margin-top: 20px;
             border-top: 1px solid #2a2a3a;
             padding-top: 20px;
             text-align: left; 
        }
        .banner-settings-section label {
             display: block;
             margin-bottom: 5px;
             color: #a7a9be;
        }
        .banner-settings-section .input-group {
             margin-bottom: 10px; 
        }
        .banner-settings-section .submit-btn {
             margin-top: 5px; 
        }

        /* Style <select> agar mirip <input> */
        .input-group select {
            appearance: none; 
            -webkit-appearance: none; 
            -moz-appearance: none; 
            background-color: #10101a; 
            background-image: url('data:image/svg+xml;utf8,<svg fill="white" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>'); 
            background-repeat: no-repeat;
            background-position: right 10px center; 
            background-size: 20px; 
            padding-right: 40px; 
        }

        /* Hilangkan panah default di Firefox */
        select::-moz-focus-inner {
            border: 0;
        }
        /* Hilangkan panah default di IE */
        select::-ms-expand {
            display: none;
        }

        /* Solusi Scroll Home Page */
        #home-page {
            /* Tinggi total viewport - Tinggi Header - Tinggi Navbar - Padding Vertikal Main (20px + 20px) */
            height: calc(100vh - 55px - 60px - 40px); 
            /* overflow-y dikontrol oleh JS. */
        }
        
        /* --- START CUSTOM SELECT STYLE (MODERN) --- */
        .custom-select-wrapper {
            position: relative;
            display: block; 
            text-align: left;
        }

        .custom-select {
            position: relative;
            width: 100%;
            padding: 12px;
            border: 1px solid #2a2a3a;
            background: #10101a;
            border-radius: 8px;
            color: #fff;
            font-size: 1em;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Orbitron', monospace;
            z-index: 1;
            outline: none !important; /* Menghilangkan outline fokus bawaan browser */
            -webkit-tap-highlight-color: transparent !important; /* Menghilangkan sorotan saat ditekan (mobile) */
            user-select: none; /* Mencegah seleksi teks saat tap */
        }

        /* Icon Panah ke Bawah */
        .custom-select-arrow {
            font-size: 1.2em;
            color: #88d3ce; 
            transition: transform 0.3s;
        }
        .custom-select.open .custom-select-arrow {
            transform: rotate(180deg);
        }

        .select-options {
            position: absolute;
            top: 100%; 
            left: 0;
            right: 0;
            background: #191929; 
            border: 1px solid #2a2a3a;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            display: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }

        .select-option-item {
            padding: 12px;
            cursor: pointer;
            color: #a7a9be;
            transition: background-color 0.2s, color 0.2s;
            font-family: 'Orbitron', monospace;
            -webkit-tap-highlight-color: transparent !important; /* Menghilangkan sorotan saat tap pada item */
            user-select: none;
        }

        .select-option-item:hover,
        .select-option-item.selected {
            background-color: #2a2a3a;
            color: #88d3ce; 
        }
        
        /* ðŸ”¥ KODE BARU: Style untuk mode yang tidak bisa dipilih (disabled look) ðŸ”¥ */
        .select-option-item.disabled-mode {
            color: #555; /* Warna teks abu-abu */
            background-color: #10101a; /* Background yang lebih gelap dari hover */
            cursor: not-allowed; /* Kursor tidak diizinkan */
            opacity: 0.7;
        }

        .select-option-item.disabled-mode:hover {
            background-color: #10101a; /* Mencegah perubahan warna saat hover */
            color: #555; /* Teks tetap abu-abu saat hover */
        }


        /* Sembunyikan select/input asli */
        .hidden-select {
            display: none !important;
        }
        /* --- END CUSTOM SELECT STYLE --- */

        /* --- START: KODE CSS TAMBAHAN UNTUK TOMBOL CS MELAYANG --- */
        .floating-cs-button {
            /* Posisi Melayang (Fixed) */
            position: fixed;
            right: 20px; /* Jarak dari ujung kanan */
            bottom: 80px; /* Jarak dari ujung bawah (di atas nav-bar 60px + 20px) */
            z-index: 1000; /* Memastikan tombol di atas elemen lain */
            
            /* Styling Tombol */
            background-color: #4CAF50; /* Warna Hijau */
            padding: 10px;
            border-radius: 50%; /* Membuat tombol berbentuk lingkaran */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4); /* Efek bayangan */
            
            /* Transisi untuk animasi halus */
            transition: background-color 0.3s, transform 0.3s;
            
            /* Menghilangkan garis bawah pada link */
            text-decoration: none;
            
            /* Ukuran Tombol (sesuaikan jika perlu) */
            width: 60px;
            height: 60px;
            display: flex; /* Untuk memposisikan gambar di tengah */
            align-items: center;
            justify-content: center;
        }

        /* Styling Gambar di dalam Tombol */
        .floating-cs-button img {
            width: 100%; /* Membuat gambar mengisi tombol */
            height: 100%;
            object-fit: contain; /* Memastikan gambar pas tanpa terdistorsi */
            border-radius: 50%; /* Gambar juga dibuat lingkaran */
            filter: invert(100%); /* Agar ikon terlihat jelas di background hijau */
        }

        /* Efek Hover (Saat kursor di atas tombol) */
        .floating-cs-button:hover {
            background-color: #45a049; /* Warna hijau sedikit lebih gelap */
            transform: scale(1.05); /* Sedikit membesar saat di-hover */
        }
        
        /* Efek Klik (Opsional) */
        .floating-cs-button:active {
            transform: scale(0.95);
        }
        /* --- END: KODE CSS TAMBAHAN UNTUK TOMBOL CS MELAYANG --- */

    </style>
</head>
<body>
    <div id="app-wrapper">
        <div id="notification-container"></div>
        <div class="header">
            <div class="header-left">
                <button class="header-btn" id="menu-btn">
                    <img src="tandatiga.png" alt="Menu">
                </button>
            </div>
            <div class="header-center">
                <img src="ultragon.png" alt="ULTRAGON" class="header-title-img">
            </div >
            <div class="header-right">
                <img src="logoug.png" alt="Logo ULTRAGON" class="header-logo">
                <button class="header-btn" id="profile-header-btn">
                    <img src="profil.png" alt="Profile">
                </button>
            </div>
        </div>
        <main>
            <div id="home-page" class="page">
                <div class="main-banner">
                    <div id="live-announcement" style="position: absolute; top: 15px; left: 50%; transform: translateX(-50%); z-index: 5; text-align: center; color: #ffeb3b; font-weight: 900; font-size: 0.9em; text-shadow: 0 0 5px #000; background: rgba(0, 0, 0, 0.4); padding: 2px 8px; border-radius: 5px; width: 90%; display: none;"></div>

                    <img src="saitama.png" alt="Main Banner">
                    <div class="banner-overlay">
                        <h2>ULTRAGON</h2>
                        <p>Welcome, <span id="welcome-username">User</span>!</p>
                    </div>
                </div>
                <div class="icon-nav-grid">
                    <a href="#" class="icon-button" data-page="admin-page">
                        <div class="icon-bg"><img src="tambah.png" alt="Create Account"></div>
                        <span>Create Account</span>
                    </a>
                    <a href="#" class="icon-button" data-page="data-page">
                        <div class="icon-bg"><img src="data.png" alt="Data"></div>
                        <span>Data</span>
                    </a>
                    <a href="#" class="icon-button" data-page="messages-page">
                        <div class="icon-bg"><img src="inbox.png" alt="Admin Inbox"></div>
                        <span>Admin Inbox</span>
                    </a>
                    <a href="#" class="icon-button" data-page="chat-list-page">
                        <div class="icon-bg"><img src="pesan.png" alt="Messages"></div>
                        <span>Messages</span>
                    </a>
                    <a href="#" class="icon-button" data-page="sender-page">
                        <div class="icon-bg"><img src="kumbang1.png" alt="Bug"></div>
                        <span>Bug</span>
                    </a>
                    <a href="#" class="icon-button" data-page="settings-page">
                        <div class="icon-bg"><img src="pengaturan.png" alt="Settings"></div>
                        <span>Settings</span>
                    </a>
                </div>

                
                    <a href="https://t.me/ultragonpro" id="telegram-banner-link" target="_blank" class="telegram-custom-banner">
                        <div class="banner-content">
                            <img src="orang.png" alt="People Icon" class="banner-icon-img">
                            <span class="banner-text">
                                <span id="banner-text-line1">ðŸ”¥ Telegram Channel: Join To Get</span>
                                <span id="banner-text-line2">More Info!</span>
                            </span>
                        </div>
                        <span class="arrow-icon">âŸ©</span>
                    </a>
                
                    <div class="stats-panel">
                        <div class="stats-header">
                            <img src="stats.png" alt="Stats Icon"> <span>Server Stats</span>
                        </div>
                        <div class="stats-content">
                            <div class="stats-row">
                                <span class="label">
                                    <img src="onlineusers.png" alt="Users Icon"> <span>Online Users</span>
                                </span>
                                <span class="value" id="online-users-stat">0</span>
                            </div>
                            <div class="stats-row">
                                <span class="label">
                                    <img src="activesender.png" alt="Sender Icon"> <span>Active Senders</span>
                                </span>
                                <span class="value" id="active-sender-stat">0</span>
                            </div>
                        </div>
                    </div>
                

            </div>

            <div id="data-page" class="page">
                 <div class="content-box">
                    <h2>Account Data Dashboard</h2>
                    <div class="input-group">
                        <input type="search" id="search-account-input" placeholder="Search username...">
                    </div>
                    <p>Total Accounts: <b id="total-accounts-data">0</b></p>
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table class="account-data-table">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Password</th>
                                    <th>Role</th>
                                    <th style="width:25%; min-width: 100px;">Action</th> <th style="width:25%; min-width: 100px;">Extend</th>
                                </tr>
                            </thead>
                            <tbody id="account-list-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="sender-page" class="page">
                 <div class="content-box">

                    <div class="main-banner"> 
                        <video src="saitama1.mp4" autoplay muted loop style="width: 100%; display: block;">
                            Browser kamu tidak support video.
                        </video>
                    </div>
                    <h2>WhatsApp Bug</h2>
                     <div id="prefix-settings" style="display: none; border-bottom: 1px solid #2a2a3a; padding-bottom: 15px; margin-bottom: 15px;">
                        <h4>Prefix Settings (Master Owner Only)</h4>
                        <div class="input-group"><label>Prefix Invisible Delay (Mode: delay)</label><input id="delay-prefix-input"></div>
                        <div class="input-group"><label>Prefix iOS / Andro Crash (Mode: bug)</label><input id="bug-prefix-input"></div>
                        <div class="input-group"><label>Prefix Invisible Delay V2 (Mode: delayV2)</label><input id="delayV2-prefix-input"></div>
                        <div class="input-group"><label>Prefix Ultra Killer (Mode: ultra)</label><input id="ultra-prefix-input"></div>
                        <div class="input-group"><label>Prefix Dark Killer (Mode: dark)</label><input id="dark-prefix-input"></div>
                        <div class="input-group"><label>Prefix Ultimate ZX (Mode: zx)</label><input id="zx-prefix-input"></div>
                        <button class="submit-btn" id="save-prefix-btn" style="background-color:#3498db">Save All Prefix Settings</button>
                    </div>
                    
                    <form id="wa-form">
                        
                        <div class="input-group">
                            <label for="target-number">Target Number</label>
                            <input type="number" id="target-number" placeholder="+628XXXXXXXXXX" required>
                        </div>
                        
                        <div class="input-group custom-select-wrapper" id="bug-mode-wrapper" style="margin-top: 5px;">
                            <label for="bug-mode-select">Select Bug Mode</label>
                            <select id="bug-mode-select" class="hidden-select" required></select>
                        </div>
                        <button type="button" id="send-bug-btn" class="submit-btn">
                            <span>SEND BUG</span>
                            </button>
                        <p id="cooldown-timer" style="margin-top:10px; color: #ff9e9e; font-weight: bold;"></p>

                    </form>
                </div>
            </div>

            <div id="admin-page" class="page">
                <div class="content-box">
                    <h2>ADMIN PANEL: Create Account</h2>
                    <form id="create-account-form">
                        <div class="input-group custom-select-wrapper" id="new-role-wrapper">
                            <label for="new-role">Select Role</label>
                            <select id="new-role" required class="hidden-select"></select>
                        </div>
                        <div class="input-group"><label for="new-username">New Username</label><input type="text" id="new-username" required></div>
                        <div class="input-group"><label for="new-password">New Password</label><input type="text" id="new-password" required></div>
                        
                        <div class="input-group duration-group-wrapper" id="duration-group-wrapper">
                             <label>Duration</label>
                             <div class="duration-group">
                                <input type="number" id="new-duration-value" placeholder="e.g., 30" class="input-value" required>
                                
                                <div class="custom-select-wrapper" id="new-duration-unit-wrapper" style="width: auto; flex-shrink: 0;">
                                    <select id="new-duration-unit" class="input-unit hidden-select" required>
                                        <option value="days">Days</option>
                                        <option value="months">Months</option>
                                        <option value="years">Years</option>
                                    </select>
                                </div>
                                
                                <div class="unlimited-placeholder">âˆž UNLIMITED</div>
                             </div>
                             
                             <div class="custom-select-wrapper" id="duration-mode-select-wrapper">
                                 <select id="duration-mode-select" class="input-unit hidden-select" style="margin-top: 10px; width: 100%;">
                                     <option value="time">Set Time</option>
                                     <option value="unlimited">Unlimited</option>
                                 </select>
                             </div>

                        </div>
                        <button type="button" id="create-account-btn" class="submit-btn">Create Account</button>
                    </form>
                </div>
            </div>

            <div id="settings-page" class="page">
                 <div class="content-box">
                    <h2>Account Settings</h2>
                    <div class="subscription-status">
                        <p>Username: <span id="settings-username" style="color:white;"></span></p>
                        <p>Role: <span id="settings-role" style="color:white;"></span></p><hr style="border-color:#2a2a3a; margin:10px 0;">
                        <p>Purchase Date: <span id="purchase-date"></span></p>
                        <p>Expires On: <span id="expiry-date"></span></p>
                        <p>Application Status: <span id="app-status-display"></span></p>
                        <a href="#" id="renew-link" class="action-btn renew-account-btn" style="display:block; text-decoration:none; margin-top:10px;">Request Extension</a>
                    </div>
                    
                    <button id="logout-btn" style="width:100%; padding:12px; border:none; border-radius:8px; background:#c0392b; color:white; font-weight:bold;">Logout</button>

                    <div id="owner-controls-container"></div>

                </div>
            </div>

            <div id="messages-page" class="page">
                <div class="content-box">
                    <h2>Admin Inbox</h2>
                    <div class="input-group">
                        <label>Your WA Number (to reply)</label>
                        <input type="number" id="admin-wa-number" placeholder="62...">
                    </div>
                    <div class="input-group">
                        <label>Your Telegram Username/ID (to reply)</label>
                        <input type="text" id="admin-tg-id" placeholder="@username or 12345678">
                    </div>
                     <div id="message-inbox-container" class="message-inbox"></div>
                </div>
            </div>

            <div id="chat-list-page" class="page">
                 <div class="content-box">
                    <h2>Messages</h2>
                    <button id="start-new-chat-btn" class="submit-btn" style="margin-bottom: 20px; background-color: #27ae60;">Start New Chat</button>
                    <div id="conversation-list" style="max-height: 400px; overflow-y: auto;"></div>
                </div>
            </div>

            <div id="chat-window-page" class="page">
                <div class="content-box">
                    <div id="chat-window-header">
                        <button id="back-to-chat-list-btn" class="action-btn" style="width:auto;background-color:#555;">Back</button>
                        <h3 id="chat-partner-username"></h3>
                        <div></div> </div>
                    <div id="message-container" style="position: relative;"></div>
                    <form id="message-form">
                        <input type="text" id="message-input" placeholder="Type message..." required>
                        <button type="submit" class="submit-btn" style="width:auto;margin-top:0;">Send</button>
                    </form>
                </div>
            </div>

        </main>

    <div class="modal-overlay" id="edit-account-modal">
        <div class="modal-box">
            <h3 id="edit-title" style="color: #88d3ce; margin-bottom: 20px;">Edit Account: <span id="edit-username-title"></span></h3>
            <form id="edit-account-form">
                <input type="hidden" id="edit-account-uid">
                <div class="input-group"><label for="edit-username">Username</label><input type="text" id="edit-username" required></div>
                <div class="input-group"><label for="edit-password">Password</label><input type="text" id="edit-password" required></div>
                <div class="input-group custom-select-wrapper" id="edit-role-wrapper">
                    <label for="edit-role">Role</label>
                    <select id="edit-role" required class="hidden-select"></select>
                </div>
                
                <div class="input-group duration-group-wrapper" id="edit-duration-group-wrapper">
                     <label>Duration / Expiry</label>
                     <div class="duration-group">
                        <input type="number" id="edit-duration-value" placeholder="e.g., 30" class="input-value">
                        
                        <div class="custom-select-wrapper" id="edit-duration-unit-wrapper" style="width: auto; flex-shrink: 0;">
                            <select id="edit-duration-unit" class="input-unit hidden-select">
                                <option value="days">Days</option>
                                <option value="months">Months</option>
                                <option value="years">Years</option>
                            </select>
                        </div>
                        
                        <div class="unlimited-placeholder">âˆž UNLIMITED</div>
                     </div>
                     
                     <div class="custom-select-wrapper" id="edit-duration-mode-select-wrapper">
                         <select id="edit-duration-mode-select" class="input-unit hidden-select" style="margin-top: 10px; width: 100%;">
                             <option value="keep">Keep Existing Expiry</option>
                             <option value="time">Set Time (Add/Set)</option>
                             <option value="unlimited">Unlimited</option>
                         </select>
                     </div>
                     
                     <p id="current-expiry-display" style="font-size:0.8em; margin-top:5px; color:#aaa;"></p>
                </div>
                <button type="button" id="save-edit-btn" class="submit-btn" style="background-color: #27ae60;">Save Changes</button>
                <button type="button" id="close-edit-modal-btn" class="submit-btn" style="background-color: #555; margin-top: 5px;">Cancel</button>
            </form>
        </div>
    </div>
    <nav class="nav-bar">
            <div class="nav-item" data-page="home-page"><img src="home.png" alt="Home"><span>Home</span></div>
            
            <div class="nav-item admin-only" data-page="admin-page"><img src="tambah.png" alt="Create"><span>Create</span></div>
            <div class="nav-item admin-only" data-page="data-page"><img src="data.png" alt="Data"><span>Data</span></div>
            
            <div class="nav-item owner-only" data-page="messages-page">
                <img src="inbox.png" alt="Inbox">
                <span>Inbox</span>
            </div>

            <div class="nav-item" data-page="chat-list-page">
                <img src="pesan.png" alt="Messages">
                <span>Messages</span>
            </div>
            <div class="nav-item" data-page="sender-page"><img src="kumbang1.png" alt="Bug"><span>Bug</span></div>
            <div class="nav-item" data-page="settings-page"><img src="pengaturan.png" alt="Settings"><span>Settings</span></div>
        </nav>
    </div>

    <div class="modal-overlay" id="confirm-modal">
        <div class="modal-box">
            <h3 id="confirm-title" style="color: #e94560; margin-bottom: 10px;">Confirm Action</h3>
            <p id="confirm-text">Are you sure?</p>
            <div class="modal-buttons">
                <button id="confirm-no-btn" style="background-color: #555; color: white;">Cancel</button>
                <button id="confirm-yes-btn" style="background-color: #e94560; color: white;">Yes, Continue</button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="user-search-modal">
        <div class="modal-box">
            <h3 style="color: #88d3ce; margin-bottom: 20px;">Start New Chat</h3>
            <div class="input-group"><input type="search" id="user-search-input" placeholder="Type username to search..."></div>
            <div id="user-search-results"></div>
            <div class="modal-buttons" style="margin-top: 20px;"><button id="close-user-search-modal-btn" style="background-color: #555; color: white;">Close</button></div>
        </div>
    </div>
    
    <a href="index2.html" class="floating-cs-button" title="Customer Service">
        <img src="cs1.png" alt="Customer Service Icon">
    </a>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <script>
        // --- MASTER OWNER CONFIGURATION ---
        // ðŸ”¥ PERUBAHAN: Menambahkan Password Master Owner
        const MASTER_OWNER_USERNAME = "Ultragon"; // GANTI dengan username Owner Utama Anda
        const MASTER_OWNER_PASSWORD = "MASTER KING"; // Password Master Owner
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDmg3JbCywbOh__iDMgwbCGG480SzZSaiY",
            authDomain: "ultragon-app.firebaseapp.com",
            databaseURL: "https://ultragon-app-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ultragon-app",
            storageBucket: "ultragon-app.firebasestorage.app",
            messagingSenderId: "119387094211",
            appId: "1:119387094211:web:e43f951de20e793ac9b676"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- GLOBAL VARIABLES ---
        let currentUserData = {};
        let globalConfig = {};
        let allUsers = {};
        let chatsListener = null;
        let currentChatPartnerUid = null;
        let sessionListenerRef = null; 
        
        // Catatan: Variabel notifikasi dihapus sesuai permintaan.


        // ===========================================
        // ### START: COOKIE FUNCTIONS (PENTING)
        // ===========================================

        // Fungsi untuk mengatur cookie (disimpan selama 365 hari)
        function setCookie(name, value, days) {
            let expires = "";
            if (days) {
                const date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            // Set path=/ agar cookie berlaku untuk seluruh aplikasi, Secure/SameSite untuk standar keamanan
            document.cookie = name + "=" + (value || "")  + expires + "; path=/; Secure; SameSite=Strict"; 
        }

        // Fungsi untuk mendapatkan cookie
        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for(let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        // Fungsi untuk menghapus cookie (digunakan saat logout)
        function eraseCookie(name) {   
            document.cookie = name+'=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
        }

        // ===========================================
        // ### END: COOKIE FUNCTIONS
        // ===========================================


        // --- UTILITY FUNCTIONS ---
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            if (!container) return;
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            container.appendChild(notification);
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.5s forwards';
                setTimeout(() => { if (container.contains(notification)) container.removeChild(notification); }, 500);
            }, 4000);
        }

        function showConfirm(text, onConfirm) {
            const modal = document.getElementById('confirm-modal');
            modal.classList.add('active');
            const yesBtn = document.getElementById('confirm-yes-btn');
            const noBtn = document.getElementById('confirm-no-btn');
            document.getElementById('confirm-text').textContent = text;
            const cleanup = () => {
                yesBtn.removeEventListener('click', confirmHandler);
                noBtn.removeEventListener('click', cancelHandler);
            };
            const confirmHandler = () => { onConfirm(); modal.classList.remove('active'); cleanup(); };
            const cancelHandler = () => { modal.classList.remove('active'); cleanup(); };
            yesBtn.addEventListener('click', confirmHandler);
            noBtn.addEventListener('click', cancelHandler);
        }

        // --- Modifikasi Fungsi Logout (Menggunakan Cookies) ---
        function logout() {
            if (sessionListenerRef) { sessionListenerRef.off(); sessionListenerRef = null; }
            if (currentUserData && currentUserData.uid) { const myNotifRef = db.ref('user_notifications/' + currentUserData.uid); myNotifRef.off(); }
            
            // MENGHAPUS COOKIES
            eraseCookie('userUid'); 
            eraseCookie('sessionId'); 
            
            window.location.href = 'index.html';
        }

        
        // --- Fungsi Cek Cooldown (dengan penghilangan gambar) ---
        function checkBugCooldown() {
            const btn = document.getElementById('send-bug-btn');
            const timerEl = document.getElementById('cooldown-timer');
            if (!btn || !timerEl || !currentUserData) return;
            const now = Date.now();
            const cooldownUntil = currentUserData.bugCooldownUntil || 0;
            if (cooldownUntil > now) {
                const remainingMs = cooldownUntil - now;
                const remainingMinutes = Math.floor(remainingMs / 60000);
                const remainingSeconds = Math.floor((remainingMs % 60000) / 1000);
                const displaySeconds = remainingSeconds < 10 ? '0' + remainingSeconds : remainingSeconds;
                timerEl.textContent = `Please wait ${remainingMinutes}:${displaySeconds}`;
                btn.disabled = true;
                btn.innerHTML = `<span>COOLDOWN</span>`; 
            } else {
                timerEl.textContent = '';
                btn.disabled = false;
                btn.innerHTML = `<span>SEND BUG</span>`; 
            }
        }
        // --- AKHIR Fungsi Cek Cooldown ---


        // --- Fungsi Listener Notifikasi ---
        function listenForMyNotifications() {
            if (!currentUserData || !currentUserData.uid) return;
            const myNotifRef = db.ref('user_notifications/' + currentUserData.uid);
            myNotifRef.on('child_added', (snapshot) => {
                const notif = snapshot.val();
                if (notif && notif.text && notif.type) {
                    showNotification(notif.text, notif.type);
                    db.ref('user_notifications/' + currentUserData.uid + '/' + snapshot.key).remove();
                }
            });
        }
        
        // --- Fungsi Pemeriksa Sesi Aktif (Menggunakan Cookies) ---
        function listenForSessionChanges() {
            if (!currentUserData || !currentUserData.uid) return;
            const mySessionId = getCookie('sessionId'); // <<< MENGGUNAKAN COOKIE
            if (!mySessionId) { logout(); return; }

            sessionListenerRef = db.ref('users/' + currentUserData.uid + '/currentSessionId');
            sessionListenerRef.on('value', (snapshot) => {
                const dbSessionId = snapshot.val();
                // Jika DB Session ID ada dan TIDAK SAMA dengan Cookie ID saat ini, maka logout
                if (sessionListenerRef && dbSessionId && dbSessionId !== mySessionId) {
                    showNotification("Logged out: Account used on another device.", "error");
                    logout();
                }
            });
        }

        // --- APP INITIALIZATION (Menggunakan Cookies) ---
        async function initializeApp() {
            const localUserUid = getCookie('userUid'); // <<< MENGGUNAKAN COOKIE
            const localSessionId = getCookie('sessionId'); // <<< MENGGUNAKAN COOKIE
            
            // Cek jika Cookie tidak ada. Jika tidak ada, alihkan ke login.
            if (!localUserUid || !localSessionId) { 
                // Karena kita tahu tombol Back membawa ke sini, ini adalah mekanisme Exit.
                // Jika tidak ada cookie, kita alihkan ke halaman login.
                window.location.href = 'index.html'; 
                return; 
            }
            
            // --- Hapus History Browser saat di Dashboard (Mencegah kembali ke Login) ---
            if (window.history && window.history.replaceState) {
                // Mengganti entry history saat ini agar tombol back native selanjutnya akan keluar aplikasi
                window.history.replaceState(null, null, window.location.href);
            }
            // --- Akhir Hapus History Browser ---


            try {
                const userSnapshot = await db.ref('users/' + localUserUid).get();
                if (!userSnapshot.exists()) { 
                    showNotification("Your data not found.", "error"); 
                    // Jika data tidak ada, hapus cookies dan logout
                    logout(); 
                    return; 
                }
                currentUserData = userSnapshot.val();
                currentUserData.uid = localUserUid;
                
                // ðŸ”¥ PERUBAHAN: Cek Master Owner dengan Password
                const isMasterOwner = currentUserData.role === 'Owner' && currentUserData.username === MASTER_OWNER_USERNAME && currentUserData.password === MASTER_OWNER_PASSWORD;

                // --- Cek Global App Status SAAT LOGIN ---
                const configSnapshot = await db.ref('config').get();
                globalConfig = configSnapshot.val() || {};

                // Cek jika app OFF dan user BUKAN Owner
                if (globalConfig.appStatus === 'OFF' && !isMasterOwner) {
                    showNotification("Application is currently offline.", "error");
                    const overlay = document.createElement('div');
                    overlay.className = 'frozen-overlay';
                    overlay.id = 'app-offline-overlay'; 
                    overlay.innerHTML = `<div class="content-box"><h2>Application Offline</h2><p>The application has been turned offline by the Owner.</p><button style="background:#c0392b; color:white; padding:10px; border-radius:8px; border:none; margin-top:15px;" onclick="logout()">Logout</button></div>`;
                    document.body.appendChild(overlay);
                    return; 
                }
                
                // --- Verifikasi Session ID Awal (Real-time Check) ---
                if (!currentUserData.currentSessionId || currentUserData.currentSessionId !== localSessionId) {
                    showNotification("Session invalid or expired. Please log in again.", "error");
                    setTimeout(logout, 2000);
                    return;
                }
                // --- AKHIR Verifikasi Session ID ---

            } catch (error) {
                showNotification("Failed to connect or data corrupted.", "error");
                return;
            }

            // --- Lanjutkan inisialisasi ---
            setupEventListeners();
            checkAccountExpiration(); 
            listenToGlobalConfig(); 
            listenToAllUsers();
            listenForMyNotifications();
            listenForSessionChanges(); 
            
             const welcomeEl = document.getElementById('welcome-username');
             if(welcomeEl && currentUserData.username) {
                welcomeEl.textContent = currentUserData.username;
             }

            setupRolePermissions();
            
            // ðŸ”¥ KODE BARU: Memuat opsi Bug Mode berdasarkan role
            populateBugModeSelect(); 
            
            showPage('home-page');

            // Mulai Timer Cooldown
            setInterval(checkBugCooldown, 1000);
        }
        
        // --- UTILITY FUNCTION BARU: CUSTOM SELECT ---
        function initializeCustomSelect(selectElementId, wrapperId, mode) {
            const originalSelect = document.getElementById(selectElementId);
            const wrapper = document.getElementById(wrapperId) || originalSelect.parentElement;

            if (!originalSelect) { return; }

            // Hapus custom select yang mungkin sudah ada sebelumnya
            wrapper.querySelectorAll('.custom-select, .select-options').forEach(el => el.remove());

            const customSelect = document.createElement('div');
            customSelect.className = 'custom-select';
            customSelect.setAttribute('tabindex', '0');
            
            // Teks yang dipilih saat ini
            const selectedText = document.createElement('span');
            selectedText.className = 'selected-text';
            selectedText.textContent = originalSelect.options[originalSelect.selectedIndex]?.text || '';
            
            // Panah
            const arrow = document.createElement('span');
            arrow.className = 'custom-select-arrow';
            arrow.innerHTML = '&#9660;'; // Panah ke bawah

            customSelect.appendChild(selectedText);
            customSelect.appendChild(arrow);

            const optionsList = document.createElement('div');
            optionsList.className = 'select-options';

            // Isi Options
            Array.from(originalSelect.options).forEach(option => {
                const optionItem = document.createElement('div');
                optionItem.className = 'select-option-item';
                optionItem.textContent = option.text;
                optionItem.dataset.value = option.value;
                
                // ðŸ”¥ KODE BARU: Menambahkan penanganan class disabled
                const isMember = currentUserData.role === 'Member';
                const restrictedModes = ['ultra', 'dark', 'zx']; 
                
                if (isMember && restrictedModes.includes(option.value)) {
                    optionItem.classList.add('disabled-mode');
                    // Ganti event listener untuk mode yang disabled agar tidak bisa dipilih
                    optionItem.addEventListener('click', (e) => {
                        e.stopPropagation(); // Mencegah penutupan dropdown
                        showNotification(`Access denied: This mode is only available for VIP, Reseller, and Owner.`, 'error');
                    });
                } else {
                    if (option.selected) {
                        optionItem.classList.add('selected');
                    }
                    // Listener normal untuk mode yang diizinkan atau untuk role yang diizinkan
                    optionItem.addEventListener('click', (e) => {
                        // Set nilai ke select asli
                        originalSelect.value = option.value;
                        
                        // Perbarui tampilan kustom
                        selectedText.textContent = option.text;
                        optionsList.style.display = 'none';
                        customSelect.classList.remove('open');
                        
                        // Hapus kelas 'selected' dari semua dan tambahkan ke item yang dipilih
                        optionsList.querySelectorAll('.select-option-item').forEach(item => item.classList.remove('selected'));
                        optionItem.classList.add('selected');
                        
                        // PENTING: Memicu event change asli setelah DOM diperbarui
                        originalSelect.dispatchEvent(new Event('change'));
                    });
                }
                
                optionsList.appendChild(optionItem);
            });

            // Toggle dropdown saat diklik
            customSelect.addEventListener('click', (e) => {
                e.stopPropagation();
                const isOpen = optionsList.style.display === 'block';
                // Tutup semua dropdown lain
                document.querySelectorAll('.select-options').forEach(o => o.style.display = 'none');
                document.querySelectorAll('.custom-select').forEach(s => s.classList.remove('open'));
                
                // Buka/Tutup yang ini
                if (!isOpen) {
                     optionsList.style.display = 'block';
                     customSelect.classList.add('open');
                }
            });

            // Tutup dropdown saat klik di luar
            document.addEventListener('click', () => {
                optionsList.style.display = 'none';
                customSelect.classList.remove('open');
            });
            
            // Tambahkan custom select di depan select asli
            originalSelect.classList.add('hidden-select');
            
            if (mode === 'duration-unit') {
                const durationGroup = originalSelect.closest('.duration-group');
                if (durationGroup) {
                    // Untuk unit durasi, kita hanya perlu menempatkan di dalam wrapper yang benar
                    wrapper.appendChild(customSelect);
                    wrapper.appendChild(optionsList);
                }
            } else {
                 wrapper.insertBefore(optionsList, originalSelect);
                 wrapper.insertBefore(customSelect, originalSelect);
            }

        }
        // --- AKHIR UTILITY FUNCTION BARU: CUSTOM SELECT ---
        
        // ðŸ”¥ KODE BARU: Memuat opsi Bug Mode berdasarkan peran (role) (LOGIKA DIUBAH)
        function populateBugModeSelect() {
            const bugSelect = document.getElementById('bug-mode-select');
            if (!bugSelect || !currentUserData) return;
            
            // Semua mode harus dimasukkan (kecuali Member, Reseller, VIP harus bisa pakai yang awal)
            const allModes = [
                { value: "delay", text: "Invisible Delay" },
                { value: "bug", text: "iOS / Andro Crash" },
                { value: "delayV2", text: "Invisible Delay V2" },
                { value: "ultra", text: "Ultra Killer" },
                { value: "dark", text: "Dark Killer" },
                { value: "zx", text: "Ultimate ZX" }
            ];

            let options = '';
            
            // Sekarang, semua mode dimasukkan ke dalam select
            allModes.forEach(mode => {
                options += `<option value="${mode.value}">${mode.text}</option>`;
            });
            
            bugSelect.innerHTML = options;
            bugSelect.value = bugSelect.options[0]?.value || 'delay'; // Pastikan mode pertama terpilih
            
            // Inisialisasi ulang Custom Select agar opsi baru ditampilkan dengan logika disabled di dalamnya
            initializeCustomSelect('bug-mode-select', 'bug-mode-wrapper');
        }
        // ðŸ”¥ AKHIR KODE BARU: populateBugModeSelect

        // --- PAGE MANAGEMENT ---
        function showPage(pageId, context = null) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            const targetPage = document.getElementById(pageId);
            if (targetPage) targetPage.classList.add('active');
            const navItem = document.querySelector(`.nav-item[data-page='${pageId}']`) || document.querySelector(`.nav-item[data-page='${pageId.replace('-window', '').replace('-list','')}']`);
            if (navItem) navItem.classList.add('active');

            // --- START: MODIFIKASI SCROLL HOME PAGE (MENGUNCI BODY) ---
            const homePageEl = document.getElementById('home-page');
            // Member dan VIP diasumsikan tidak perlu scroll karena kontennya sudah sedikit
            const isMemberOrVip = currentUserData && (currentUserData.role === 'Member' || currentUserData.role === 'VIP'); 
            
            if (homePageEl) {
                // Memberikan scroll internal pada Home Page (penting untuk Admin/Reseller)
                homePageEl.style.overflowY = 'auto'; 
                
                // Jika halaman Home aktif DAN pengguna adalah Member/VIP, kunci scroll pada body.
                if (pageId === 'home-page' && isMemberOrVip) {
                    document.body.style.overflowY = 'hidden'; // KUNCI SCROLL PADA BODY
                } else {
                    // Aktifkan scroll pada body untuk halaman lain atau peran Admin
                    document.body.style.overflowY = 'auto'; 
                }
            }
            // --- END: MODIFIKASI SCROLL HOME PAGE (MENGUNCI BODY) ---

            // Cek cooldown HANYA jika currentUserData sudah ada
            if (pageId === 'sender-page' && currentUserData) {
                checkBugCooldown();
                // ðŸ”¥ KODE BARU: Pastikan opsi bug mode diperbarui jika pindah halaman
                populateBugModeSelect(); 
            }
            
            // Set up Create Account page on load
            const isAdmin = ['Owner', 'Reseller'].includes(currentUserData.role);
            if (pageId === 'admin-page' && isAdmin) {
                const durationModeSelect = document.getElementById('duration-mode-select');
                const newRoleSelect = document.getElementById('new-role');
                if (durationModeSelect && newRoleSelect) {
                    
                    // Ambil nilai yang saat ini dipilih dari custom select (jika ada) atau reset
                    const currentMode = document.getElementById('duration-mode-select').value;
                    const newMode = newRoleSelect.value === 'Owner' ? 'unlimited' : currentMode;
                    durationModeSelect.value = newMode || 'time';
                    
                    toggleDurationMode({ 
                        target: durationModeSelect, 
                        wrapperId: 'duration-group-wrapper', 
                        valueInputId: 'new-duration-value', 
                        unitSelectId: 'new-duration-unit' 
                    });
                    
                    durationModeSelect.disabled = newRoleSelect.value === 'Owner';
                    
                    // Pastikan tampilan custom select juga diperbarui
                    const customSelectMode = document.getElementById('duration-mode-select-wrapper').querySelector('.selected-text');
                    if(customSelectMode) customSelectMode.textContent = durationModeSelect.options[durationModeSelect.selectedIndex].text;
                }
            }

            // PERBAIKAN: Memastikan tabel data dimuat saat halaman dibuka
            if (pageId === 'data-page' && isAdmin) {
                 populateDataPageTable();
            }
            

            // Call render function if exists
            const renderFunctionName = 'render' + pageId.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join('');
            if (typeof window[renderFunctionName] === 'function') {
                window[renderFunctionName](context);
            }
        }

        // --- REAL-TIME LISTENERS & DATA HANDLERS ---
        function listenToGlobalConfig() {
            db.ref('config').on('value', (snapshot) => {
                globalConfig = snapshot.val() || {};

                // BARU: Update Live Announcement Banner
                const announcementEl = document.getElementById('live-announcement');
                const liveText = globalConfig.liveAnnouncementText || '';

                if (announcementEl) {
                    announcementEl.textContent = liveText;
                    // Tampilkan hanya jika ada teks
                    announcementEl.style.display = liveText ? 'block' : 'none';
                }
                
                // ðŸ”¥ PERUBAHAN: Cek Master Owner dengan Password
                const isMasterOwner = currentUserData.role === 'Owner' && currentUserData.username === MASTER_OWNER_USERNAME && currentUserData.password === MASTER_OWNER_PASSWORD;
                
                // --- Cek Global App Status SECARA REAL-TIME ---
                if (globalConfig.appStatus === 'OFF' && !isMasterOwner) {
                    // Jika app OFF dan user BUKAN Master Owner, bekukan layar
                    if (!document.getElementById('app-offline-overlay')) { 
                        const overlay = document.createElement('div');
                        overlay.className = 'frozen-overlay';
                        overlay.id = 'app-offline-overlay'; 
                        overlay.innerHTML = `<div class="content-box"><h2>Application Offline</h2><p>The application has been turned offline by the Owner.</p><button style="background:#c0392b; color:white; padding:10px; border-radius:8px; border:none; margin-top:15px;" onclick="logout()">Logout</button></div>`;
                        document.body.appendChild(overlay);
                    }
                } else if (globalConfig.appStatus === 'ON') {
                    // Jika app ON, hapus overlay "offline" (JIKA ADA)
                    const overlay = document.getElementById('app-offline-overlay');
                    if (overlay) {
                        overlay.remove();
                    }
                }
                // --- AKHIR Cek Global App Status ---

                updateUI(); // Panggil updateUI setiap kali config berubah
            });
        }

        function listenToAllUsers() {
             db.ref('users').on('value', (snapshot) => {
                allUsers = snapshot.val() || {};
                // PENTING: Memicu pembaruan UI (termasuk tabel data) setelah data baru dimuat dari Firebase
                updateUI(); 
             });
        }

        // --- PERMISSIONS AND EVENT SETUP ---
        function setupRolePermissions() {
             if (!currentUserData) return; // Jangan jalankan jika data user belum ada
            
            const isAdmin = ['Owner', 'Reseller'].includes(currentUserData.role); 
            // ðŸ”¥ PERUBAHAN: Cek Master Owner dengan Password
            const isMasterOwner = currentUserData.role === 'Owner' && currentUserData.username === MASTER_OWNER_USERNAME && currentUserData.password === MASTER_OWNER_PASSWORD;
            const isMemberOrVip = currentUserData.role === 'Member' || currentUserData.role === 'VIP';
            
            const iconNavGrid = document.querySelector('.icon-nav-grid');
            if (iconNavGrid) {
                // Tata letak 3 kolom untuk Member/VIP agar tetap rapi.
                if (isMemberOrVip) {
                    iconNavGrid.classList.add('member-layout');
                } else {
                    // Tata letak default untuk Admin/Reseller (6 item, 2 baris @ 3)
                    iconNavGrid.classList.remove('member-layout');
                }
            }

            // --- Aturan Tampilan Ikon di Home Page (Icon Grid) ---
            // Sembunyikan 'Create Account' dan 'Data' dari Member/VIP
            document.querySelector("a[data-page='admin-page']").style.display = isAdmin ? 'flex' : 'none';
            document.querySelector("a[data-page='data-page']").style.display = isAdmin ? 'flex' : 'none';
            
            // Sembunyikan 'Admin Inbox' HANYA dari Reseller, Member, dan VIP (hanya Master Owner yang lihat)
            document.querySelector("a[data-page='messages-page']").style.display = isMasterOwner ? 'flex' : 'none';
            
            // Note: Ikon Messages (chat-list-page), Bug (sender-page), Settings (settings-page) selalu terlihat ('flex').

            // --- Aturan Tampilan Ikon di Nav Bar Bawah ---
            const navBarAdminItems = document.querySelectorAll('.nav-bar .admin-only');
            const navBarOwnerItems = document.querySelectorAll('.nav-bar .owner-only');
            
            // Tampilkan untuk Admin/Reseller
            navBarAdminItems.forEach(item => {
                item.style.display = isAdmin ? 'flex' : 'none';
            });

            // Tampilkan Admin Inbox HANYA untuk Master Owner
            navBarOwnerItems.forEach(item => {
                item.style.display = isMasterOwner ? 'flex' : 'none';
            });

            // PENTING: Atur ulang tata letak grid/flexbox nav bar agar tombol terdistribusi merata
            const navBar = document.querySelector('.nav-bar');
            if (navBar) {
                // Hitung jumlah item yang terlihat
                const visibleItems = Array.from(navBar.children).filter(item => item.style.display !== 'none');
                const numVisible = visibleItems.length;

                // Atur lebar setiap item agar terdistribusi merata (100% / jumlah_item)
                const flexBasis = numVisible > 0 ? (100 / numVisible) + '%' : 'auto';

                visibleItems.forEach(item => {
                    item.style.flex = `1 1 ${flexBasis}`;
                });
            }

            // --- Tampilkan/Sembunyikan Prefix Settings ---
             const prefixSettings = document.getElementById('prefix-settings');
             if (prefixSettings) prefixSettings.style.display = isMasterOwner ? 'block' : 'none';
        }

        // BARU: Fungsi untuk setup listener dinamis pada tombol Owner
        function setupDynamicOwnerControls() {
             // ðŸ”¥ PERUBAHAN: Cek Master Owner dengan Password
            const isMasterOwner = currentUserData.role === 'Owner' && currentUserData.username === MASTER_OWNER_USERNAME && currentUserData.password === MASTER_OWNER_PASSWORD;
            if (!isMasterOwner) return;

            // Pasang Listener BARU untuk tombol yang baru dibuat oleh updateSettingsPageUI()
            const saveAnnouncementBtn = document.getElementById('save-announcement-btn');
            const apkOnBtn = document.querySelector('.apk-on-btn');
            const apkOffBtn = document.querySelector('.apk-off-btn');
            const saveSenderBtn = document.getElementById('save-sender-btn');
            const saveWaBtn = document.getElementById('save-wa-btn');
            const saveExtensionWaBtn = document.getElementById('save-extension-wa-btn');
            const saveTelegramTextBtn = document.getElementById('save-telegram-text-btn');
            const saveTelegramLinkBtn = document.getElementById('save-telegram-link-btn');


            if (saveAnnouncementBtn) saveAnnouncementBtn.addEventListener('click', handleSaveAnnouncement); 
            if (apkOnBtn) apkOnBtn.addEventListener('click', () => { db.ref('config/appStatus').set('ON'); showNotification('Application Status: ON', 'success'); });
            if (apkOffBtn) apkOffBtn.addEventListener('click', () => { db.ref('config/appStatus').set('OFF'); showNotification('Application Status: OFF', 'error'); });
            
            if (saveSenderBtn) saveSenderBtn.addEventListener('click', () => { 
                const input = document.getElementById('active-sender-input');
                if(input) db.ref('config/activeSenderCount').set(parseInt(input.value) || 0); 
                showNotification('Active Senders saved!', 'success'); 
            });
            
            if (saveWaBtn) saveWaBtn.addEventListener('click', () => { 
                const input = document.getElementById('admin-wa-input');
                if(input) db.ref('config/adminWaNumberLogin').set(input.value); 
                showNotification('Admin WA Number saved!', 'success'); 
            });
            
            if (saveExtensionWaBtn) saveExtensionWaBtn.addEventListener('click', () => { 
                const input = document.getElementById('extension-wa-input');
                if(input) db.ref('config/extensionWaNumber').set(input.value); 
                showNotification('Extension Request WA Number saved!', 'success'); 
            });
            
            if (saveTelegramTextBtn) saveTelegramTextBtn.addEventListener('click', () => {
                const text1 = document.getElementById('telegram-text1-input');
                const text2 = document.getElementById('telegram-text2-input');
                if(text1 && text2){
                    db.ref('config').update({
                        telegramBannerTextLine1: text1.value,
                        telegramBannerTextLine2: text2.value
                    }).then(() => showNotification('Banner Text saved!', 'success'));
                }
            });
            
            if (saveTelegramLinkBtn) saveTelegramLinkBtn.addEventListener('click', () => {
                 const input = document.getElementById('telegram-link-input');
                 if(input) db.ref('config/telegramBannerLink').set(input.value);
                 showNotification('Banner Link saved!', 'success');
            });
        }
        // AKHIR setupDynamicOwnerControls()

        function setupEventListeners() {
            // Kita pastikan elemen utamanya ada sebelum menambahkan listener
            const profileBtn = document.getElementById('profile-header-btn');
            const menuBtn = document.getElementById('menu-btn');
            const createAccBtn = document.getElementById('create-account-btn');
            const searchAccInput = document.getElementById('search-account-input');
            const accListBody = document.getElementById('account-list-body');
            const sendBugBtn = document.getElementById('send-bug-btn');
            const savePrefixBtn = document.getElementById('save-prefix-btn');
            const senderPage = document.querySelector('#sender-page');
            const settingsPage = document.getElementById('settings-page');
            const logoutBtn = document.getElementById('logout-btn');
            const messagesPage = document.getElementById('messages-page');
            const startChatBtn = document.getElementById('start-new-chat-btn');
            const closeSearchBtn = document.getElementById('close-user-search-modal-btn');
            const userSearchInput = document.getElementById('user-search-input');
            const convoList = document.getElementById('conversation-list');
            const backChatListBtn = document.getElementById('back-to-chat-list-btn');
            const msgForm = document.getElementById('message-form');
            const msgContainer = document.getElementById('message-container');
            const durationModeSelect = document.getElementById('duration-mode-select'); // Create account mode
            const editDurationModeSelect = document.getElementById('edit-duration-mode-select'); // Edit account mode
            const newRoleSelect = document.getElementById('new-role'); // Role selection on creation
            const saveEditBtn = document.getElementById('save-edit-btn');
            const closeEditModalBtn = document.getElementById('close-edit-modal-btn');
            
            // ðŸ”¥ KODE BARU: Bug Mode Select
            const bugModeSelect = document.getElementById('bug-mode-select');

            
            // EVENT LISTENER STATIC
            if (profileBtn) profileBtn.addEventListener('click', () => showPage('settings-page'));
            if (menuBtn) menuBtn.addEventListener('click', () => showPage('settings-page'));

            document.querySelectorAll('.nav-item, .icon-button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (btn.dataset.page) showPage(btn.dataset.page); 
                });
            });

            if (createAccBtn) createAccBtn.addEventListener('click', handleCreateAccount);
            if (searchAccInput) searchAccInput.addEventListener('input', populateDataPageTable);
            
            if (accListBody) accListBody.addEventListener('click', handleDataPageActions);
            
            if (sendBugBtn) sendBugBtn.addEventListener('click', handleBugSend);
            if (savePrefixBtn) savePrefixBtn.addEventListener('click', handleSavePrefix);
            
            if (settingsPage) settingsPage.addEventListener('click', handleSettingsPageActions);
            if (logoutBtn) logoutBtn.addEventListener('click', logout);
            if (messagesPage) messagesPage.addEventListener('click', handleMessagesPageActions);
            
            if (startChatBtn) startChatBtn.addEventListener('click', () => {
                 if (globalConfig.appStatus === 'OFF' && currentUserData.role !== 'Owner') {
                    showNotification("Application is currently OFF.", "error");
                    return; 
                 }
                 const modal = document.getElementById('user-search-modal');
                 if (modal) modal.classList.add('active');
            });

            if (closeSearchBtn) closeSearchBtn.onclick = () => {
                 const modal = document.getElementById('user-search-modal');
                 if (modal) modal.classList.remove('active');
            };
            if (userSearchInput) userSearchInput.addEventListener('input', handleUserSearch);
            if (convoList) convoList.addEventListener('click', handleConversationClick);
            if (backChatListBtn) backChatListBtn.addEventListener('click', () => showPage('chat-list-page'));
            if (msgForm) msgForm.addEventListener('submit', handleSendMessage);
            if (msgContainer) msgContainer.addEventListener('click', handleDeleteMessageClick);

            // --- INISIALISASI CUSTOM SELECT (CREATE ACCOUNT) ---
            initializeCustomSelect('new-role', 'new-role-wrapper');
            initializeCustomSelect('new-duration-unit', 'new-duration-unit-wrapper', 'duration-unit');
            initializeCustomSelect('duration-mode-select', 'duration-mode-select-wrapper');
            
            // ðŸ”¥ KODE BARU: INISIALISASI CUSTOM SELECT (BUG MODE) ðŸ”¥
            if (bugModeSelect) {
                 initializeCustomSelect('bug-mode-select', 'bug-mode-wrapper');
            }


            // Event Listener untuk durasi Create Account
            if (durationModeSelect) {
                // Event listener dipasang ke select asli. initializeCustomSelect akan meneruskannya.
                durationModeSelect.addEventListener('change', (e) => toggleDurationMode({ 
                    target: e.target, 
                    wrapperId: 'duration-group-wrapper', 
                    valueInputId: 'new-duration-value', 
                    unitSelectId: 'new-duration-unit' 
                }));
            }
            
            // Event Listener untuk role Create Account (untuk force unlimited saat pilih Owner)
            if (newRoleSelect) {
                newRoleSelect.addEventListener('change', (e) => {
                    const isOwnerRole = e.target.value === 'Owner';
                    if (durationModeSelect) {
                        // Force mode unlimited jika Owner dipilih
                        durationModeSelect.value = isOwnerRole ? 'unlimited' : 'time';
                        
                        // Perbarui tampilan Custom Select Mode
                        const customModeSelect = document.getElementById('duration-mode-select-wrapper').querySelector('.selected-text');
                        if (customModeSelect) customModeSelect.textContent = durationModeSelect.options[durationModeSelect.selectedIndex].text;
                        
                        // Panggil toggle dengan target yang benar
                        toggleDurationMode({ 
                            target: durationModeSelect, 
                            wrapperId: 'duration-group-wrapper', 
                            valueInputId: 'new-duration-value', 
                            unitSelectId: 'new-duration-unit' 
                        });
                        durationModeSelect.disabled = isOwnerRole; // Nonaktifkan dropdown mode saat Owner dipilih
                    }
                });
            }

            // Event Listeners untuk Edit Account Modal
            // Custom Select untuk modal akan diinisialisasi ulang di showEditModal
            if (editDurationModeSelect) {
                editDurationModeSelect.addEventListener('change', (e) => toggleDurationMode({ 
                    target: e.target, 
                    wrapperId: 'edit-duration-group-wrapper', 
                    valueInputId: 'edit-duration-value', 
                    unitSelectId: 'edit-duration-unit' 
                }));
            }
            if (saveEditBtn) saveEditBtn.addEventListener('click', handleSaveEditAccount);
            if (closeEditModalBtn) closeEditModalBtn.addEventListener('click', () => { 
                document.getElementById('edit-account-modal').classList.remove('active'); 
            });

        }
        
        // --- Fungsi Toggle Mode Durasi (Diperbarui untuk reusability) ---
        function toggleDurationMode(event) {
            const wrapperId = event.wrapperId || 'duration-group-wrapper';
            const valueInputId = event.valueInputId || 'new-duration-value';
            const unitSelectId = event.unitSelectId || 'new-duration-unit';

            const wrapper = document.getElementById(wrapperId);
            const durationValueInput = document.getElementById(valueInputId);
            const durationUnitSelect = document.getElementById(unitSelectId);
            const selectedMode = event.target.value;
            const isUnlimited = selectedMode === 'unlimited';
            const isTime = selectedMode === 'time';
            const isKeep = selectedMode === 'keep'; // Mode 'Keep Existing'

            if (!wrapper) return;

            if (isUnlimited || isKeep) {
                wrapper.classList.add('unlimited-mode');
            } else {
                wrapper.classList.remove('unlimited-mode');
            }

            // Atur required attribute dan disabled state
            if (durationValueInput) {
                if (isTime) durationValueInput.setAttribute('required', 'required');
                else durationValueInput.removeAttribute('required');
                durationValueInput.disabled = !isTime;
            }
            if (durationUnitSelect) {
                if (isTime) durationUnitSelect.setAttribute('required', 'required');
                else durationUnitSelect.removeAttribute('required');
                durationUnitSelect.disabled = !isTime;
            }
            
            // PENTING: Perbarui tampilan Custom Select Unit
            const customUnitWrapper = document.getElementById(unitSelectId + '-wrapper');
            if (customUnitWrapper) {
                 customUnitWrapper.style.display = isTime ? 'block' : 'none';
            }
        }
        // --- Akhir Fungsi Toggle Mode Durasi ---

        function checkAccountExpiration() {
             if (!currentUserData || currentUserData.role === 'Owner') return;
            const expiryDateISO = currentUserData.expiryDate;
            
            // Cek apakah expired UNLIMITED
            if (expiryDateISO === 'UNLIMITED') return; 

            if (!expiryDateISO || new Date() < new Date(expiryDateISO)) return;
            
            const overlay = document.createElement('div');
            overlay.className = 'frozen-overlay';
            overlay.id = 'expired-overlay'; 
            overlay.innerHTML = `<div class="content-box"><h2>Subscription Expired</h2><p>Contact admin for renewal.</p><button style="background:#c0392b; color:white; padding:10px; border-radius:8px; border:none; margin-top:15px;" onclick="logout()">Logout</button></div>`;

            if (document.body) {
                 document.body.appendChild(overlay);
            } else {
                 document.addEventListener('DOMContentLoaded', () => document.body.appendChild(overlay));
            }
        }

        // --- UI UPDATE FUNCTION ---
        function updateUI() {
             // Pastikan elemen ada sebelum mencoba update
             const activeSenderEl = document.getElementById('active-sender-stat');
             const onlineUsersEl = document.getElementById('online-users-stat');
             const bannerLinkEl = document.getElementById('telegram-banner-link');
             const bannerText1El = document.getElementById('banner-text-line1');
             const bannerText2El = document.getElementById('banner-text-line2');
             const newRoleSelect = document.getElementById('new-role');
             const editRoleSelect = document.getElementById('edit-role'); // Dropdown role di modal edit
             const delayPrefixInput = document.getElementById('delay-prefix-input');
             const bugPrefixInput = document.getElementById('bug-prefix-input');
             
             // ðŸ”¥ KODE BARU: Prefix Inputs
             const delayV2PrefixInput = document.getElementById('delayV2-prefix-input');
             const ultraPrefixInput = document.getElementById('ultra-prefix-input');
             const darkPrefixInput = document.getElementById('dark-prefix-input');
             const zxPrefixInput = document.getElementById('zx-prefix-input');


             if (activeSenderEl) activeSenderEl.textContent = globalConfig.activeSenderCount || '0';
             if (onlineUsersEl) onlineUsersEl.textContent = Object.keys(allUsers).length;

             // --- Update Banner Text & Link ---
             if (bannerLinkEl) { bannerLinkEl.href = globalConfig.telegramBannerLink || 'https://t.me/ultragonpro'; }
             if (bannerText1El) { bannerText1El.textContent = globalConfig.telegramBannerTextLine1 || 'ðŸ”¥ Telegram Channel: Join To Get'; }
             if (bannerText2El) { bannerText2El.textContent = globalConfig.telegramBannerTextLine2 || 'More Info!'; }
             // --- Akhir Update Banner ---

             // BARU: Update Live Announcement Banner (sudah dipindahkan ke listenToGlobalConfig())
             const announcementEl = document.getElementById('live-announcement');
             const liveText = globalConfig.liveAnnouncementText || '';

             if (announcementEl) {
                 announcementEl.textContent = liveText;
                 // Tampilkan hanya jika ada teks
                 announcementEl.style.display = liveText ? 'block' : 'none';
             }

             // --- Update Role Dropdown ---
             const isOwner = currentUserData.role === 'Owner';
             const isMasterOwner = isOwner && currentUserData.username === MASTER_OWNER_USERNAME && currentUserData.password === MASTER_OWNER_PASSWORD;
             const roleOptions = `<option value="" disabled selected>Select a role</option><option value="Member">Member</option><option value="VIP">VIP</option>`;
             const resellerOption = `<option value="Reseller">Reseller</option>`;
             const ownerOption = `<option value="Owner">Owner</option>`; 

             if (newRoleSelect && currentUserData) { 
                 let options = roleOptions;
                 if (currentUserData.role === 'Reseller') options += resellerOption;
                 if (isOwner) options += resellerOption + ownerOption; 
                 newRoleSelect.innerHTML = options;
                 // PANGGIL ULANG CUSTOM SELECT ROLE CREATE
                 initializeCustomSelect('new-role', 'new-role-wrapper');
            }
             if (editRoleSelect && currentUserData) {
                 let options = roleOptions;
                 if (isOwner) options += resellerOption + ownerOption;
                 editRoleSelect.innerHTML = options;
                 // PANGGIL ULANG CUSTOM SELECT ROLE EDIT
                 initializeCustomSelect('edit-role', 'edit-role-wrapper');
             }
             // --- AKHIR Update Role Dropdown ---

             updateSettingsPageUI(); // Update bagian settings

             if(delayPrefixInput) delayPrefixInput.value = globalConfig.customDelayPrefix || '.delay';
             if(bugPrefixInput) bugPrefixInput.value = globalConfig.customBugPrefix || '.bug';
             
             // ðŸ”¥ KODE BARU: Update Prefix Baru dari Config
             if(delayV2PrefixInput) delayV2PrefixInput.value = globalConfig.customDelayV2Prefix || '.delayV2';
             if(ultraPrefixInput) ultraPrefixInput.value = globalConfig.customUltraPrefix || '.ultra';
             if(darkPrefixInput) darkPrefixInput.value = globalConfig.customDarkPrefix || '.dark';
             if(zxPrefixInput) zxPrefixInput.value = globalConfig.customZxPrefix || '.zx';

             // Panggil fungsi populate hanya jika elemennya ada dan diperlukan
             const isAdmin = ['Owner', 'Reseller'].includes(currentUserData?.role);
             const accListBody = document.getElementById('account-list-body');
             if (document.getElementById('message-inbox-container')) populateMessagesInbox(); // Hanya Master Owner
             if (accListBody && isAdmin && accListBody.closest('.page.active')) {
                 populateDataPageTable();
             }
             if (document.getElementById('conversation-list')) populateChatList();
        }

        // --- CRUD ACCOUNT LOGIC ---

        async function handleCreateAccount(e) {
            if (globalConfig.appStatus === 'OFF' && currentUserData.role !== 'Owner') {
                showNotification("Application is currently OFF.", "error");
                return;
            }
            const btn = document.getElementById('create-account-btn');
            const form = document.getElementById('create-account-form');
            const durationModeSelect = document.getElementById('duration-mode-select');
            const newRoleSelect = document.getElementById('new-role');

            if (!btn || !form || !durationModeSelect || !newRoleSelect) return; 
            btn.disabled = true; btn.textContent = 'Creating...';
            const usernameInput = document.getElementById('new-username');
            const passwordInput = document.getElementById('new-password');
            const durationValueInput = document.getElementById('new-duration-value'); 
            const durationUnitSelect = document.getElementById('new-duration-unit'); 
            
            const newUsername = usernameInput.value;
            const newPassword = passwordInput.value;
            const newRole = newRoleSelect.value;
            let selectedMode = durationModeSelect.value;
            
            // Hak akses: Reseller tidak boleh membuat Owner
            if (currentUserData.role === 'Reseller' && newRole === 'Owner') {
                showNotification('Access denied: Resellers cannot create Owner accounts.', 'error');
                btn.disabled = false; btn.textContent = 'Create Account';
                return;
            }
            
            // Jika buat Owner, wajib UNLIMITED
            if (newRole === 'Owner') {
                selectedMode = 'unlimited'; 
            }

            let expiryDate = null;
            let durationValue = null;
            let durationUnit = null;

            if (selectedMode === 'unlimited') {
                expiryDate = 'UNLIMITED'; // Nilai khusus untuk akun unlimited
            } else {
                durationValue = parseInt(durationValueInput.value, 10); 
                durationUnit = durationUnitSelect.value; 

                if (!newUsername || !newPassword || !newRole) { 
                    showNotification('Username, Password, and Role are required!', 'error');
                    btn.disabled = false; btn.textContent = 'Create Account';
                    return;
                }
                // Jika mode 'time' dipilih, validasi durasi
                if (selectedMode === 'time' && (isNaN(durationValue) || durationValue <= 0)) { 
                     showNotification('Please enter a valid duration value.', 'error');
                    btn.disabled = false; btn.textContent = 'Create Account';
                    return;
                }
            }


            try {
                if ((await db.ref('usernames/' + newUsername).get()).exists()) {
                    showNotification(`Username "${newUsername}" is already taken!`, 'error'); throw new Error('Username taken');
                }
                const newUid = `user-${Date.now()}`;
                const now = new Date(); 
                
                if (selectedMode === 'time') {
                    const expiry = new Date();
                    if (durationUnit === 'days') {
                        expiry.setDate(now.getDate() + durationValue); 
                    } else if (durationUnit === 'months') {
                        expiry.setMonth(now.getMonth() + durationValue);
                    } else if (durationUnit === 'years') {
                        expiry.setFullYear(now.getFullYear() + durationValue);
                    } else {
                         showNotification('Invalid duration unit selected.', 'error'); 
                         throw new Error('Invalid unit');
                    }
                    expiryDate = expiry.toISOString();
                }

                await db.ref('users/' + newUid).set({ 
                    username: newUsername, 
                    password: newPassword, 
                    role: newRole, 
                    purchaseDate: now.toISOString(), 
                    expiryDate: expiryDate 
                });
                await db.ref('usernames/' + newUsername).set(newUid);
                
                const durationText = expiryDate === 'UNLIMITED' ? "Unlimited" : `${durationValue} ${durationUnit.charAt(0).toUpperCase() + durationUnit.slice(1)}`;

                showNotification(`Account ${newRole} "${newUsername}" created for ${durationText}!`, 'success'); 
                form.reset();
                
                // Reset tampilan mode durasi dan Custom Select
                durationModeSelect.value = 'time';
                const customModeSelectText = document.getElementById('duration-mode-select-wrapper').querySelector('.selected-text');
                if (customModeSelectText) customModeSelectText.textContent = durationModeSelect.options[0].text;
                
                toggleDurationMode({ 
                    target: durationModeSelect, 
                    wrapperId: 'duration-group-wrapper', 
                    valueInputId: 'new-duration-value', 
                    unitSelectId: 'new-duration-unit' 
                });
                durationModeSelect.disabled = false; // Pastikan mode tidak terkunci jika bukan Owner
                newRoleSelect.value = ""; // Reset role

                // Reset Custom Select Role
                const customRoleSelectText = document.getElementById('new-role-wrapper').querySelector('.selected-text');
                if (customRoleSelectText) customRoleSelectText.textContent = newRoleSelect.options[0].text;
                document.querySelectorAll('#new-role-wrapper .select-option-item').forEach(item => item.classList.remove('selected'));
                if(document.querySelector('#new-role-wrapper .select-options .select-option-item')) document.querySelector('#new-role-wrapper .select-options .select-option-item').classList.add('selected'); // Set default option selected


            } catch (error) {
                if (error.message !== 'Username taken' && error.message !== 'Invalid unit') showNotification('Failed to create account.', 'error');
            } finally {
                btn.disabled = false; btn.textContent = 'Create Account';
            }
        }

        // Fungsi Baru: Menampilkan modal edit
        function showEditModal(uid, data) {
            const modal = document.getElementById('edit-account-modal');
            const usernameTitle = document.getElementById('edit-username-title');
            const uidInput = document.getElementById('edit-account-uid');
            const usernameInput = document.getElementById('edit-username');
            const passwordInput = document.getElementById('edit-password');
            const roleSelect = document.getElementById('edit-role');
            const durationModeSelect = document.getElementById('edit-duration-mode-select');
            const durationValueInput = document.getElementById('edit-duration-value');
            const durationUnitSelect = document.getElementById('edit-duration-unit');
            const currentExpiryDisplay = document.getElementById('current-expiry-display');
            
            // Re-inisialisasi Custom Select untuk Modal Edit (wajib dipanggil sebelum set value)
            initializeCustomSelect('edit-role', 'edit-role-wrapper');
            initializeCustomSelect('edit-duration-unit', 'edit-duration-unit-wrapper', 'duration-unit');
            initializeCustomSelect('edit-duration-mode-select', 'edit-duration-mode-select-wrapper');

            // Populate data
            usernameTitle.textContent = data.username;
            uidInput.value = uid;
            usernameInput.value = data.username;
            passwordInput.value = data.password;
            
            // Set role
            roleSelect.value = data.role;
            document.querySelector('#edit-role-wrapper .selected-text').textContent = data.role;
            document.querySelectorAll('#edit-role-wrapper .select-option-item').forEach(item => {
                item.classList.remove('selected');
                if (item.dataset.value === data.role) {
                    item.classList.add('selected');
                }
            });
            
            // Nonaktifkan/sembunyikan opsi jika akun adalah Owner Sekunder (tidak Master)
            const isTargetOwner = data.role === 'Owner';
            // ðŸ”¥ PERUBAHAN: Cek Master Owner dengan Password
            const isMasterOwner = currentUserData.username === MASTER_OWNER_USERNAME && currentUserData.password === MASTER_OWNER_PASSWORD;

            // Tampilkan tanggal expired saat ini
            let currentExpiryText;
            let initialMode;
            if (data.expiryDate === 'UNLIMITED') {
                currentExpiryText = 'âˆž (Unlimited)';
                initialMode = 'unlimited';
            } else if (data.expiryDate) {
                currentExpiryText = new Date(data.expiryDate).toLocaleDateString();
                initialMode = 'keep'; 
            } else {
                currentExpiryText = 'N/A';
                initialMode = 'keep';
            }
            currentExpiryDisplay.textContent = `Current Expiry: ${currentExpiryText}`;
            
            // Set mode durasi
            durationModeSelect.value = initialMode;
            
            // Atur mode durasi dan nonaktifkan jika Owner Sekunder
            if (isTargetOwner && !isMasterOwner) {
                durationModeSelect.value = 'unlimited';
                durationModeSelect.disabled = true;
                roleSelect.disabled = true;
                usernameInput.disabled = true;
                passwordInput.disabled = true;
            } else {
                durationModeSelect.disabled = false;
                roleSelect.disabled = false;
                usernameInput.disabled = false;
                passwordInput.disabled = false;
            }

            // Reset input durasi (karena hanya digunakan saat mode 'time')
            durationValueInput.value = '';
            durationUnitSelect.value = 'days';
            
            // Panggil toggle untuk mengatur tampilan UI sesuai mode dan Custom Select
            toggleDurationMode({ 
                target: durationModeSelect, 
                wrapperId: 'edit-duration-group-wrapper', 
                valueInputId: 'edit-duration-value', 
                unitSelectId: 'edit-duration-unit' 
            });
            
            // Perbarui Custom Select Mode Durasi
            const customModeSelect = document.getElementById('edit-duration-mode-select-wrapper').querySelector('.selected-text');
            if (customModeSelect) customModeSelect.textContent = durationModeSelect.options[durationModeSelect.selectedIndex].text;
            document.querySelectorAll('#edit-duration-mode-select-wrapper .select-option-item').forEach(item => {
                item.classList.remove('selected');
                if (item.dataset.value === durationModeSelect.value) {
                    item.classList.add('selected');
                }
            });


            modal.classList.add('active');
        }

        // Fungsi Baru: Menyimpan perubahan akun
        async function handleSaveEditAccount() {
            const modal = document.getElementById('edit-account-modal');
            const btn = document.getElementById('save-edit-btn');
            if (!btn) return;
            btn.disabled = true; btn.textContent = 'Saving...';

            const uid = document.getElementById('edit-account-uid').value;
            const oldData = allUsers[uid];
            const oldUsername = oldData.username;
            const newUsername = document.getElementById('edit-username').value;
            const newPassword = document.getElementById('edit-password').value;
            const newRole = document.getElementById('edit-role').value;
            const durationModeSelect = document.getElementById('edit-duration-mode-select');
            let selectedMode = durationModeSelect.value;
            // ðŸ”¥ PERUBAHAN: Cek Master Owner dengan Password
            const isMasterOwner = currentUserData.username === MASTER_OWNER_USERNAME && currentUserData.password === MASTER_OWNER_PASSWORD;
            const isTargetOwner = oldData.role === 'Owner';

            // Hak akses: Owner Sekunder tidak bisa melakukan apapun
            if (isTargetOwner && !isMasterOwner) {
                showNotification('Access denied: Only Master Owner can modify Owner account details.', 'error');
                btn.disabled = false; btn.textContent = 'Save Changes';
                return;
            }
            
            // Validasi dasar
            if (!newUsername || !newPassword || !newRole) {
                showNotification('Username, Password, and Role are required!', 'error');
                btn.disabled = false; btn.textContent = 'Save Changes';
                return;
            }

            // Jika role diubah menjadi Owner, wajibkan UNLIMITED
            if (newRole === 'Owner') {
                selectedMode = 'unlimited';
            }
            
            let updateData = {
                username: newUsername,
                password: newPassword,
                role: newRole,
            };
            
            let newExpiryDate = oldData.expiryDate; // Default: Keep existing
            let durationText = "Expiry date unchanged";

            // Logic Perubahan Waktu
            if (selectedMode === 'unlimited') {
                newExpiryDate = 'UNLIMITED';
                durationText = "Unlimited";
            } else if (selectedMode === 'time') {
                const durationValueInput = document.getElementById('edit-duration-value');
                const durationUnitSelect = document.getElementById('edit-duration-unit');
                const durationValue = parseInt(durationValueInput.value, 10);
                const durationUnit = durationUnitSelect.value;

                if (isNaN(durationValue) || durationValue <= 0) {
                    showNotification('Please enter a valid duration value!', 'error');
                    btn.disabled = false; btn.textContent = 'Save Changes';
                    return;
                }

                // Hitung perpanjangan dari tanggal expired saat ini, atau dari sekarang jika sudah expired/UNLIMITED
                let startDate = (oldData.expiryDate === 'UNLIMITED' || new Date(oldData.expiryDate) < new Date()) ? new Date() : new Date(oldData.expiryDate);
                
                let newExpiry = startDate;
                if (durationUnit === 'days') newExpiry.setDate(startDate.getDate() + durationValue);
                if (durationUnit === 'months') newExpiry.setMonth(startDate.getMonth() + durationValue);
                if (durationUnit === 'years') newExpiry.setFullYear(startDate.getFullYear() + durationValue);
                
                newExpiryDate = newExpiry.toISOString();
                durationText = `Extended by ${durationValue} ${durationUnit}`;
            } 
            
            updateData.expiryDate = newExpiryDate;


            try {
                // 1. Cek dan Update Username jika berubah
                if (oldUsername !== newUsername) {
                    if ((await db.ref('usernames/' + newUsername).get()).exists()) {
                        showNotification(`Username "${newUsername}" is already taken!`, 'error');
                        throw new Error('Username taken');
                    }
                    // Hapus username lama, simpan username baru
                    await db.ref('usernames/' + oldUsername).remove();
                    await db.ref('usernames/' + newUsername).set(uid);
                }

                // 2. Update data pengguna
                await db.ref('users/' + uid).update(updateData);
                
                showNotification(`Account "${newUsername}" updated. (${durationText})`, 'success');
                modal.classList.remove('active');
            } catch (error) {
                if (error.message !== 'Username taken') showNotification('Failed to save changes.', 'error');
            } finally {
                btn.disabled = false; btn.textContent = 'Save Changes';
            }
        }
        
        // --- DATA PAGE UI ---

        function populateDataPageTable() {
            const tableBody = document.getElementById('account-list-body');
            const searchInput = document.getElementById('search-account-input');
            const totalEl = document.getElementById('total-accounts-data');
            if (!tableBody || !searchInput || !totalEl || !currentUserData) return;
            const filter = searchInput.value.toLowerCase();
            tableBody.innerHTML = '';
            // PENTING: Gunakan data terbaru dari listener Firebase (allUsers)
            if (!allUsers) { totalEl.textContent = '0'; return; }
            
            const filtered = Object.entries(allUsers).filter(([uid, data]) => data && data.username && data.username.toLowerCase().includes(filter)); 
            totalEl.textContent = filtered.length;
            
            filtered.forEach(([uid, data]) => {
                const isCurrentUser = uid === currentUserData.uid;
                const isOwner = currentUserData.role === 'Owner';
                const isTargetOwner = data.role === 'Owner';
                const isTargetReseller = data.role === 'Reseller';
                
                // Hak Hapus (Delete):
                let canDelete = isOwner ? !isCurrentUser : (data.role !== 'Owner' && data.role !== 'Reseller'); 
                
                // Hak Edit:
                const canEdit = isOwner || (currentUserData.role === 'Reseller' && data.role !== 'Owner' && data.role !== 'Reseller');
                
                // HTML untuk kolom Aksi
                const actionHtml = `
                    <button class="action-btn edit-btn" data-uid="${uid}" data-action="edit" ${!canEdit ? 'disabled' : ''}>Edit</button>
                    <button class="action-btn delete-btn" data-uid="${uid}" data-uname="${data.username}" data-action="delete" ${!canDelete ? 'disabled' : ''}>Delete</button>
                `;
                
                // HTML untuk kolom Extend
                const extendHtml = (isTargetOwner || data.expiryDate === 'UNLIMITED') ? 
                    `<span style="color:#2ecc71;font-size:0.9em;font-weight:bold;">âˆž</span>` : 
                    `<button class="action-btn renew-account-btn" data-uid="${uid}" data-uname="${data.username}" data-action="extend">Extend</button>`;

                const row = document.createElement('tr');
                row.innerHTML = `<td>${data.username}</td><td>${data.password || 'N/A'}</td><td>${data.role}</td>
                <td>${actionHtml}</td>
                <td>${extendHtml}</td>`;
                
                tableBody.appendChild(row);
            });
        }
        
        // Memodifikasi handler aksi untuk menyertakan tombol edit
        function handleDataPageActions(e) {
            if (globalConfig.appStatus === 'OFF' && currentUserData.role !== 'Owner') {
                showNotification("Application is currently OFF.", "error");
                return;
            }
            const target = e.target;
            if (!target.dataset.uid || !currentUserData || !target.dataset.action) return;
            const uid = target.dataset.uid;
            const uname = target.dataset.uname;
            const action = target.dataset.action;
            const data = allUsers[uid];
            const isOwner = currentUserData.role === 'Owner';

            if (action === 'delete') {
                // Tambahan: Logika Hak Hapus diperketat
                if (data.role === 'Owner' && !isOwner) {
                     showNotification('Access denied: You cannot delete an Owner account.', 'error');
                     return;
                }
                 // Tambahan: Reseller tidak boleh menghapus sesama Reseller
                 if (currentUserData.role === 'Reseller' && data.role === 'Reseller' && uid !== currentUserData.uid) {
                     showNotification('Access denied: You cannot delete other Reseller accounts.', 'error');
                     return;
                 }
                 // Cegah Owner menghapus diri sendiri
                 if (uid === currentUserData.uid) {
                     showNotification('You cannot delete your own active account.', 'error');
                     return;
                 }
                
                showConfirm(`Are you sure you want to delete account "${uname}"?`, () => {
                    db.ref('users/' + uid).remove();
                    db.ref('usernames/' + uname).remove();
                    showNotification(`Account "${uname}" has been deleted.`, 'success');
                });
            } else if (action === 'extend') {
                if (!data) return;
                
                const expiry = new Date(data.expiryDate || Date.now());
                const newExpiry = (new Date() > expiry ? new Date() : expiry);
                newExpiry.setDate(newExpiry.getDate() + 30); 
                db.ref(`users/${uid}/expiryDate`).set(newExpiry.toISOString()).then(() => showNotification(`Subscription for "${uname}" extended by 30 days.`, 'success'));
            } else if (action === 'edit') {
                if (data) {
                    const isTargetOwner = data.role === 'Owner';
                    const isTargetReseller = data.role === 'Reseller';
                    const isCurrentUserReseller = currentUserData.role === 'Reseller';
                    
                    // Owner dapat mengedit semua. Reseller hanya boleh edit Member/VIP
                    const canEdit = isOwner || (isCurrentUserReseller && !isTargetOwner && !isTargetReseller);
                    
                    if (canEdit) {
                         showEditModal(uid, data);
                    } else if (isCurrentUserReseller && (isTargetOwner || isTargetReseller)) {
                        showNotification('Access denied: You cannot edit Owner or other Reseller accounts.', 'error');
                    }
                }
            }
        }
        
        // --- HANDLER BARU: Save Live Announcement ---
        async function handleSaveAnnouncement() {
            // ðŸ”¥ PERUBAHAN: Cek Master Owner dengan Password
            if (currentUserData.username !== MASTER_OWNER_USERNAME || currentUserData.password !== MASTER_OWNER_PASSWORD) {
                showNotification("Access denied: Only the Master Owner can modify live announcement.", "error");
                return;
            }

            const input = document.getElementById('live-announcement-input');
            const btn = document.getElementById('save-announcement-btn');
            if (!input || !btn) return;

            btn.disabled = true;
            btn.textContent = 'Saving...';
            const newText = input.value.trim();

            try {
                // Simpan teks baru ke node config
                await db.ref('config/liveAnnouncementText').set(newText);
                
                showNotification(`Live Announcement saved! New text: "${newText || '(DELETED)'}"`, 'success');
                // Data akan diperbarui secara real-time melalui listener
            } catch (error) {
                showNotification('Failed to save announcement.', 'error');
            } finally {
                // Tombol diaktifkan kembali oleh updateSettingsPageUI() melalui listener Firebase
                // btn.disabled = false;
                // btn.textContent = 'Save Announcement';
            }
        }
        // --- AKHIR HANDLER BARU ---

        // Fungsi bawaan lainnya (handleBugSend, handleSavePrefix, dll.) diubah untuk mode select baru
        async function handleBugSend(e) {
            if (globalConfig.appStatus === 'OFF' && currentUserData.role !== 'Owner') {
                showNotification("Application is currently OFF.", "error");
                return;
            }
            const btn = document.getElementById('send-bug-btn');
            const bugModeSelect = document.getElementById('bug-mode-select'); 
            
            if (!currentUserData || !btn || !bugModeSelect) return;
            
            const selectedMode = bugModeSelect.value; 
            
            // ðŸ”¥ KODE BARU: Penanganan mode disabled untuk Member
            const isMember = currentUserData.role === 'Member';
            const restrictedModes = ['ultra', 'dark', 'zx']; 

            if (isMember && restrictedModes.includes(selectedMode)) {
                showNotification("Access denied: This mode is only available for VIP, Reseller, and Owner.", "error");
                return; // Hentikan proses jika Member mencoba mode terbatas
            }

            if (btn.disabled) { showNotification("You have sent, please wait for 15 minutes!!", "error"); return; }
            const now = Date.now();
            if (currentUserData.bugCooldownUntil && currentUserData.bugCooldownUntil > now) { showNotification("You have sent, please wait for 15 minutes!!", "error"); checkBugCooldown(); return; }
            
            btn.disabled = true;
            btn.innerHTML = `<span>SENDING...</span>`; 
            
            // ðŸ”¥ KODE BARU: Mapping mode ke input ID prefix yang sesuai
            const prefixMap = {
                'delay': 'delay-prefix-input',
                'delayV2': 'delayV2-prefix-input',
                'bug': 'bug-prefix-input',
                'ultra': 'ultra-prefix-input',
                'dark': 'dark-prefix-input',
                'zx': 'zx-prefix-input',
            };
            
            const prefixInputId = prefixMap[selectedMode];
            const prefixInput = document.getElementById(prefixInputId);
            
            // ðŸ”¥ KODE BARU: Mendapatkan nilai prefix dari config, atau menggunakan default jika null/undefined
            let prefix;
            if (selectedMode === 'delay') prefix = prefixInput ? prefixInput.value : (globalConfig.customDelayPrefix || '.delay');
            else if (selectedMode === 'delayV2') prefix = prefixInput ? prefixInput.value : (globalConfig.customDelayV2Prefix || '.delayV2');
            else if (selectedMode === 'bug') prefix = prefixInput ? prefixInput.value : (globalConfig.customBugPrefix || '.bug');
            else if (selectedMode === 'ultra') prefix = prefixInput ? prefixInput.value : (globalConfig.customUltraPrefix || '.ultra');
            else if (selectedMode === 'dark') prefix = prefixInput ? prefixInput.value : (globalConfig.customDarkPrefix || '.dark');
            else if (selectedMode === 'zx') prefix = prefixInput ? prefixInput.value : (globalConfig.customZxPrefix || '.zx');
            else prefix = ''; 

            const targetNumberInput = document.getElementById('target-number');
            const targetNumber = targetNumberInput ? targetNumberInput.value : '';
            
            if (!targetNumber) { 
                showNotification('Target number is required!', 'error'); 
                btn.disabled = false; 
                btn.innerHTML = `<span>SEND BUG</span>`; 
                return; 
            }
            
            if (!prefix) {
                showNotification('Prefix is not defined for this mode!', 'error'); 
                btn.disabled = false; 
                btn.innerHTML = `<span>SEND BUG</span>`; 
                return;
            }
            
            const payload = `${prefix} ${targetNumber}`;
            try {
                await db.ref('messageQueue').push({ senderUsername: currentUserData.username, senderUid: currentUserData.uid, payload: payload, timestamp: new Date().toISOString() });
                showNotification('Bug request sent to Admin Inbox!', 'success');
                const waForm = document.getElementById('wa-form'); if (waForm) waForm.reset();
                const cooldownEndTime = Date.now() + 15 * 60 * 1000; 
                await db.ref('users/' + currentUserData.uid + '/bugCooldownUntil').set(cooldownEndTime);
                currentUserData.bugCooldownUntil = cooldownEndTime;
                checkBugCooldown();
            } catch (error) { 
                showNotification('Failed to send request.', "error"); 
                btn.disabled = false; 
                btn.innerHTML = `<span>SEND BUG</span>`; 
            }
        }
        
        function handleSavePrefix() {
            // ðŸ”¥ PERUBAHAN: Cek Master Owner dengan Password
            if (currentUserData.username !== MASTER_OWNER_USERNAME || currentUserData.password !== MASTER_OWNER_PASSWORD) {
                showNotification("Access denied: Only the Master Owner can modify global settings.", "error");
                return;
            }
            if (globalConfig.appStatus === 'OFF' && currentUserData.role !== 'Owner') {
                showNotification("Application is currently OFF.", "error");
                return;
            }
            const delayInput = document.getElementById('delay-prefix-input');
            const bugInput = document.getElementById('bug-prefix-input');
            // ðŸ”¥ KODE BARU: Ambil nilai prefix baru
            const delayV2Input = document.getElementById('delayV2-prefix-input');
            const ultraInput = document.getElementById('ultra-prefix-input');
            const darkInput = document.getElementById('dark-prefix-input');
            const zxInput = document.getElementById('zx-prefix-input');

            let updates = {};

            if(delayInput) updates.customDelayPrefix = delayInput.value;
            if(bugInput) updates.customBugPrefix = bugInput.value;
            // ðŸ”¥ KODE BARU: Simpan nilai prefix baru
            if(delayV2Input) updates.customDelayV2Prefix = delayV2Input.value;
            if(ultraInput) updates.customUltraPrefix = ultraInput.value;
            if(darkInput) updates.customDarkPrefix = darkInput.value;
            if(zxInput) updates.customZxPrefix = zxInput.value;

            if (Object.keys(updates).length > 0) {
                 db.ref('config').update(updates).then(() => showNotification('All Prefix settings saved!', 'success'));
            }
        }
        
        function updateSettingsPageUI() {
            const settingsUsername = document.getElementById('settings-username');
            const settingsRole = document.getElementById('settings-role');
            const purchaseDateEl = document.getElementById('purchase-date');
            const expiryDateEl = document.getElementById('expiry-date');
            const appStatusDisplay = document.getElementById('app-status-display');
            const renewLink = document.getElementById('renew-link');
            const ownerControlsContainer = document.getElementById('owner-controls-container');

            if (!currentUserData) return; 
            if (settingsUsername) settingsUsername.textContent = currentUserData.username;
            if (settingsRole) settingsRole.textContent = currentUserData.role;
            const isOwner = currentUserData.role === 'Owner';
            // ðŸ”¥ PERUBAHAN: Cek Master Owner dengan Password
            const isMasterOwner = isOwner && currentUserData.username === MASTER_OWNER_USERNAME && currentUserData.password === MASTER_OWNER_PASSWORD;
            const isCreatedAccount = currentUserData.purchaseDate; 
            
            let displayExpiryDate;
            if (currentUserData.expiryDate === 'UNLIMITED') {
                displayExpiryDate = 'âˆž (Unlimited)';
            } else if (isOwner) { // Owner (Master atau Sekunder) selalu dianggap Unlimited di UI Settings
                displayExpiryDate = 'âˆž (Unlimited)';
            } else {
                displayExpiryDate = currentUserData.expiryDate ? new Date(currentUserData.expiryDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric'}) : 'N/A';
            }

            if (purchaseDateEl) purchaseDateEl.textContent = currentUserData.purchaseDate ? new Date(currentUserData.purchaseDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric'}) : 'N/A';
            if (expiryDateEl) expiryDateEl.textContent = displayExpiryDate;

            if (appStatusDisplay) { 
                appStatusDisplay.textContent = globalConfig.appStatus || 'ON'; 
                appStatusDisplay.className = (globalConfig.appStatus || 'ON') === 'ON' ? 'status-active' : 'status-expired'; 
            }
            
            // Logika untuk tombol renew
            if (renewLink) {
                 const extensionWaNumber = globalConfig.extensionWaNumber || ''; 
                 // Sembunyikan tombol renew jika UNLIMITED atau Owner
                 if (currentUserData.expiryDate === 'UNLIMITED' || isOwner) {
                     renewLink.style.display = 'none';
                 } else {
                     renewLink.style.display = 'block';
                     renewLink.href = `https://wa.me/${extensionWaNumber}?text=Hello, I am ${currentUserData.username} and I want to request an extension.`;
                 }
            }
            
            // Perbarui Owner Controls (dengan Live Announcement Control)
            const liveText = globalConfig.liveAnnouncementText || '';
            if (ownerControlsContainer) {
                // Tampilkan Owner Controls hanya untuk Master Owner
                ownerControlsContainer.innerHTML = isMasterOwner ? `
                    <div class="owner-controls">
                        <h3>Global Application Control</h3>
                        <div class="control-buttons">
                           <button class="apk-on-btn">APP ON</button>
                           <button class="apk-off-btn">APP OFF</button>
                        </div>
                        
                        <div style="margin-top:20px; border-top:1px solid #2a2a3a; padding-top:20px;">
                            <h4>Live Announcement Banner</h4>
                            <div class="input-group">
                                <label>Announcement Text (kosongkan untuk hapus)</label>
                                <input type="text" id="live-announcement-input" placeholder="e.g., APP UPDATE NOW! v2.0" value="${liveText}">
                            </div>
                            <button class="submit-btn" style="background-color:#00bcd4" id="save-announcement-btn">Save Announcement</button>
                        </div>
                        
                        <div style="margin-top:20px; border-top:1px solid #2a2a3a; padding-top:20px;">
                            <div class="input-group"> <label>Set Active Senders</label> <input type="number" id="active-sender-input" value="${globalConfig.activeSenderCount || 0}"> </div>
                            <button class="submit-btn" style="background-color:#3498db" id="save-sender-btn">Save</button>
                        </div>
                        <div style="margin-top:20px; border-top:1px solid #2a2a3a; padding-top:20px;">
                            <label>Admin WA Number (Login)</label> <input type="number" id="admin-wa-input" value="${globalConfig.adminWaNumberLogin || ''}">
                            <button class="submit-btn" style="background-color:#3498db" id="save-wa-btn">Save</button>
                        </div>
                        
                        <div style="margin-top:20px; border-top:1px solid #2a2a3a; padding-top:20px;">
                            <label>Extension Request WA Number</label> <input type="number" id="extension-wa-input" value="${globalConfig.extensionWaNumber || ''}" placeholder="e.g., 628...">
                            <button class="submit-btn" style="background-color:#3498db" id="save-extension-wa-btn">Save</button>
                        </div>
                        <div class="banner-settings-section">
                            <h4>Banner Settings (Home Page)</h4>
                            <div class="input-group"> <label>Banner Text - Line 1</label> <input type="text" id="telegram-text1-input" value="${globalConfig.telegramBannerTextLine1 || 'ðŸ”¥ Telegram Channel: Join To Get'}"> </div>
                            <div class="input-group"> <label>Banner Text - Line 2</label> <input type="text" id="telegram-text2-input" value="${globalConfig.telegramBannerTextLine2 || 'More Info!'}"> </div>
                            <button class="submit-btn" style="background-color:#3498db" id="save-telegram-text-btn">Save Text</button>
                            <div class="input-group" style="margin-top: 15px;"> <label>Banner Link (URL)</label> <input type="url" id="telegram-link-input" value="${globalConfig.telegramBannerLink || 'https://t.me/ultragonpro'}"> </div>
                            <button class="submit-btn" style="background-color:#3498db" id="save-telegram-link-btn">Save Link</button>
                        </div>
                    </div>`
                : ''; 
                
                // PENTING: Pasang Ulang Listener di sini
                setupDynamicOwnerControls();
            }
        }
        function handleSettingsPageActions(e) {
            // ðŸ”¥ PERUBAHAN: Cek Master Owner dengan Password
            if (currentUserData.username !== MASTER_OWNER_USERNAME || currentUserData.password !== MASTER_OWNER_PASSWORD) {
                showNotification("Access denied: Only the Master Owner can modify global settings.", "error");
                return;
            }
            
            const target = e.target;
            const actions = {
                // ... (Aksi Tombol lainnya sudah ada di setupDynamicOwnerControls)
            };
            const action = actions[target.id] || (target.classList.length > 0 && actions[target.classList[0]]);
            if (action) action();
        }
        
        // ðŸ”¥ MODIFIKASI: Hanya Master Owner yang bisa melihat/memproses Inbox
        function populateMessagesInbox() {
            const container = document.getElementById('message-inbox-container');
            if (!container || !currentUserData) return;
            
            // ðŸ”¥ Cek Master Owner
            const isMasterOwner = currentUserData.role === 'Owner' && currentUserData.username === MASTER_OWNER_USERNAME && currentUserData.password === MASTER_OWNER_PASSWORD;

            if (!isMasterOwner) {
                container.innerHTML = '<p style="color:#e74c3c;">Access Denied: Only Master Owner can view the Inbox.</p>';
                // Pastikan listener dimatikan jika bukan Master Owner
                db.ref('messageQueue').off('value'); 
                return;
            }

            db.ref('messageQueue').on('value', snapshot => {
                if (!container || !isMasterOwner) return; // Tambahan pengecekan di dalam listener
                container.innerHTML = '';
                if (!snapshot.exists()) { container.innerHTML = '<p>Inbox is empty.</p>'; return; }
                
                snapshot.forEach(child => {
                    const msg = child.val();
                    const msgKey = child.key;
                    const senderUid = msg.senderUid || '';
                    const item = document.createElement('div');
                    item.className = 'message-item';
                    
                    // Format Timestamp
                    let timestampText = '';
                    if (msg.timestamp) {
                        try {
                            const date = new Date(msg.timestamp);
                            timestampText = ` (${date.toLocaleDateString()} ${date.toLocaleTimeString()})`;
                        } catch(e) { /* Biarkan kosong jika error */ }
                    }
                    
                    item.innerHTML = `<p><b>From:</b> ${msg.senderUsername}${timestampText}</p><p><b>Message:</b> ${msg.payload}</p> <div class="message-actions"> <button class="accept-btn" data-key="${msgKey}" data-payload="${msg.payload}" data-sender-uid="${senderUid}">Reply (WA)</button> <button class="telegram-btn" data-key="${msgKey}" data-payload="${msg.payload}" data-sender-uid="${senderUid}">Reply (TG)</button> <button class="reject-btn" data-key="${msgKey}" data-payload="${msg.payload}" data-sender-uid="${senderUid}">Delete</button> </div>`;
                    container.appendChild(item);
                });
                
                const adminWaInput = document.getElementById('admin-wa-number');
                const adminTgInput = document.getElementById('admin-tg-id');
                if(adminWaInput) adminWaInput.value = currentUserData.adminReplyPrefs?.waNumber || '';
                if(adminTgInput) adminTgInput.value = currentUserData.adminReplyPrefs?.tgId || '';
             });
        }
        function pushNotificationToUser(targetUid, message, type) {
            if (!targetUid || !message || !type) return;
            db.ref('user_notifications/' + targetUid).push({ text: message, type: type, timestamp: new Date().toISOString() });
        }
        
        // ðŸ”¥ MODIFIKASI: Hanya Master Owner yang bisa memproses Inbox Action
        async function handleMessagesPageActions(e) {
            // ðŸ”¥ Cek Master Owner
            const isMasterOwner = currentUserData.role === 'Owner' && currentUserData.username === MASTER_OWNER_USERNAME && currentUserData.password === MASTER_OWNER_PASSWORD;
            
            if (!isMasterOwner) {
                showNotification("Access denied: Only Master Owner can process Inbox messages.", "error");
                return;
            }
            
            if (globalConfig.appStatus === 'OFF' && currentUserData.role !== 'Owner') {
                showNotification("Application is currently OFF.", "error");
                return;
            }
            const target = e.target;
            if(!target.dataset.key) return;
            const key = target.dataset.key;
            const payload = target.dataset.payload;
            const senderUid = target.dataset.senderUid;
            const payloadParts = payload ? payload.split(' ') : [];
            const targetNumber = payloadParts.length > 1 ? payloadParts[1] : '[unknown number]';
            let notificationMessage = '';
            let notificationType = '';
            if(target.classList.contains('accept-btn') || target.classList.contains('telegram-btn')){
                if (target.classList.contains('accept-btn')) {
                    const waNumInput = document.getElementById('admin-wa-number');
                    const waNum = waNumInput ? (waNumInput.value || globalConfig.adminWaNumberLogin) : globalConfig.adminWaNumberLogin;
                    if(!waNum) { showNotification('Please set your WA number first!', 'error'); return; }
                    if(waNumInput && waNumInput.value) {
                        try {
                            await db.ref(`users/${currentUserData.uid}/adminReplyPrefs/waNumber`).set(waNumInput.value);
                            if (!currentUserData.adminReplyPrefs) currentUserData.adminReplyPrefs = {};
                            currentUserData.adminReplyPrefs.waNumber = waNumInput.value; 
                        } catch (err) {
                            showNotification('Failed to save WA number.', 'error');
                        }
                    }
                    window.open(`https://wa.me/${waNum}?text=${encodeURIComponent(payload)}`, '_blank');
                } else { 
                     const tgIdInput = document.getElementById('admin-tg-id');
                     const tgId = tgIdInput ? tgIdInput.value : '';
                     if (!tgId) { showNotification('Please set your Telegram Username/ID first!', 'error'); return; }
                     if (tgIdInput && tgIdInput.value) {
                         try {
                            await db.ref(`users/${currentUserData.uid}/adminReplyPrefs/tgId`).set(tgIdInput.value);
                            if (!currentUserData.adminReplyPrefs) currentUserData.adminReplyPrefs = {};
                            currentUserData.adminReplyPrefs.tgId = tgIdInput.value; 
                         } catch (err) {
                            showNotification('Failed to save TG ID.', 'error');
                         }
                     }
                     const tgLink = tgId.startsWith('@') ? `https://t.me/${tgId.substring(1)}` : `tg://user?id=${tgId}`;
                     window.open(`${tgLink}?text=${encodeURIComponent(payload)}`, '_blank') || window.location.assign(`${tgLink}?text=${encodeURIComponent(payload)}`);
                }
                notificationMessage = `send to ${targetNumber} Succeed`;
                notificationType = 'success';
            } else if (target.classList.contains('reject-btn')) {
                notificationMessage = `Failed to send to ${targetNumber}`;
                notificationType = 'error';
            }
            if(senderUid && notificationMessage) { pushNotificationToUser(senderUid, notificationMessage, notificationType); }
            if (notificationMessage) { db.ref('messageQueue/' + key).remove(); }
        }
        function handleUserSearch(e) {
             const term = e.target.value.toLowerCase();
             const searchResults = document.getElementById('user-search-results');
             if (!searchResults) return;
             searchResults.innerHTML = '';
             if (!term || !allUsers || !currentUserData) return;
             Object.entries(allUsers).forEach(([uid, data]) => {
                 if (data && data.username && data.username.toLowerCase().includes(term) && uid !== currentUserData.uid) {
                     const item = document.createElement('div');
                     item.className = 'search-result-item';
                     item.textContent = data.username;
                     item.onclick = () => {
                          const modal = document.getElementById('user-search-modal'); if (modal) modal.classList.remove('active');
                          currentChatPartnerUid = uid;
                          showPage('chat-window-page', { partnerUid: uid, partnerUsername: data.username });
                     };
                     searchResults.appendChild(item);
                 }
             });
         }
        function populateChatList() {
            const conversationList = document.getElementById('conversation-list');
            if (!conversationList || !currentUserData) return;
            const chatsRef = db.ref('chats').orderByChild(`participants/${currentUserData.uid}`).equalTo(true);
            chatsRef.off('value');
            chatsRef.on('value', snapshot => {
                if (!conversationList) return;
                conversationList.innerHTML = '';
                if (!snapshot.exists()) { conversationList.innerHTML = '<p>No conversations yet.</p>'; return; }
                let conversations = [];
                snapshot.forEach(childSnapshot => {
                    const convo = childSnapshot.val();
                    const convoId = childSnapshot.key;
                    const partnerUid = Object.keys(convo.participants || {}).find(uid => uid !== currentUserData.uid);
                    if (partnerUid && allUsers && allUsers[partnerUid]) { conversations.push({ id: convoId, partnerUid: partnerUid, partnerUsername: allUsers[partnerUid].username, lastMessage: convo.lastMessage }); }
                });
                conversations.sort((a, b) => { const timeA = a.lastMessage?.timestamp ? new Date(a.lastMessage.timestamp).getTime() : 0; const timeB = b.lastMessage?.timestamp ? new Date(b.lastMessage.timestamp).getTime() : 0; return timeB - timeA; });
                conversations.forEach(convo => {
                    const lastMessageText = convo.lastMessage?.text || '';
                    const lastMessage = lastMessageText ? lastMessageText.substring(0, 30) + (lastMessageText.length > 30 ? '...' : '') : 'No messages yet.';
                    const item = document.createElement('div');
                    item.className = 'conversation-list-item';
                    item.dataset.uid = convo.partnerUid;
                    item.dataset.uname = convo.partnerUsername;
                    item.innerHTML = `<div class="conversation-info"><div class="username">${convo.partnerUsername}</div><div class="last-message">${lastMessage}</div></div>`;
                    conversationList.appendChild(item);
                });
            });
        }
        function handleConversationClick(e) {
            if (globalConfig.appStatus === 'OFF' && currentUserData.role !== 'Owner') {
                showNotification("Application is currently OFF.", "error");
                return;
            }
            const item = e.target.closest('.conversation-list-item');
            if (item && item.dataset.uid) {
                currentChatPartnerUid = item.dataset.uid;
                showPage('chat-window-page', { partnerUid: item.dataset.uid, partnerUsername: item.dataset.uname });
            }
        }
        function getConversationId(uid1, uid2) { return [uid1, uid2].sort().join('_'); }
        
        function renderChatWindowPage(context) {
             if (!context || !currentUserData) return;
             const { partnerUid, partnerUsername } = context;
             currentChatPartnerUid = partnerUid;
             const chatPartnerUsernameEl = document.getElementById('chat-partner-username');
             const messageForm = document.getElementById('message-form');
             if (chatPartnerUsernameEl) chatPartnerUsernameEl.textContent = partnerUsername;
             if (messageForm) messageForm.dataset.partnerUid = partnerUid;
             const messageContainer = document.getElementById('message-container');
             if (!messageContainer) return;
             messageContainer.innerHTML = '';
             const conversationId = getConversationId(currentUserData.uid, partnerUid);
             const messagesRef = db.ref(`chats/${conversationId}/messages`);
             if(chatsListener) chatsListener.off();
             
             chatsListener = messagesRef.limitToLast(50);
             chatsListener.on('child_added', snapshot => {
                 if (!messageContainer) return;
                 const msg = snapshot.val();
                 const msgKey = snapshot.key;
                 if (!msg || !msg.sender || !msg.text || !msg.timestamp) return;
                 const bubble = document.createElement('div');
                 bubble.className = `message-bubble ${msg.sender === currentUserData.uid ? 'sent' : 'received'}`;
                 bubble.dataset.msgKey = msgKey;
                 const textNode = document.createTextNode(msg.text);
                 const p = document.createElement('p');
                 p.appendChild(textNode);
                 bubble.appendChild(p);
                 bubble.innerHTML += `<span class="timestamp">${new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>`;
                 if (msg.sender === currentUserData.uid) { bubble.innerHTML += `<button class="delete-msg-btn" data-key="${msgKey}">Ã—</button>`; }
                 messageContainer.appendChild(bubble);
                 messageContainer.scrollTop = messageContainer.scrollHeight;
             });
             chatsListener.on('child_removed', snapshot => {
                 if (!messageContainer) return;
                 const removedKey = snapshot.key;
                 const bubbleToRemove = messageContainer.querySelector(`.message-bubble[data-msg-key="${removedKey}"]`);
                 if (bubbleToRemove) bubbleToRemove.remove();
             });
        }
        function handleSendMessage(e) {
            e.preventDefault();
            if (globalConfig.appStatus === 'OFF' && currentUserData.role !== 'Owner') {
                showNotification("Application is currently OFF.", "error");
                return;
            }
            const input = document.getElementById('message-input');
            const partnerUid = e.target.dataset.partnerUid;
            if (!input || !partnerUid || !currentUserData) return;
            const text = input.value.trim();
            if (!text) return;
            const conversationId = getConversationId(currentUserData.uid, partnerUid);
            const messagesRef = db.ref(`chats/${conversationId}/messages`);
            const newMessage = { sender: currentUserData.uid, text: text, timestamp: new Date().toISOString() };
            const newMessageRef = messagesRef.push();
            newMessageRef.set(newMessage);
            db.ref(`chats/${conversationId}/lastMessage`).set({ ...newMessage, key: newMessageRef.key });
            db.ref(`chats/${conversationId}/participants`).set({ [currentUserData.uid]: true, [partnerUid]: true });
            input.value = '';
         }
        function handleDeleteMessageClick(e) {
            if (e.target.classList.contains('delete-msg-btn')) {
                const messageKey = e.target.dataset.key;
                if (!messageKey || !currentChatPartnerUid || !currentUserData) return;
                const conversationId = getConversationId(currentUserData.uid, currentChatPartnerUid);
                showConfirm("Delete this message?", () => {
                    const messageRef = db.ref(`chats/${conversationId}/messages/${messageKey}`);
                    messageRef.remove()
                        .then(() => {
                           db.ref(`chats/${conversationId}/lastMessage/key`).get().then(lastKeySnapshot => {
                               if(lastKeySnapshot.exists() && lastKeySnapshot.val() === messageKey) {
                                   db.ref(`chats/${conversationId}/messages`).orderByKey().limitToLast(1).once('value', newLastMsgSnapshot => {
                                       if(newLastMsgSnapshot.exists()){
                                            const newLastMsgData = newLastMsgSnapshot.val();
                                            const newLastMsgKey = Object.keys(newLastMsgData)[0];
                                            db.ref(`chats/${conversationId}/lastMessage`).set({ ...newLastMsgData[newLastMsgKey], key: newLastMsgKey });
                                       } else {
                                            db.ref(`chats/${conversationId}/lastMessage`).remove();
                                       }
                                   });
                               }
                           });
                        })
                        .catch(error => { showNotification("Failed to delete message.", "error"); console.error("Error deleting message:", error); });
                });
            }
        }

        // --- START APP ---
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
